=========================
Build Notification System
=========================

IBinaryPackageBuild instance implements the 'notify' method which sends
a status report about the current record to the
ISourcePackageRelease.creator and the package uploader's preferred email
address.

We rely on get_contact_email_addresses() to DTRT, either use the
Team.contactaddress of the Launchpad Buildd Celebrity or the
preferredemail of its members.

The report is based on the emailtemplate/build-notification.txt.

All build states are supported by the current implementation, however
only failures should be reported this time.

  >>> from lp.soyuz.interfaces.binarypackagebuild import (
  ...     IBinaryPackageBuildSet)
  >>> from lp.testing.mail_helpers import pop_notifications
  >>> buildset = getUtility(IBinaryPackageBuildSet)

To avoid consequences of modified sampledata, specially if we add
more builds for test we are going to pick a specific build record
in a known state to perform the tests.

Notification for a FAILEDTOBUILD (failed) build record:

  >>> failed_candidate = buildset.getByBuildID(9)
  >>> failed_candidate.source_package_release.name
  u'pmount'
  >>> failed_candidate.status.name
  'FAILEDTOBUILD'
  >>> failed_candidate.source_package_release.creator.name
  u'mark'

  >>> failed_candidate.notify()

Check how many email the system have sent:

  >>> notifications = pop_notifications()
  >>> len(notifications)
  3

The members of launchpad-buildd-admins are notified:

  >>> notifications.pop(0)['To']
  'celso.providelo@canonical.com'

  >>> notifications.pop(0)['To']
  'foo.bar@canonical.com'

The maintainer is notified:

  >>> build_notification = notifications.pop(0)
  >>> build_notification['To']
  'mark@example.com'

Checking subject and extra headers. Build notifications have a set of
special headers to help filtering on users' mailboxes, they are:

 * X-Creator-Recipient: the creator email address which can be
   notified or not according a configuration parameter.
 * X-Launchpad-Build-{State, Component, Arch}: build record attributes
 * X-Launchpad-PPA: omitted if it's not a PPA build-notification,
   contains the PPA owner.name otherwise.

  >>> def dump_build_notification(notification):
  ...     clean_subject = notification['Subject'].replace(
  ...         '\n','').replace('\t', ' ')
  ...     build_state = notification['X-Launchpad-Build-State']
  ...     build_component = notification['X-Launchpad-Build-Component']
  ...     build_arch = notification['X-Launchpad-Build-Arch']
  ...     ppa_header = 'X-Launchpad-PPA' in notification.keys()
  ...     print 'Subject:', clean_subject
  ...     print 'X-Creator-Recipient:', notification['X-Creator-Recipient']
  ...     print 'X-Launchpad-Build-State:', build_state
  ...     print 'X-Launchpad-Build-Component:', build_component
  ...     print 'X-Launchpad-Build-Arch:', build_arch
  ...     if ppa_header:
  ...         print 'X-Launchpad-PPA:', notification['X-Launchpad-PPA']
  ...     else:
  ...         print 'X-Launchpad-PPA: omitted'

  >>> dump_build_notification(build_notification)
  Subject: [Build #9] i386 build of pmount 0.1-1 in ubuntu warty RELEASE
  X-Creator-Recipient: mark@example.com
  X-Launchpad-Build-State: FAILEDTOBUILD
  X-Launchpad-Build-Component: main
  X-Launchpad-Build-Arch: i386
  X-Launchpad-PPA: omitted

Let's check the notification content.  It should contain:

 * The source package name
 * The source package version
 * The build architecture
 * The build state
 * The duration of the build
 * A link to the build log
 * A link to the build page
 * A link to the source page

This same basic content applies to all types of notification.

  >>> notification_body = build_notification.get_payload(decode=True)
  >>> print notification_body #doctest: -NORMALIZE_WHITESPACE
  <BLANKLINE>
   * Source Package: pmount
   * Version: 0.1-1
   * Architecture: i386
   * Archive: ubuntu primary archive
   * Component: main
   * State: Failed to build
   * Duration: three minutes
   * Build Log: http://launchpad.dev/ubuntu/+source/pmount/0.1-1/+build/9/+files/netapplet-1.0.0.tar.gz
   * Builder: http://launchpad.dev/builders/bob
   * Source: http://launchpad.dev/ubuntu/+source/pmount/0.1-1
  <BLANKLINE>
  <BLANKLINE>
  <BLANKLINE>
  If you want further information about this situation, feel free to
  contact a member of the Launchpad Buildd Administrators team.
  <BLANKLINE>
  --
  i386 build of pmount 0.1-1 in ubuntu warty RELEASE
  http://launchpad.dev/ubuntu/+source/pmount/0.1-1/+build/9
  <BLANKLINE>

Notification for a pending (NEEDSBUILD) build record:

  >>> pending_candidate = buildset.getByBuildID(11)
  >>> pending_candidate.source_package_release.name
  u'alsa-utils'
  >>> pending_candidate.status.name
  'NEEDSBUILD'
  >>> pending_candidate.source_package_release.creator.name
  u'mark'

  >>> pending_candidate.notify()

Check how many email the system have sent:

  >>> notifications = pop_notifications()
  >>> len(notifications)
  3

The members of launchpad-buildd-admins are notified:

  >>> notifications.pop(0)['To']
  'celso.providelo@canonical.com'

  >>> notifications.pop(0)['To']
  'foo.bar@canonical.com'

The maintainer is notified:

  >>> build_notification = notifications.pop(0)
  >>> build_notification['To']
  'mark@example.com'

Checking subject and extra headers:

  >>> dump_build_notification(build_notification)
  Subject: [Build #11] i386 build of alsa-utils 1.0.9a-4ubuntu1 in ubuntu hoary RELEASE
  X-Creator-Recipient: mark@example.com
  X-Launchpad-Build-State: NEEDSBUILD
  X-Launchpad-Build-Component: main
  X-Launchpad-Build-Arch: i386
  X-Launchpad-PPA: omitted

Check the notification content:

  >>> notification_body = build_notification.get_payload()
  >>> print notification_body #doctest: -NORMALIZE_WHITESPACE
  <BLANKLINE>
   * Source Package: alsa-utils
   * Version: 1.0.9a-4ubuntu1
   * Architecture: i386
   * Archive: ubuntu primary archive
   * Component: main
   * State: Needs building
   * Duration: not available
   * Build Log: not available
   * Builder: not available
   * Source: http://launchpad.dev/ubuntu/+source/alsa-utils/1.0.9a-4ubuntu1
  <BLANKLINE>
  <BLANKLINE>
  <BLANKLINE>
  If you want further information about this situation, feel free to
  contact a member of the Launchpad Buildd Administrators team.
  <BLANKLINE>
  --
  i386 build of alsa-utils 1.0.9a-4ubuntu1 in ubuntu hoary RELEASE
  http://launchpad.dev/ubuntu/+source/alsa-utils/1.0.9a-4ubuntu1/+build/11
  <BLANKLINE>

Notification for a BUILDING build record:

  >>> building_candidate = buildset.getByBuildID(8)
  >>> building_candidate.source_package_release.name
  u'mozilla-firefox'
  >>> building_candidate.status.name
  'BUILDING'
  >>> building_candidate.source_package_release.creator.name
  u'mark'

  >>> building_candidate.notify()

Check how many email the system have sent:

  >>> notifications = pop_notifications()
  >>> len(notifications)
  3

The members of launchpad-buildd-admins are notified:

  >>> notifications.pop(0)['To']
  'celso.providelo@canonical.com'

  >>> notifications.pop(0)['To']
  'foo.bar@canonical.com'

The maintainer is notified:

  >>> build_notification = notifications.pop(0)
  >>> build_notification['To']
  'mark@example.com'

Checking subject and extra headers:

  >>> dump_build_notification(build_notification)
  Subject: [Build #8] i386 build of mozilla-firefox 0.9 in ubuntu hoary RELEASE
  X-Creator-Recipient: mark@example.com
  X-Launchpad-Build-State: BUILDING
  X-Launchpad-Build-Component: main
  X-Launchpad-Build-Arch: i386
  X-Launchpad-PPA: omitted

Check the notification content:

  >>> notification_body = build_notification.get_payload()
  >>> print notification_body #doctest: -NORMALIZE_WHITESPACE
  <BLANKLINE>
   * Source Package: mozilla-firefox
   * Version: 0.9
   * Architecture: i386
   * Archive: ubuntu primary archive
   * Component: main
   * State: Currently building
   * Duration: not finished
   * Build Log: see builder page
   * Builder: http://launchpad.dev/builders/bob
   * Source: http://launchpad.dev/ubuntu/+source/mozilla-firefox/0.9
  <BLANKLINE>
  <BLANKLINE>
  <BLANKLINE>
  If you want further information about this situation, feel free to
  contact a member of the Launchpad Buildd Administrators team.
  <BLANKLINE>
  --
  i386 build of mozilla-firefox 0.9 in ubuntu hoary RELEASE
  http://launchpad.dev/ubuntu/+source/mozilla-firefox/0.9/+build/8
  <BLANKLINE>

Notification for a SUPERSEDED build record:

  >>> superseded_candidate = buildset.getByBuildID(15)
  >>> superseded_candidate.source_package_release.name
  u'at'
  >>> superseded_candidate.status.name
  'SUPERSEDED'
  >>> superseded_candidate.source_package_release.creator.name
  u'mark'

  >>> superseded_candidate.notify()

Check how many email the system have sent:

  >>> notifications = pop_notifications()
  >>> len(notifications)
  3

The members of launchpad-buildd-admins are notified:

  >>> notifications.pop(0)['To']
  'celso.providelo@canonical.com'

  >>> notifications.pop(0)['To']
  'foo.bar@canonical.com'

The maintainer is notified:

  >>> build_notification = notifications.pop(0)
  >>> build_notification['To']
  'mark@example.com'

Checking subject and extra headers:

  >>> dump_build_notification(build_notification)
  Subject: [Build #15] i386 build of at 0.00 in ubuntu warty RELEASE
  X-Creator-Recipient: mark@example.com
  X-Launchpad-Build-State: SUPERSEDED
  X-Launchpad-Build-Component: main
  X-Launchpad-Build-Arch: i386
  X-Launchpad-PPA: omitted

Check the notification content:

  >>> notification_body = build_notification.get_payload()
  >>> print notification_body #doctest: -NORMALIZE_WHITESPACE
  <BLANKLINE>
   * Source Package: at
   * Version: 0.00
   * Architecture: i386
   * Archive: ubuntu primary archive
   * Component: main
   * State: Build for superseded Source
   * Duration: not available
   * Build Log: not available
   * Builder: not available
   * Source: http://launchpad.dev/ubuntu/+source/at/0.00
  <BLANKLINE>
  <BLANKLINE>
  <BLANKLINE>
  If you want further information about this situation, feel free to
  contact a member of the Launchpad Buildd Administrators team.
  <BLANKLINE>
  --
  i386 build of at 0.00 in ubuntu warty RELEASE
  http://launchpad.dev/ubuntu/+source/at/0.00/+build/15
  <BLANKLINE>

Check if the 'build_notification' configuration option really suppress
notification as promised:

  >>> from canonical.config import config
  >>> send_build_notification = """
  ...     [builddmaster]
  ...     send_build_notification: False
  ...     """
  >>> config.push('send_build_notification', send_build_notification)
  >>> superseeded_candidate = buildset.getByBuildID(15)
  >>> superseeded_candidate.notify()

  >>> notifications = pop_notifications()
  >>> len(notifications)
  0

  >>> config_data = config.pop('send_build_notification')

Check if 'notify_owner' config option really suppress email to
the SPR owner, but still sending it to the default recipient:

  >>> notify_owner = """
  ...     [builddmaster]
  ...     send_build_notification: True
  ...     notify_owner: False
  ...     """
  >>> config.push('notify_owner', notify_owner)
  >>> superseded_candidate = buildset.getByBuildID(15)

  >>> superseded_candidate.notify()

Check how many email the system have sent:

  >>> notifications = pop_notifications()
  >>> len(notifications)
  2

Only the members of launchpad-buildd-admins are notified:

  >>> notifications.pop(0)['To']
  'celso.providelo@canonical.com'

  >>> notifications.pop(0)['To']
  'foo.bar@canonical.com'

Checking subject and extra headers:

  >>> dump_build_notification(build_notification)
  Subject: [Build #15] i386 build of at 0.00 in ubuntu warty RELEASE
  X-Creator-Recipient: mark@example.com
  X-Launchpad-Build-State: SUPERSEDED
  X-Launchpad-Build-Component: main
  X-Launchpad-Build-Arch: i386
  X-Launchpad-PPA: omitted

Just to keep the config sane, as it was before:

  >>> config_data = config.pop('notify_owner')


PPA build notifications
=======================

As for the normal (main archive) build candidates we are also able
send notification about current (changed) PPA build record status.

PPA build notifications should be as much as possible similar to those
in the main archive, the important differences are:

 * We do not include 'buildd-admins' celebrity in its recipients,
   instead we include the Archive owner;

 * We try to be explicit in the subject and in the body of the message
   that it is about a PPA build candidate;

 * We don't have a 'source package' page for PPA sources.

 * We only warn the uploader (person specified in 'Changed-By'
   changesfile) and the signer (person who owns the GPG key used to
   sign the package) if the package was not copied.  Additionally,
   the Changed-By person is only notified if they are the PPA owner or
   they are in the team owning the PPA (to avoid spamming the innocent
   when PPA users upload unchanged source packages).

  >>> from lp.registry.interfaces.person import IPersonSet
  >>> cprov = getUtility(IPersonSet).getByName('cprov')

  >>> from lp.buildmaster.enums import BuildStatus
  >>> failed_candidate = cprov.archive.getBuildRecords(
  ...     build_state=BuildStatus.FAILEDTOBUILD, name='cdrkit')[0]

  >>> failed_candidate.notify()

Was this package copied?

    >>> (failed_candidate.archive !=
    ... failed_candidate.source_package_release.upload_archive)
    True

Since the package *was* copied, only the owner of the destination
archive will get notified.

  >>> notifications = pop_notifications()
  >>> len(notifications)
  1

Checking the message contents:

  >>> build_notification = notifications.pop(0)
  >>> notification_body = build_notification.get_payload(decode=True)
  >>> print notification_body #doctest: -NORMALIZE_WHITESPACE
  <BLANKLINE>
   * Source Package: cdrkit
   * Version: 1.0
   * Architecture: i386
   * Archive: cprov PPA
   * Component: main
   * State: Failed to build
   * Duration: a minute
   * Build Log: http://launchpad.dev/~cprov/+archive/ppa/+build/26/+files/netapplet-1.0.0.tar.gz
   * Builder: http://launchpad.dev/builders/bob
   * Source: not available
  ...

The notification went to the PPA owner.

  >>> build_notification['To']
  'celso.providelo@canonical.com'

Checking subject and extra headers:

  >>> dump_build_notification(build_notification)
  Subject: [Build #26] i386 build of cdrkit 1.0 in ubuntu breezy-autotest RELEASE (cprov PPA)
  X-Creator-Recipient: mark@example.com
  X-Launchpad-Build-State: FAILEDTOBUILD
  X-Launchpad-Build-Component: main
  X-Launchpad-Build-Arch: i386
  X-Launchpad-PPA: cprov

In order to test build notifications for sources that were not copied,
we will change the 'failed_candidate' source, setting its
'upload_archive' to the same archive was built, Celso's PPA.

  >>> from canonical.database.sqlbase import commit
  >>> from canonical.testing.layers import LaunchpadZopelessLayer

  >>> commit()
  >>> LaunchpadZopelessLayer.switchDbUser('launchpad')

  >>> from zope.security.proxy import removeSecurityProxy
  >>> naked_candidate = removeSecurityProxy(failed_candidate)
  >>> naked_sourcepackagerelease = naked_candidate.source_package_release
  >>> naked_sourcepackagerelease.upload_archive = failed_candidate.archive

We also make 'Foo Bar' the source signer.

  >>> from lp.registry.interfaces.gpg import IGPGKeySet
  >>> gpgkey = getUtility(IGPGKeySet).get(1)
  >>> print gpgkey.owner.name
  name16
  >>> naked_sourcepackagerelease.dscsigningkey = gpgkey

  >>> commit()
  >>> LaunchpadZopelessLayer.switchDbUser(test_dbuser)

Since 'mark' is the 'creator' it makes the failed-to-build source
look like a 'sponsored' upload.

  >>> print failed_candidate.source_package_release.creator.name
  mark

Finally we issue the notification.

  >>> failed_candidate.notify()

As expected for a 'not-copied and sponsored' PPA upload, only two
people involved with the source are notified.

 * 'cprov' who owns the PPA where the source is being built;
 * 'name16' who signed the source upload;

However, 'mark' who was listed as the creator of the source revision is
not notified because he is not in the PPA team or its owner.

  >>> notifications = pop_notifications()
  >>> len(notifications)
  2

  >>> for notification in notifications:
  ...     print notification['To']
  celso.providelo@canonical.com
  foo.bar@canonical.com

If the failed build candidate is for a PPA where mark is a member,
he will be notified.

  >>> commit()
  >>> LaunchpadZopelessLayer.switchDbUser('launchpad')
  >>> team = factory.makeTeam(owner=cprov, email="team@example.com")
  >>> mark = failed_candidate.source_package_release.creator
  >>> ignored = team.addMember(mark, mark)
  >>> discard = pop_notifications() # Discard team join email.
  >>> team_ppa = factory.makeArchive(owner=team)
  >>> naked_candidate = removeSecurityProxy(failed_candidate)
  >>> naked_candidate.archive = team_ppa
  >>> naked_candidate.source_package_release.upload_archive = team_ppa
  >>> commit()
  >>> LaunchpadZopelessLayer.switchDbUser(test_dbuser)

  >>> failed_candidate.notify()

This notification will be sent to the package uploader
(foo.bar@canonical.com), the package creator (mark@hdb.com) and the archive
team's contact address (team@example.com).

  >>> notifications = pop_notifications()
  >>> len(notifications)
  3

  >>> for notification in notifications:
  ...     print notification['To']
  foo.bar@canonical.com
  mark@example.com
  team@example.com


Named PPA notifications
=======================

Named PPA build notifications contain a specific reference to the PPA
in context. We will override the testing build to be in the context of
a just created named-ppa for Celso.

  >>> commit()
  >>> LaunchpadZopelessLayer.switchDbUser('launchpad')

  >>> from lp.soyuz.enums import ArchivePurpose
  >>> from lp.soyuz.interfaces.archive import IArchiveSet
  >>> named_ppa = getUtility(IArchiveSet).new(
  ...     owner=cprov, name='testing', purpose=ArchivePurpose.PPA)

  >>> naked_candidate = removeSecurityProxy(failed_candidate)
  >>> naked_candidate.archive = named_ppa

  >>> commit()
  >>> LaunchpadZopelessLayer.switchDbUser(test_dbuser)

As described before, copied sources result in one build notification
only, for the archive owner.

  >>> failed_candidate.notify()

  >>> notifications = pop_notifications()
  >>> for notification in notifications:
  ...     print notification['To']
  celso.providelo@canonical.com

The build-notification subject and headers correctly point
to the named-ppa, 'cprov-testing'.

  >>> build_notification = notifications.pop(0)
  >>> dump_build_notification(build_notification)
  Subject: [Build #26] i386 build of cdrkit 1.0 in ubuntu breezy-autotest RELEASE (cprov-testing PPA)
  X-Creator-Recipient: mark@example.com
  X-Launchpad-Build-State: FAILEDTOBUILD
  X-Launchpad-Build-Component: main
  X-Launchpad-Build-Arch: i386
  X-Launchpad-PPA: cprov-testing

The build notification body contains a reference to the named PPA, and
the correct links to it the build in files in its context.

  >>> notification_body = build_notification.get_payload(decode=True)
  >>> print notification_body #doctest: -NORMALIZE_WHITESPACE
  <BLANKLINE>
   * Source Package: cdrkit
   * Version: 1.0
   * Architecture: i386
   * Archive: cprov-testing PPA
   * Component: main
   * State: Failed to build
   * Duration: a minute
   * Build Log: http://launchpad.dev/~cprov/+archive/testing/+build/26/+files/netapplet-1.0.0.tar.gz
   * Builder: http://launchpad.dev/builders/bob
   * Source: not available
  <BLANKLINE>
  <BLANKLINE>
  <BLANKLINE>
  If you want further information about this situation, feel free to
  contact a member of the Launchpad Buildd Administrators team.
  <BLANKLINE>
  --
  i386 build of cdrkit 1.0 in ubuntu breezy-autotest RELEASE
  http://launchpad.dev/~cprov/+archive/testing/+build/26
  <BLANKLINE>
