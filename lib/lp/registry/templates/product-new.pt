<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  xml:lang="en"
  lang="en"
  dir="ltr"
  metal:use-macro="view/macro:page/onecolumn"
  i18n:domain="launchpad"
>
<body>
  <div metal:fill-slot="main">

  <script type="text/javascript">
/*
 * When step 2 of this wizard has search results, we want to hide the
 * details widgets until the user states that the project they are
 * registering is not a duplicate.
 */
YUI().use('node', 'lazr.effects', function(Y) {
    Y.on('domready', function() {
        var valid_urls = new RegExp('^[a-z0-9][-.+a-z0-9]*$', 'i');

        /* Handle key presses in the Name field for autofilling the URL
         * field.  By ensuring that field.name exists, we only do this when
         * we're on step 1 of the wizard.
         *
         * Note that we have to use the more verbose way of getting field.name
         * because Y.get() doesn't like the dots in the Zope field names.
         */
        var url_field = Y.get(Y.DOM.byId('field.name'));
        if (url_field) {
            var name_field = Y.get(Y.DOM.byId('field.displayname'));
            function autofill(e) {
                var name_value = name_field.get('value');
                /* If the displayname does not translate to a valid URL,
                 * refuse the temptation to guess.
                 */
                if (name_value == '' || name_value.search(valid_urls) >= 0) {
                    url_field.set('value', name_value);
                }
            }
            name_field.on('keyup', autofill);
            /* Prevent invalid characters from being input into the URL field.
             */
            url_field.on('keypress', function(e) {
                var code = e.charCode || e.keyCode;
                /* Ignore non-printable characters */
                if (code >= 32 && code < 127) {
                    var new_value = url_field.get('value') +
                                    String.fromCharCode(code);
                    if (new_value.search(valid_urls) < 0) {
                        e.preventDefault();
                    }
                }
            });
            /* Explicitly typing into the URL field disables autofilling. */
            url_field.on('keyup', function(e) {
                if (url_field.get('value') == '') {
                    /* The user cleared the URL field; turn on autofill. */
                    name_field.attach('keyup', autofill);
                }
                else {
                    /* Honor the user's URL; turn off autofill. */
                    name_field.detach('keyup', autofill);
                }
            });
        }

        /* Handle the reveals when there are search results. */
        var details_buttons = Y.get('#registration-details-buttons');
        var form_actions = Y.get('#launchpad-form-actions');
        var form_widgets = Y.get('#launchpad-form-widgets');
        var search_results = Y.get('#search-results');
        var step_title = Y.get('#step-title');
        var title = Y.get('#registration-details-title');

        /* This is the magic hidden widget used by the MultiStepView. */
        var marker = Y.get(Y.DOM.byId('field.__visited_steps__'));

        var separator = Y.get('#registration-separator');
        function show_separator(flag) {
            if (!separator) {
                /* The separator is not on the page, because there were no
                 * search results.
                 */
                return;
            }
            if (flag) {
                separator.removeClass('unseen');
            }
            else {
                separator.addClass('unseen');
            }
        }

        /* When the 'No' button is clicked, we swap in the registration
         * details for the search results.  It really doesn't look good
         * to leave the search results there.
         */
        function complete_registration(e) {
            var expander = Y.get('#search-results-expander');

            /* Slide in the search results and hide them under a link. */
            expander.removeClass('unseen');
            expander.on('click', function(e) {
                e.preventDefault();

                var arrow = Y.get('#search-results-arrow');
                if (arrow.getAttribute('src') == '/@@/treeCollapsed') {
                    /* The search results are currently hidden.  Slide them
                     * out and turn the arrow to point downward.
                     */
                    arrow.setAttribute('src', '/@@/treeExpanded');
                    arrow.setAttribute('title', 'Hide search results');
                    arrow.setAttribute('alt', 'Hide search results');
                    Y.lazr.effects.slide_out(search_results).run();
                    show_separator(true);
                }
                else {
                    /* The search results are currently displayed.  Slide them
                     * in and turn the arrow to point rightward.
                     */
                    arrow.setAttribute('src', '/@@/treeCollapsed');
                    arrow.setAttribute('title', 'Show search results');
                    arrow.setAttribute('alt', 'Show search results');
                    Y.lazr.effects.slide_in(search_results).run();
                    show_separator(false);
                }
            });

            /* Hide the 'No' button, but slide out the search results, so the
             * user has a clue that Something Is Happening.
             */
            details_buttons.addClass('unseen');

            /* Slide out the registration details widgets. */
            Y.lazr.effects.slide_out(form_widgets).run();

            /* Toggle the visibility of the various other widgets. */
            form_actions.removeClass('unseen');
            title.removeClass('unseen');

            /* Set the H2 title to something more appropriate for the
             * selected task.
             */
            step_title.set('innerHTML', 'Step 2 (of 2) Registration details');

            var reset_height = search_results.getComputedStyle('height');
            search_results.setStyle('height', reset_height);
            Y.lazr.effects.slide_in(search_results).run();

            /* Append a special marker to the hidden state widget.  See
             * ProjectAddStepTwo.search_results_count() for details.
             */
            var steps = marker.getAttribute('value');
            if (steps.search(new RegExp('hidesearch')) < 0) {
                marker.setAttribute('value', steps + "|hidesearch");
            }
        }

        /* The details button is only visible when JavaScript is enabled, but
         * the H3 separator is only visible when JavaScript is disabled.
         * Neither is displayed on the step 1 page.
         */
        show_separator(false);

        if (details_buttons) {
            details_buttons.removeClass('unseen');
            details_buttons.on('click', complete_registration);
        }

        /* If there are search results, hide the registration details. */
        if (search_results) {
            form_widgets.addClass('unseen');
            form_actions.addClass('unseen');
            title.addClass('unseen');
        }

        /* Finally, if we've been here before (e.g. there was an error in
         * submitting step 2), jump to continuing the registration.
         */
         if (marker.getAttribute('value').search(/hidesearch/) >= 0) {
            complete_registration(null);
         }
    })
});
  </script>

    <div style="font-size: larger; background: #e0f0d0;
        padding: 0.3em; -moz-border-radius: 5px; -o-border-radius: 5px;
       -webkit-border-radius: 5px; margin-bottom: 1em;">
      <strong>Requesting Ubuntu CDs</strong> is done at <a
      href="https://shipit.ubuntu.com/">shipit.ubuntu.com</a>
      <form style="display: inline; font-size: smaller"
            action="https://shipit.ubuntu.com/">
        <input type="submit" value="Oh, I want Ubuntu CDs" />
      </form>
    </div>

    <div metal:use-macro="context/@@launchpad_form/form">
      <metal:step fill-slot="extra_info">
      <div style="text-align: right;">Not sure what to do?
        <tal:comment condition="nothing">
          XXX BarryWarsaw 28-Apr-2009 bug 368910
          REMOVE THE FOLLOWING BEFORE 2.2.5 PRODUCTION ROLLOUT
        </tal:comment>
        <a href="mailto:feedback@launchpad.net">Contact us</a>
      </div>
      <h2 class="legend" id="step-title">Step
          <tal:step_number tal:replace="view/step_number"/>
          (of <tal:total_steps tal:replace="view/total_steps"/>):
          <tal:step_description tal:replace="view/step_description"/></h2>
      </metal:step>

      <metal:extra metal:fill-slot="extra_top">
        <a href="" id="search-results-expander" class="js-action unseen">
          <img id="search-results-arrow" src="/@@/treeCollapsed"
               title="Show search results" alt="Show search results"/>
          Possible duplicate projects
        </a>

        <div tal:condition="view/search_results_count"
             id="search-results">
          <div style="font-size: larger; margin-bottom: 1em; max-width: 60em;">
          <img src="/@@/info" />
          There are similar projects already registered in Launchpad.
          Is project
          <strong><tal:displayname tal:replace="view/request/displayname" />
          (<tal:name  tal:replace="view/request/name" />)</strong>
          one of these?
          </div>

          <table tal:define="results view/search_results">
            <tbody>
              <tr tal:repeat="pillar_name results"
                  tal:replace="structure pillar_name/@@+listing-simple">
              </tr>
            </tbody>
          </table>
          <div id="registration-details-buttons" class="unseen">
            <input type="button"
                   value="No, this is a new project"/>
            or <a tal:attributes="href view/cancel_url">Cancel</a>
          </div>
        </div>

        <div id="registration-details-title"
             style="font-size: larger; max-width: 60em;"
             tal:condition="python: view.step_number == 2">
          <h3 id="registration-separator"
              style="margin-top: 3em;"
              tal:condition="view/search_results_count"
              >Registration details</h3>
          Select the licenses for project
          <strong><tal:displayname tal:replace="view/request/displayname" />
          (<tal:name  tal:replace="view/request/name" />)</strong>
          and complete the registration.  You may also update the project's
          title and summary.
        </div>
      </metal:extra>
    </div>

  </div>
</body>
</html>
