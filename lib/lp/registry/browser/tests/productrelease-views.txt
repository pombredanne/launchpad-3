= ProductRelease pages =

Views that support the ProductRelease object.


== Adding a product release ==

A new ProductRelease can be created using ProductReleaseAddView.

    >>> owner = factory.makePerson(name='app-owner')
    >>> product = factory.makeProduct(name='app', owner=owner)
    >>> series = factory.makeSeries(name='simple', product=product)
    >>> milestone = series.newMilestone('0.1')
    >>> print milestone.active
    True

The view explains what that the user is creating a release, and lists the
other releases for the series. There are no other releases yet.

    >>> login_person(owner)
    >>> view = create_initialized_view(milestone, '+addrelease')
    >>> print view.label
    Create a new release for App

The view creates a checkbox to allow the user to keep the milestone active,
which is normally deactivated when a release is made.

    >>> print view.widgets['keep_milestone_active'].hint
    Only select this if bugs or blueprints still need to be targeted to this
    project release's milestone.

Submitting the form data creates the release and deactivates the milestone.

    >>> form = {
    ...     'field.datereleased': '2007-05-11',
    ...     'field.release_notes': 'Initial release.',
    ...     'field.changelog': 'commits',
    ...     'field.actions.create': 'Create release',
    ...     'field.keep_milestone_active.used': '', # false
    ...     }
    >>> view = create_initialized_view(milestone, '+addrelease', form=form)
    >>> print view.errors
    []
    >>> print view.widget_errors
    {}
    >>> for notification in view.request.response.notifications:
    ...     print notification.message
    The <a href="http://launchpad.dev/app/+milestone/0.1">0.1 milestone</a>
    for this project release was deactivated so that bugs and blueprints
    cannot be associated with this release.
    >>> print milestone.active
    False
    >>> for release in series.releases:
    ...     print release.version, release.release_notes, release.datereleased
    0.1 Initial release. 2007-05-11 00:00:00+00:00
    >>> transaction.commit()

Only one release can be created for the milestone.

    >>> view = create_initialized_view(milestone, '+addrelease', form=form)
    >>> for notice in view.request.response.notifications:
    ...     print notice.message
    A project release already exists for this milestone.

The milestone can be kept active when a release is created by submitting the
keep_milestone_active option as 'on' (the value of the checkbox).

    >>> active_milestone = series.newMilestone('0.2')
    >>> print active_milestone.active
    True

    >>> form = {
    ...     'field.datereleased': '2007-05-11',
    ...     'field.release_notes': 'Initial release.',
    ...     'field.changelog': 'commits',
    ...     'field.actions.create': 'Create release',
    ...     'field.keep_milestone_active': 'on',
    ...     }
    >>> view = create_initialized_view(
    ...     active_milestone, '+addrelease', form=form)
    >>> print view.errors
    []
    >>> print view.widget_errors
    {}
    >>> view.request.response.notifications
    []
    >>> print active_milestone.active
    True


== Creating a release for a series ==

It is possible to create a release directly from a series, the release's
milestone can be created via an AJAX command.

The view collects the the required release fields, and adds fields to
to set the milestone.

    >>> view = create_initialized_view(series, '+addrelease', principal=owner)
    >>> view.field_names
    ['datereleased', 'release_notes', 'changelog']
    >>> [field.__name__ for field in view.form_fields]
    ['milestone_for_release', 'keep_milestone_active', 'datereleased',
     'release_notes', 'changelog']

The rendered template includes a script that adds a js-action link to
show a formoverlay that updates the milestone_for_release field.

    >>> from canonical.launchpad.testing.pages import find_tag_by_id

    >>> script = find_tag_by_id(view.render(), 'milestone-script')
    >>> print script
    <script id="milestone-script" type="text/javascript">
        YUI().use(... 'lazr.formoverlay'...
            var milestone_form_uri = '.../app/simple/+addmilestone/++form++';
            var series_uri = '/app/simple';
            ...
            Y.on('domready', function () {
                var select_menu = get_by_id('field.milestone_for_release');
                var create_milestone_link = Y.Node.create(
                    '<a href="+addmilestone"
                      id="create-milestone-link">Create milestone</a>'); ...


== Editing a a product release ==

A ProductRelease can be edited using the ProductReleaseEditView.

    >>> release = series.getRelease('0.1')
    >>> print release.release_notes
    Initial release.

    >>> form = {
    ...     'field.datereleased': '2007-05-11',
    ...     'field.release_notes': 'revised',
    ...     'field.changelog': 'commits',
    ...     'field.actions.change': 'Change',
    ...     }
    >>> view = create_initialized_view(release, '+edit', form=form)
    >>> print view.errors
    []
    >>> print view.widget_errors
    {}
    >>> print release.release_notes
    revised
