= DistroSeries view classes =

    >>> from zope.component import getMultiAdapter
    >>> from canonical.launchpad.webapp.servers import LaunchpadTestRequest

Let's use ubuntu/hoary for these tests.

    >>> from canonical.launchpad.interfaces import IDistributionSet
    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> hoary = ubuntu.getSeries('hoary')

We will use a function to print the details related with the
distroseries being tested.

    >>> def administrate_distroseries(distroseries, form):
    ...     request = LaunchpadTestRequest(form=form)
    ...     request.method = 'POST'
    ...     view = getMultiAdapter((hoary, request), name="+admin")
    ...     view.initialize()
    ...     print '%d errors' % len(view.errors)
    ...     for error in view.errors:
    ...         try:
    ...             name, title, message = error
    ...         except ValueError:
    ...             title, message = error
    ...         print '%s: %s' % (title, message)
    ...     print 'Name:', distroseries.name
    ...     print 'Version:', distroseries.version
    ...     print 'Changeslist:', distroseries.changeslist
    ...     print 'Status:', distroseries.status.name

    >>> form = {
    ...     'field.actions.change': 'Change',
    ...     'field.name': 'hoary',
    ...     'field.version': '5.04',
    ...     'field.changeslist': 'hoary-changes@ubuntu.com',
    ...     'field.status': 'DEVELOPMENT',
    ...     }

    >>> login('foo.bar@canonical.com')

    >>> administrate_distroseries(hoary, form)
    0 errors
    Name: hoary
    Version: 5.04
    Changeslist: hoary-changes@ubuntu.com
    Status: DEVELOPMENT

The distroseries 'changeslist' field only accept valid email addresses.

    >>> form['field.changeslist'] = ''
    >>> administrate_distroseries(hoary, form)
    1 errors
    E-mail changes to:
    Name: hoary
    Version: 5.04
    Changeslist: hoary-changes@ubuntu.com
    Status: DEVELOPMENT

    >>> form['field.changeslist'] = 'bRoKen_AdDreSs'
    >>> administrate_distroseries(hoary, form)
    1 errors
    E-mail changes to: Invalid email 'bRoKen_AdDreSs'.
    Name: hoary
    Version: 5.04
    Changeslist: hoary-changes@ubuntu.com
    Status: DEVELOPMENT

    >>> form['field.changeslist'] = 'foo@bar.com'
    >>> administrate_distroseries(hoary, form)
    0 errors
    Name: hoary
    Version: 5.04
    Changeslist: foo@bar.com
    Status: DEVELOPMENT

When the distroseries is released, i.e. when it goes from an unstable
status (FUTURE, EXPERIMENTAL, DEVELOPMENT, FROZEN) to CURRENT, its
'datereleased' field is set.

    >>> print hoary.datereleased
    None

    >>> form['field.status'] = 'CURRENT'
    >>> administrate_distroseries(hoary, form)
    0 errors
    Name: hoary
    Version: 5.04
    Changeslist: foo@bar.com
    Status: CURRENT

    >>> initial_datereleased = hoary.datereleased
    >>> initial_datereleased is not None
    True

Let's commit the current DB status, so errors can be triggered and
will not rollback the changes done until here.

    >>> import transaction
    >>> transaction.commit()

A stable distroseries cannot be made unstable again.

    >>> form['field.status'] = 'EXPERIMENTAL'
    >>> administrate_distroseries(hoary, form)
    1 errors
    Invalid value: token 'EXPERIMENTAL' not found in vocabulary
    Name: hoary
    Version: 5.04
    Changeslist: foo@bar.com
    Status: CURRENT

The 'datereleased' value is only set once, even if the distroseries is
modified to SUPPORTED or OBSOLETE and then set back to CURRENT its
initial value remains.

    >>> form['field.status'] = 'SUPPORTED'
    >>> administrate_distroseries(hoary, form)
    0 errors
    Name: hoary
    Version: 5.04
    Changeslist: foo@bar.com
    Status: SUPPORTED

    >>> hoary.datereleased == initial_datereleased
    True

    >>> form['field.status'] = 'CURRENT'
    >>> administrate_distroseries(hoary, form)
    0 errors
    Name: hoary
    Version: 5.04
    Changeslist: foo@bar.com
    Status: CURRENT

    >>> hoary.datereleased == initial_datereleased
    True


Creating distroseries
---------------------

A distroseries is created using the distroseries view.

    >>> view = create_view(ubuntu, '+addseries')
    >>> print view.page_title
    Register a series in Ubuntu
    >>> print view.label
    Register a new series

    >>> print view.cancel_url
    http://launchpad.dev/ubuntu
    >>> print view.next_url
    None

    >>> view.field_names
    ['name', 'displayname', 'title', 'summary', 'description', 'version',
     'parent_series']

A distroseries is created whent the required field are submitted.

    >>> form = {
    ...     'field.name': 'sane',
    ...     'field.displayname': 'Sane Name',
    ...     'field.title': 'Ubuntu Sane Name',
    ...     'field.summary': 'A stable series to introduce fnord.',
    ...     'field.description': 'I am board filling this out',
    ...     'field.version': '2009.06',
    ...     'field.parent_series': 'ubuntu/hoary',
    ...     'field.actions.create': 'Create Series',
    ...     }
    >>> view = create_initialized_view(ubuntu, '+addseries', form=form)
    >>> view.errors
    []
    >>> sane_distroseries = ubuntu.getSeries('sane')
    >>> print sane_distroseries.name
    sane

    # Save this series to test name and version constraints.
    >>> transaction.commit()

Distroseries name
-----------------

The distroseries name is unique.

    >>> form['field.name'] = 'sane'
    >>> form['field.version'] = '2009.07'
    >>> view = create_initialized_view(ubuntu, '+addseries', form=form)
    >>> for error in view.errors:
    ...     print error[2]
    sane is already in use by another series.

The distroseries name cannot contain spaces.

    >>> form['field.name'] = 'insane name'
    >>> view = create_initialized_view(ubuntu, '+addseries', form=form)
    >>> for error in view.errors:
    ...     print error[2]
    Invalid name 'insane name'...


Distroseries version
--------------------

Versions cannot contain spaces.

    >>> form['field.name'] = '6-06-series'
    >>> form['field.version'] = '6.06 LTS'
    >>> view = create_initialized_view(ubuntu, '+addseries', form=form)
    >>> for error in view.errors:
    ...     print error[2]
    6.06 LTS is not a valid version

The distroseries version must be a valid debversion.

    >>> form['field.version'] = 'Hardy-6.06-LTS'
    >>> view = create_initialized_view(ubuntu, '+addseries', form=form)
    >>> for error in view.errors:
    ...     print error[2]
    'Hardy-6.06-LTS': Bad upstream version format

The distroseries version is unique to a distribution. Version '2009.06'
cannot be reused by another Ubuntu series.

    >>> print sane_distroseries.version
    2009.06

    >>> form['field.name'] = 'experimental'
    >>> form['field.version'] = '2009.06'
    >>> view = create_initialized_view(ubuntu, '+addseries', form=form)
    >>> for error in view.errors:
    ...     print error[2]
    2009.06 is already in use by another version in this distribution.

But version '2009.06' can be used by another distribution.

    >>> other_distro = factory.makeDistribution(name='other-distro')
    >>> view = create_initialized_view(other_distro, '+addseries', form=form)
    >>> view.errors
    []

    >>> experimental_distroseries = other_distro.getSeries('experimental')
    >>> print experimental_distroseries.version
    2009.06
