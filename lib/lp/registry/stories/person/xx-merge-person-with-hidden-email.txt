= Merging people with hidden email addresses =

In order to merge FooBarDupe into FooBar we need to send an email to
FooBarDupe's email address with instructions for FooBar to complete the
merge. The merge should succeed even if FooBarDupe has chosen to hide his
email addresses.

    # First we'll create profiles for FooBar and FooBarDupe, the latter with
    # hidden email addresses.
    >>> login(ANONYMOUS)
    >>> foobar = factory.makePerson(
    ...     email='foobar@baz.com', name='foobar', password='test')
    >>> foobar_dupe = factory.makePerson(name='foobar-dupe')
    >>> login_person(foobar_dupe)
    >>> foobar_dupe.hide_email_addresses = True
    >>> logout()

FooBar will now request that FooBarDupe be merged into his account.

    >>> browser = setupBrowser(auth="Basic foobar@baz.com:test")
    >>> browser.open('http://launchpad.dev/people/+requestmerge')
    >>> browser.getControl('Duplicated Account').value = 'foobar-dupe'
    >>> browser.getControl('Continue').click()
    >>> browser.url
    'http://launchpad.dev/people/+mergerequest-sent?dupe=...
    >>> print extract_text(find_main_content(browser.contents))
    An email message was sent to...
    Please follow the instructions on that message to complete the merge.

Following the link included in the email sent to FooBarDupe's email he'll
be able to complete the merge.

    >>> from lp.services.mail import stub
    >>> from canonical.launchpad.ftests.logintoken import (
    ...     get_token_url_from_email)
    >>> len(stub.test_emails)
    1
    >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
    >>> token_url = get_token_url_from_email(raw_msg)
    >>> browser.open(token_url)
    >>> browser.url
    'http://launchpad.dev/token/.../+accountmerge'
    >>> browser.getControl('Confirm').click()
    >>> print "\n".join(get_feedback_messages(browser.contents))
    The accounts have been merged successfully...
