<tal:root
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  omit-tag="">

  <metal:form-picker define-macro="form-picker">
    <tal:input replace="structure view/inputField" />

    <tal:search_results condition="not: view/hasValidInput"
      define="suggestion_id string:${view/name}-suggestions">
      <select tal:condition="view/matches"
        tal:attributes="id string:${suggestion_id}">
        <option value="">Did you mean...</option>
        <option
            tal:repeat="match view/matches"
            tal:attributes="value match/token;
                selected python:path('match/token') == path('view/formToken');"
            tal:content="string:${match/title} (${match/token})"
            />
      </select>
      <script type="text/javascript" tal:content="string:
          LPS.use('node', 'lp.app.picker', function(Y) {
              var text_input = Y.DOM.byId('${view/name}');
              var select_menu = Y.DOM.byId('${suggestion_id}');
              Y.lp.app.picker.connect_select_menu(
                  select_menu, text_input);
          });">
      </script>
    </tal:search_results>

    <tal:chooseLink replace="structure view/chooseLink" />
    <script tal:content="structure string:
    LPS.use('node', 'lp.app.picker', function(Y) {
        if (Y.UA.ie) {
            return;
        }

        var picker = null;
        var config = ${view/json_config};
        var vocabulary = config.vocabulary_name;
        var vocabulary_filters = config.vocabulary_filters;
        var input_element = config.input_element;
        var show_widget_id = '${view/show_widget_id}';
        var namespace = Y.namespace('lp.app.picker.connect');
        namespace[show_widget_id] = function() {
            // Sort out the Choose... link.
            var show_widget_node = Y.one('#'+show_widget_id);

            show_widget_node.set('innerHTML', 'Choose&hellip;');
            show_widget_node.addClass('js-action');
            show_widget_node.get('parentNode').removeClass('unseen');
            show_widget_node.on('click', function (e) {
                if (picker === null) {
                    picker = Y.lp.app.picker.create(
                        vocabulary, config, input_element,
                        vocabulary_filters);
                }
                picker.show();
                e.preventDefault();
            });
        };
        Y.on('domready', function(e) {
            namespace[show_widget_id]();
        });
    });
    "/>
  </metal:form-picker>
</tal:root>
