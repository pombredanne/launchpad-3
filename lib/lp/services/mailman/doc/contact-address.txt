= Using a mailing list as a team's contact address =

The contact address for any team can be set to the team's mailing list, in
which case all notifications sent by Launchpad to the team will be sent to the
mailing list's address.

Create a mailing list for the contact address of our new team.

    >>> from lp.services.mailman.testing import helpers
    >>> list_one = helpers.create_list('itest-one')

    # Ignore the new list notification message.
    >>> smtpd.reset()

Anne subscribes to the team and its mailing list.

    >>> helpers.subscribe('Anne', 'itest-one')

The team is set as the project's answer contact.

    >>> from canonical.launchpad.testing.pages import strip_label

    >>> browser = Browser('no-priv@canonical.com:test')
    >>> browser.open('http://launchpad.dev:8085/~itest-one/+contactaddress')
    >>> browser.getControl('The Launchpad mailing list').selected = True
    >>> browser.getControl('Change').click()

    >>> browser.getLink('Change details').click()
    >>> browser.getLink('Change contact address').click()
    >>> control = browser.getControl(name='field.contact_method')
    >>> [strip_label(label) for label in control.displayValue]
    ['The Launchpad mailing list for this team...]

    >>> browser.open(
    ...     'http://answers.launchpad.dev:8085/firefox/+answer-contact')
    >>> browser.getControl(name='field.answer_contact_teams').displayValue = [
    ...     'Itest One']
    >>> browser.getControl('Continue').click()

Now that the contact address for the team is its mailing list, a new questions
will be delivered to the mailing list.

    >>> browser.open('http://answers.launchpad.dev:8085/firefox/+addquestion')
    >>> browser.getControl('Summary').value = 'A new question'
    >>> browser.getControl('Continue').click()
    >>> browser.getControl('Description').value = 'More detail.'
    >>> browser.getControl('Add').click()

There are now three messages in the mailbox.  One message goes to
no-priv@canonical.com because he added the question, one goes to the mailing
list's archive, and one goes to Anne because she is the mailing list's only
member.

    # The three messages addressed to the mailing list seen on the smtp server
    # are 1) the original posted message on the +addquestion, 2) the message
    # as sent to Anne, 3) the message as sent to the archiver.
    >>> smtpd_watcher.wait_for_list_traffic('itest-one')
    >>> smtpd_watcher.wait_for_list_traffic('itest-one', personal=True)
    >>> smtpd_watcher.wait_for_list_traffic('itest-one', personal=True)

    >>> messages = smtpd.getMessages()
    >>> len(messages)
    3

Here is the message to the person who added the question.

    >>> print messages[0].as_string()
    Content-Type: text/plain; charset="utf-8"
    ...
    X-Launchpad-Question: product=firefox; status=Open; assignee=None;
      priority=Normal; language=en
    Reply-To: question...@answers.launchpad.net
    X-Launchpad-Message-Rationale: Subscriber
    To: no-priv@canonical.com
    From: No Privileges Person <question...@answers.launchpad.net>
    Subject: [Question #...]: A new question
    ...
    Sender: bounces@canonical.com
    Errors-To: bounces@canonical.com
    Return-Path: bounces@canonical.com
    Precedence: bulk
    ...
    X-Launchpad-Hash: ...
    Received: by smtp2mbox
    <BLANKLINE>
    New question #... on Mozilla Firefox:
    http://answers.launchpad.dev:8085/firefox/+question/...
    <BLANKLINE>
    More detail.
    <BLANKLINE>
    -- =
    <BLANKLINE>
    You received this question notification because you are a direct
    subscriber of the question.
    <BLANKLINE>
    <BLANKLINE>

Here is the message to Anne, the mailing list member.

    >>> print messages[1].as_string()
    MIME-Version: 1.0
    X-Launchpad-Question: product=firefox; status=Open; assignee=None;
      priority=Normal; language=en
    X-Launchpad-Message-Rationale: Answer Contact (firefox) @itest-one
    To: itest-one@lists.launchpad.dev
    From: No Privileges Person <question...@answers.launchpad.net>
    ...
    Subject: [Itest-one] [Question #...]: A new question
    X-BeenThere: itest-one@lists.launchpad.dev
    X-Mailman-Version: ...
    Reply-To: question...@answers.launchpad.net
    List-Id: <itest-one.lists.launchpad.dev>
    List-Help: <http://help.launchpad.dev/ListHelp>
    List-Subscribe: <http://launchpad.dev/~itest-one>
    List-Unsubscribe: <http://launchpad.dev/~itest-one>
    List-Post: <mailto:itest-one@lists.launchpad.dev>
    List-Archive: <http://lists.launchpad.dev/itest-one>
    List-Owner: <http://launchpad.dev/~itest-one>
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    Sender: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Errors-To: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Received: by smtp2mbox
    <BLANKLINE>
    New question #... on Mozilla Firefox:
    http://answers.launchpad.dev:8085/firefox/+question/...
    <BLANKLINE>
    More detail.
    <BLANKLINE>
    --
    You received this question notification because you are a member of
    Itest One, which is an answer contact for Mozilla Firefox.
    _______________________________________________
    Mailing list: http://launchpad.dev/~itest-one
    Post to     : itest-one@lists.launchpad.dev
    Unsubscribe : http://launchpad.dev/~itest-one
    More help   : http://help.launchpad.dev/ListHelp
    <BLANKLINE>
    <BLANKLINE>

Here is the message to the archive submission address.

    # This is mostly the same as the message to Anne, so we'll be succinct.
    >>> print messages[2].as_string()
    MIME-Version: 1.0
    ...
    Sender: itest-one-bounces+archive=mail-archive.dev@lists.launchpad.dev
    Errors-To: itest-one-bounces+archive=mail-archive.dev@lists.launchpad.dev
    ...
    <BLANKLINE>
    <BLANKLINE>

Similarly, when the team is subscribed to a blueprint, a notification will be
sent to Anne and to the archive, via the mailing list.

    >>> browser.open(
    ...     'http://launchpad.dev:8085/firefox/+spec/canvas/+addsubscriber')
    >>> browser.getControl('Subscriber').value = 'itest-one'
    >>> browser.getControl('Continue').click()

Launchpad sends a message to the team's contact address.  This message is
delivered directly to Mailman and is not available for viewing in the smtp
server.

    >>> smtpd_watcher.wait_for_list_traffic('itest-one')

Mailman then delivers two messages to the team mailing list's recipients.
One is sent to Anne and the other is sent to the archiver.

    >>> smtpd_watcher.wait_for_list_traffic('itest-one', personal=True)
    >>> smtpd_watcher.wait_for_list_traffic('itest-one', personal=True)
    >>> messages = smtpd.getMessages()
    >>> len(messages)
    2
    >>> from operator import itemgetter
    >>> messages.sort(key=itemgetter('sender'))

This one gets sent to Anne...

    >>> print messages[0].as_string()
    MIME-Version: 1.0
    To: itest-one@lists.launchpad.dev
    From: No Privileges Person <no-priv@canonical.com>
    ...
    Subject: [Itest-one] [Blueprint canvas] Support <canvas> Objects
    X-BeenThere: itest-one@lists.launchpad.dev
    ...
    Sender: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Errors-To: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Received: by smtp2mbox
    <BLANKLINE>
    You are now subscribed to the blueprint canvas - Support <canvas>
    Objects.
    <BLANKLINE>
    --
      http://blueprints.launchpad.dev:8085/firefox/+spec/canvas
    _______________________________________________
    Mailing list: http://launchpad.dev/~itest-one
    Post to     : itest-one@lists.launchpad.dev
    Unsubscribe : http://launchpad.dev/~itest-one
    More help   : http://help.launchpad.dev/ListHelp
    <BLANKLINE>
    <BLANKLINE>

...and this one gets sent to the archives.

    >>> print messages[1].as_string()
    MIME-Version: 1.0
    To: itest-one@lists.launchpad.dev
    From: No Privileges Person <no-priv@canonical.com>
    ...
    Subject: [Itest-one] [Blueprint canvas] Support <canvas> Objects
    X-BeenThere: itest-one@lists.launchpad.dev
    ...
    Sender: itest-one-bounces+archive=mail-archive.dev@lists.launchpad.dev
    Errors-To: itest-one-bounces+archive=mail-archive.dev@lists.launchpad.dev
    Received: by smtp2mbox
    <BLANKLINE>
    You are now subscribed to the blueprint canvas - Support <canvas>
    Objects.
    <BLANKLINE>
    --
      http://blueprints.launchpad.dev:8085/firefox/+spec/canvas
    _______________________________________________
    Mailing list: http://launchpad.dev/~itest-one
    Post to     : itest-one@lists.launchpad.dev
    Unsubscribe : http://launchpad.dev/~itest-one
    More help   : http://help.launchpad.dev/ListHelp
    <BLANKLINE>
    <BLANKLINE>

The team's contact address is set to each team member individually.
Notifications will no longer be sent to the mailing list.

    >>> browser.open('http://launchpad.dev:8085/~itest-one/+contactaddress')
    >>> browser.getControl('Each member individually').selected = True
    >>> browser.getControl('Change').click()

    >>> browser.getLink('Change details').click()
    >>> browser.getLink('Change contact address').click()
    >>> control = browser.getControl(name='field.contact_method')
    >>> [strip_label(label) for label in control.displayValue]
    ['Each member individually']

    >>> browser.open('http://answers.launchpad.dev:8085/firefox/+addquestion')
    >>> browser.getControl('Summary').value = 'Another question'
    >>> browser.getControl('Continue').click()
    >>> browser.getControl('Description').value = 'More detail.'
    >>> browser.getControl('Add').click()

    >>> smtpd_watcher.expecting_timeout = True
    >>> smtpd_watcher.wait_for_list_traffic('itest-one')
    'Timed out'

There are two messages in the mailbox.  One message was sent to
no-priv@canonical.com because he added the question.  The other goes to Anne
as a member of the team, since the team's contact address is not set.  Nothing
is sent to the archive because the mailing list was not used.

    >>> messages = smtpd.getMessages()
    >>> len(messages)
    2

    # Because this doesn't go through the mailing list, the Sender header will
    # be the same for both, so sort on the To field instead.
    >>> messages.sort(key=itemgetter('to'), reverse=True)

This message goes to the submitter of the question.

    >>> print messages[0].as_string()
    Content-Type: text/plain; charset="utf-8"
    ...
    To: no-priv@canonical.com
    From: No Privileges Person <question...@answers.launchpad.net>
    Subject: [Question #...]: Another question
    ...
    <BLANKLINE>
    New question #... on Mozilla Firefox:
    http://answers.launchpad.dev:8085/firefox/+question/...
    <BLANKLINE>
    More detail.
    <BLANKLINE>
    -- =
    <BLANKLINE>
    You received this question notification because you are a direct
    subscriber of the question.
    <BLANKLINE>
    <BLANKLINE>

This message goes to the team members individually, and Anne is the only team
member.

    >>> print messages[1].as_string()
    Content-Type: text/plain; charset="utf-8"
    ...
    Reply-To: question...@answers.launchpad.net
    X-Launchpad-Message-Rationale: Answer Contact (firefox) @itest-one
    To: anne.person@example.com
    From: No Privileges Person <question...@answers.launchpad.net>
    Subject: [Question #...]: Another question
    ...
    <BLANKLINE>
    New question #... on Mozilla Firefox:
    http://answers.launchpad.dev:8085/firefox/+question/...
    <BLANKLINE>
    More detail.
    <BLANKLINE>
    -- =
    <BLANKLINE>
    You received this question notification because you are a member of
    Itest One, which is an answer contact for Mozilla Firefox.
    <BLANKLINE>
    <BLANKLINE>

When emails are sent directly to the mailing list address they're still
delivered since the mailing list is still active.

    >>> from Mailman.Post import inject
    >>> inject('itest-one', """\
    ... From: anne.person@example.com
    ... To: itest-one@lists.launchpad.dev
    ... Subject: A member post
    ... Message-ID: <first-injection>
    ...
    ... Hi, I am a member of Launchpad.
    ... """)
    >>> smtpd_watcher.wait_for_mbox_delivery('first-injection')
    >>> smtpd_watcher.wait_for_mbox_delivery('first-injection')
    >>> messages = smtpd.getMessages()

Anne (as the only member of the mailing list) and the archive submission
address both get copies of the message.

    >>> len(messages)
    2
    >>> messages.sort(key=itemgetter('sender'))

    >>> print messages[0].as_string()
    From: anne.person@example.com
    To: itest-one@lists.launchpad.dev
    Message-ID: <first-injection>
    Subject: [Itest-one] A member post
    X-BeenThere: itest-one@lists.launchpad.dev
    ...
    Sender: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Errors-To: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Received: by smtp2mbox
    <BLANKLINE>
    Hi, I am a member of Launchpad.
    _______________________________________________
    Mailing list: http://launchpad.dev/~itest-one
    Post to     : itest-one@lists.launchpad.dev
    Unsubscribe : http://launchpad.dev/~itest-one
    More help   : http://help.launchpad.dev/ListHelp
    <BLANKLINE>
    <BLANKLINE>

    >>> print messages[1].as_string()
    From: anne.person@example.com
    To: itest-one@lists.launchpad.dev
    Message-ID: <first-injection>
    Subject: [Itest-one] A member post
    X-BeenThere: itest-one@lists.launchpad.dev
    ...
    Sender: itest-one-bounces+archive=mail-archive.dev@lists.launchpad.dev
    Errors-To: itest-one-bounces+archive=mail-archive.dev@lists.launchpad.dev
    Received: by smtp2mbox
    <BLANKLINE>
    Hi, I am a member of Launchpad.
    _______________________________________________
    Mailing list: http://launchpad.dev/~itest-one
    Post to     : itest-one@lists.launchpad.dev
    Unsubscribe : http://launchpad.dev/~itest-one
    More help   : http://help.launchpad.dev/ListHelp
    <BLANKLINE>
    <BLANKLINE>
