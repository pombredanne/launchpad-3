Custom Language Codes
---------------------

Some projects insist on using nonstandard language codes, such as es_ES
for standard Spanish or pt-BR instead of pt_BR.  Custom language codes
are a feature that helps deal with this during translation import.  A
custom language code maps a language code as the project (or package)
uses it to a language, regardless of whether the code is for an existing
language or not.

Custom language codes are attached to either a product or a source
package.

    >>> from zope.component import getUtility
    >>> from zope.security.proxy import removeSecurityProxy
    >>> from canonical.launchpad.interfaces.launchpad import (
    ...     ILaunchpadCelebrities)
    >>> from lp.app.enums import ServiceUsage

    >>> def find_custom_language_codes_link(browser):
    ...     """Find reference to custom language codes on a page."""
    ...     return find_tag_by_id(browser.contents, 'custom-language-codes')

    >>> login(ANONYMOUS)
    >>> owner = factory.makePerson(email='o@example.com', password='test')
    >>> rosetta_admin = factory.makePerson(
    ...     email='r@example.com', password='test')
    >>> removeSecurityProxy(rosetta_admin).join(
    ...     getUtility(ILaunchpadCelebrities).rosetta_experts)
    >>> product = factory.makeProduct(displayname="Foo", owner=owner)
    >>> trunk = product.getSeries('trunk')
    >>> naked_product = removeSecurityProxy(product)
    >>> naked_product.translations_usage = ServiceUsage.LAUNCHPAD
    >>> template = factory.makePOTemplate(productseries=trunk)
    >>> product_page = canonical_url(product, rootsite='translations')
    >>> logout()

    >>> owner_browser = setupBrowser("Basic o@example.com:test")
    >>> rosetta_admin_browser = setupRosettaExpertBrowser()

A Launchpad administrator or Rosetta expert sees the link to the custom
language codes on a project's main translations page.

    >>> admin_browser.open(product_page)
    >>> tag = find_custom_language_codes_link(admin_browser)
    >>> print extract_text(tag.renderContents())
    If necessary, you may
    define custom language codes
    for this project.

    >>> rosetta_admin_browser.open(product_page)
    >>> tag = find_custom_language_codes_link(rosetta_admin_browser)
    >>> print extract_text(tag.renderContents())
    If necessary, you may
    define custom language codes
    for this project.

The link goes to the custom language codes management page.

    >>> rosetta_admin_browser.getLink("define custom language codes").click()
    >>> custom_language_codes_page = rosetta_admin_browser.url

Non-admins, even the project's owner, don't see this link.  We do not
advertise this feature, since the proper solution is generally to use
the right language codes.

    >>> owner_browser.open(product_page)
    >>> print find_custom_language_codes_link(owner_browser)
    None

Initially the page shows no custom language codes for the project.

    >>> tag = find_tag_by_id(rosetta_admin_browser.contents, 'empty')
    >>> print extract_text(tag.renderContents())
    No custom language codes have been defined.

The admin can add a custom language code.

    >>> rosetta_admin_browser.getLink("Add a custom language code").click()
    >>> add_page = rosetta_admin_browser.url

    >>> rosetta_admin_browser.getControl("Language code:").value = 'no'
    >>> rosetta_admin_browser.getControl("Language:").value = ['nn']
    >>> rosetta_admin_browser.getControl("Add").click()

This leads back to the custom language codes overview, where the new
code is now shown.

    >>> rosetta_admin_browser.url == custom_language_codes_page
    True

    >>> tag = find_tag_by_id(rosetta_admin_browser.contents, 'nonempty')
    >>> print extract_text(tag.renderContents())
    Foo uses the following custom language codes:
    Code...     ...maps to language
    no          Norwegian Nynorsk

There is an overview page for the custom code, though there's not much
to see there.

    >>> rosetta_admin_browser.getLink("no").click()
    >>> main = find_main_content(rosetta_admin_browser.contents)
    >>> print extract_text(main.renderContents())
    Foo Translations Custom language code ...no...
    For Foo, uploads with the language code
    &ldquo;no&rdquo;
    are associated with the language
    Norwegian Nynorsk.
    remove custom language code
    custom language codes overview

The overview page leads back to the custom language codes overview.

    >>> code_page = rosetta_admin_browser.url
    >>> rosetta_admin_browser.getLink(
    ...     "custom language codes overview").click()
    >>> rosetta_admin_browser.url == custom_language_codes_page
    True

    >>> rosetta_admin_browser.open(code_page)

There is also a link for removing codes.  The admin follows the link and
removes the "no" custom language code.

    >>> rosetta_admin_browser.getLink("remove custom language code").click()
    >>> remove_page = rosetta_admin_browser.url
    >>> rosetta_admin_browser.getControl("Remove").click()

This leads back to the overview page.

    >>> rosetta_admin_browser.url == custom_language_codes_page
    True

    >>> tag = find_tag_by_id(rosetta_admin_browser.contents, 'empty')
    >>> print extract_text(tag.renderContents())
    No custom language codes have been defined.


Non-admin access
================

A non-admin can see the page, actually, if they know the URL.  This can
be convenient for debugging.

    >>> owner_browser.open(custom_language_codes_page)

    >>> tag = find_tag_by_id(owner_browser.contents, 'empty')
    >>> print extract_text(tag.renderContents())
    No custom language codes have been defined.

However all they get is a read-only version of the page.

    >>> owner_browser.getLink("Add a custom language code").click()
    Traceback (most recent call last):
    ...
    LinkNotFoundError

The page for adding custom language codes is not accessible to them.

    >>> owner_browser.open(add_page)
    Traceback (most recent call last):
    ...
    Unauthorized: ...

And naturally, if an admin creates a custom language code again, a
non-admin can't remove it.

    >>> rosetta_admin_browser.open(add_page)
    >>> rosetta_admin_browser.getControl("Language code:").value = 'no'
    >>> rosetta_admin_browser.getControl("Language:").value = ['nn']
    >>> rosetta_admin_browser.getControl("Add").click()

    >>> owner_browser.open(custom_language_codes_page)
    >>> tag = find_tag_by_id(owner_browser.contents, 'nonempty')
    >>> print extract_text(tag.renderContents())
    Foo uses the following custom language codes:
    Code...     ...maps to language
    no          Norwegian Nynorsk

    >>> owner_browser.getLink("no").click()
    >>> owner_browser.getLink("remove custom language code")
    Traceback (most recent call last):
    ...
    LinkNotFoundError

    >>> owner_browser.open(remove_page)
    Traceback (most recent call last):
    ...
    Unauthorized: ...


Source packages
===============

The story for source packages is very similar to that for products.  In
this case, the custom language code is tied to the distribution source
package--i.e. the combination of a distribution and a source package
name.  However, since there is no Translations page for that type of
object (and we'd probably never go there if there were), the link is
shown on the source package page.

    >>> login(ANONYMOUS)
    >>> from lp.registry.model.sourcepackage import SourcePackage
    >>> from lp.registry.model.sourcepackagename import SourcePackageName

    >>> distro = factory.makeDistribution('distro')
    >>> distroseries = factory.makeDistroRelease(distribution=distro)
    >>> sourcepackagename = SourcePackageName(name='bar')
    >>> package = factory.makeSourcePackage(
    ...     sourcepackagename=sourcepackagename, distroseries=distroseries)
    >>> naked_distro = removeSecurityProxy(distro)
    >>> naked_distro.translations_usage = ServiceUsage.LAUNCHPAD
    >>> other_series = factory.makeDistroRelease(distribution=distro)
    >>> template = factory.makePOTemplate(
    ...     distroseries=package.distroseries,
    ...     sourcepackagename=package.sourcepackagename)
    >>> package_page = canonical_url(package, rootsite="translations")
    >>> page_in_other_series = canonical_url(SourcePackage(
    ...     distroseries=other_series,
    ...     sourcepackagename=package.sourcepackagename),
    ...     rootsite="translations")
    >>> logout()

    >>> rosetta_admin_browser.open(package_page)

Of course in this case, the notice about there being no custom language
codes talks about a package, not a project.

    >>> tag = find_custom_language_codes_link(rosetta_admin_browser)
    >>> print extract_text(tag.renderContents())
    If necessary, you may
    define custom language codes
    for this package.

    >>> rosetta_admin_browser.getLink("define custom language codes").click()
    >>> custom_language_codes_page = rosetta_admin_browser.url

    >>> tag = find_tag_by_id(rosetta_admin_browser.contents, 'empty')
    >>> print extract_text(tag.renderContents())
    No custom language codes have been defined.

Again, an admin can add a language code.

    >>> rosetta_admin_browser.getLink("Add a custom language code").click()
    >>> add_page = rosetta_admin_browser.url

    >>> rosetta_admin_browser.getControl("Language code:").value = 'pt-br'
    >>> rosetta_admin_browser.getControl("Language:").value = ['pt_BR']
    >>> rosetta_admin_browser.getControl("Add").click()

The language code is displayed.

    >>> tag = find_tag_by_id(rosetta_admin_browser.contents, 'nonempty')
    >>> print extract_text(tag.renderContents())
    bar in distro uses the following custom language codes:
    Code...     ...maps to language
    pt-br       Portuguese (Brazil)

It's also displayed identically on the same package but in another
release series of the same distribution.

    >>> rosetta_admin_browser.open(page_in_other_series)
    >>> tag = find_custom_language_codes_link(rosetta_admin_browser)
    >>> print extract_text(tag.renderContents())
    If necessary, you may
    define custom language codes
    for this package.

    >>> rosetta_admin_browser.getLink("define custom language codes").click()
    >>> tag = find_tag_by_id(rosetta_admin_browser.contents, 'nonempty')
    >>> print extract_text(tag.renderContents())
    bar in distro uses the following custom language codes:
    Code...     ...maps to language
    pt-br       Portuguese (Brazil)


The new code has a link there...

    >>> rosetta_admin_browser.getLink("pt-br").click()

...and can be deleted.

    >>> rosetta_admin_browser.getLink("remove custom language code").click()
    >>> rosetta_admin_browser.getControl("Remove").click()

    >>> tag = find_tag_by_id(rosetta_admin_browser.contents, 'empty')
    >>> print extract_text(tag.renderContents())
    No custom language codes have been defined.
