# Copyright 2009 Canonical Ltd.  This software is licensed under the
# GNU Affero General Public License version 3 (see the file LICENSE).

"""Test interactive error output display in the import queue UI."""

__metaclass__ = type
__all__ = []

# Generated by the windmill services transformer
from windmill.authoring import WindmillTestClient

from canonical.launchpad.windmill.testing import lpuser
from lp.translations.windmill.testing import TranslationsWindmillLayer
from lp.testing import TestCaseWithFactory


class ImportQueueErrorOutputTest(TestCaseWithFactory):
    """Test interactive error output display in the import queue UI."""

    layer = TranslationsWindmillLayer

    def _checkOutputPanel(self, client, panel_xpath):
        client.waits.forElement(xpath=panel_xpath, timeout=u'5000')
        # XXX JeroenVermeulen 2009-04-21 bug=365176: Check panel
        # contents here!

    def test_import_queue_error_output(self):
        """Run test.

        The test:
        * produces an environment with failed translation imports;
        * loads the translation import queue page;
        * tests that the error output can be revealed interactively;
        * tests that the error output can be hidden again.
        """
        client = WindmillTestClient("Translation imports error reporting")

        start_url = 'http://translations.launchpad.dev:8085/+imports'
        user = lpuser.TRANSLATIONS_ADMIN

        client.open(url=start_url)
        client.waits.forPageLoad(timeout=u'20000')
        user.ensure_login(client)

        placeholder = u"//div[@id='1']//div[@class='original show-output']"
        client.waits.forElement(xpath=placeholder, timeout=u'8000')
        client.click(xpath=placeholder)

        show_button = u"//div[@id='1']//div[@class='new show-output']"
        client.waits.forElement(xpath=show_button, timeout=u'8000')

        output_panel = (
            u"//div[@id='1']//tr[@class='discreet secondary output-panel]'")
        self._checkOutputPanel(client, output_panel)

        # Hide output panel.
        client.click(xpath=show_button)
        # XXX JeroenVermeulen 2009-04-21 bug=365176: waits.forElement() to
        # wait for the output panel to disappear.
        client.asserts.assertNotElement(xpath=output_panel)

        # Reveal output panel again.  This brings us back to the same
        # state as when it was first revealed.
        client.click(xpath=show_button)
        self._checkOutputPanel(client, output_panel)

