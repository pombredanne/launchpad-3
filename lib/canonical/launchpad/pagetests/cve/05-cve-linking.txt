= Bug Links =

CVE report can be linked to bugs. Users will do that when a bug exposes
the vulnerability in the report.

=  = Adding Links =

Let say that Launchpad Bug #5 records the vulnerability described in
CVE-2005-2737. A user that wants to document that relationship goes to
the CVE report and click the 'Link to Bug'.

This link is only available to registered user:

    >>> anon_browser.open('http://launchpad.dev/bugs/cve/2005-2737')
    >>> anon_browser.getLink(url='+linkbug').click()
    Traceback (most recent call last):
      ...
    Unauthorized: ...

    >>> user_browser.open('http://launchpad.dev/bugs/cve/2005-2737')
    >>> user_browser.getLink('Link to bug').click()

To link the bug, the user enters the bug ID and click the 'Link'
button.

    >>> user_browser.getControl('Bug ID').value = '5'
    >>> user_browser.getControl('Link').click()

The bug is now listed under the 'Related Bugs' heading:

    >>> soup = find_main_content(user_browser.contents)
    >>> header = soup.first('h2')
    >>> header.findNext('b')
    <b>Bug #5:...Firefox install instructions should be complete</b>

It is also possible to link a bug using its nickname. For example,
bug #2 has 'blackhole' as its nickname:

    >>> user_browser.getLink('Link to bug').click()
    >>> user_browser.getControl('Bug ID').value = 'blackholes'
    >>> user_browser.getControl('Link').click()

An error message is displayed when user enters a non-existent nickname:

    >>> for tag in find_tags_by_class(user_browser.contents, 'message'):
    ...     print tag.renderContents()
    There is 1 error.
    <BLANKLINE>
    Not a valid bug number or nickname.

The user can correct his error and submit the form again.

    >>> user_browser.getControl('Bug ID').value = 'blackhole'
    >>> user_browser.getControl('Link').click()

A notification is displayed telling the user which bug he just linked:

    >>> soup = find_main_content(user_browser.contents)
    >>> soup.first('div', 'informational message')
    <div class="informational message">Added link to bug #2:
    ...Blackhole Trash folder...</div>

The CVE page should not be used as a means to edit bugs and bug tasks.
Therefore there should be no bug task edit forms on the page. We test
this as an administrator since only an administrator would see such
forms. This also provides us with a means to test implicitly that bug
79637 has been fixed.

    >>> admin_browser.open('http://launchpad.dev/bugs/cve/1999-8979')
    >>> for form in find_main_content(
    ...     admin_browser.contents).findAll('form'):
    ...     print form.renderContents()


Similarly, there should be no links allowing the user to mark the bug as
affecting another product or distribution.

    >>> 'Also affects:' in admin_browser.contents
    False

=  = Removing Links =

To remove bug links, the user would use the 'Remove Bug Link' action.
He can select the bug reports, he wants to unlink from the CVE.

    >>> user_browser.getLink('Remove bug link').click()
    >>> user_browser.getControl('#2: Blackhole').selected = True
    >>> user_browser.getControl('#5: Firefox').selected = True
    >>> user_browser.getControl('Remove').click()

The bug was removed from the CVE report page:

    >>> soup = find_main_content(user_browser.contents)
    >>> sorted(soup('div', 'informational message'), key=lambda v: str(v))
    [<div class="informational message">Removed link to bug #2.</div>,
    <div class="informational message">Removed link to bug #5.</div>]

    >>> 'No related bugs.' in user_browser.contents
    True

=  = Linking Private Bugs ==

    (Let's mark bug #6 as private and only accessible by an
    administrator or its subscribers.
    # XXX flacoste 2006-08-22  bug=57307:
    # This should use a private bug in our sample data.
    >>> from zope.component import getUtility
    >>> from canonical.launchpad.ftests import login, logout
    >>> from canonical.launchpad.interfaces import IBugSet
    >>> from canonical.database.sqlbase import flush_database_updates
    >>> login('foo.bar@canonical.com')
    >>> private_bug = getUtility(IBugSet).get(6)
    >>> private_bug.private = 6
    >>> flush_database_updates()
    >>> logout()

It is possible for a user having access to the private to link the CVE to
that bug.

    >>> admin_browser.open('http://launchpad.dev/bugs/cve/2005-2737')
    >>> admin_browser.getLink('Link to bug').click()
    >>> admin_browser.getControl('Bug ID').value = '6'
    >>> admin_browser.getControl('Link').click()

The user will see that linked private bug:

    >>> soup = find_main_content(admin_browser.contents)
    >>> soup.first('div', 'bug')
    <div class="bug">
      <b>Bug #6: Firefox crashes when Save As dialog
        for a nonexistent window is closed</b>
    ...
    <table class="duplicate listing"...</div>

But anonymous users (or users which don't have access to the private
bug) will only see that a private bug is linked to the CVE:

    >>> anon_browser.open('http://launchpad.dev/bugs/cve/2005-2737')
    >>> soup = find_main_content(anon_browser.contents)
    >>> soup.first('div', 'bug')
    <div class="bug">
      <b>Bug #6: private bug</b>
    </div>


= Linking CVEs to Bugs =

Similarly, we should be able to unlink and re-link a CVE to a bug. Let's
look at Bug #1. We should see that it is linked to CVE 1999-8979.

  >>> print http(r"""
  ... GET /firefox/+bug/1 HTTP/1.1
  ... """)
  HTTP/1.1 200 Ok
  ...1999-8979...

Let's remove that link. First, make sure we can see the page.We'll use
Sample Person again.

  >>> print http(r"""
  ... GET /firefox/+bug/1/+unlinkcve HTTP/1.1
  ... Authorization: Basic dGVzdEBjYW5vbmljYWwuY29tOnRlc3Q=
  ... """)
  HTTP/1.1 200 Ok
  ...

And that we can POST to it.

  >>> print http(r"""
  ... POST /firefox/+bug/1/+unlinkcve HTTP/1.1
  ... Authorization: Basic dGVzdEBjYW5vbmljYWwuY29tOnRlc3Q=
  ... Content-Length: 317
  ... Content-Type: multipart/form-data; boundary=---------------------------192921188714487939411191642790
  ...
  ... -----------------------------192921188714487939411191642790
  ... Content-Disposition: form-data; name="field.sequence"
  ...
  ... 1999-8979
  ... -----------------------------192921188714487939411191642790
  ... Content-Disposition: form-data; name="FORM_SUBMIT"
  ...
  ... Continue
  ... -----------------------------192921188714487939411191642790--
  ... """)
  HTTP/1.1 303 See Other
  Content-Length: 0
  ...
  Location: http://.../firefox/+bug/1

And add it back. Make sure we can see the "Link CVE" page.

  >>> print http(r"""
  ... GET /firefox/+bug/1/+linkcve HTTP/1.1
  ... Authorization: Basic dGVzdEBjYW5vbmljYWwuY29tOnRlc3Q=
  ... """)
  HTTP/1.1 200 Ok
  ...

And check if the CVE validator is working.

  >>> print http(r"""
  ... POST /firefox/+bug/1/+linkcve HTTP/1.1
  ... Authorization: Basic dGVzdEBjYW5vbmljYWwuY29tOnRlc3Q=
  ... Content-Length: 314
  ... Content-Type: multipart/form-data; boundary=---------------------------10715549571845379851634356273
  ...
  ... -----------------------------10715549571845379851634356273
  ... Content-Disposition: form-data; name="field.sequence"
  ...
  ... invalid
  ... -----------------------------10715549571845379851634356273
  ... Content-Disposition: form-data; name="FORM_SUBMIT"
  ...
  ... Continue
  ... -----------------------------10715549571845379851634356273--
  ... """)
  HTTP/1.1 200 Ok
  ...
  ...Please fix the problems below and try again...
  ...invalid is not a valid CVE number...
  ...

And POST to it.

  >>> print http(r"""
  ... POST /firefox/+bug/1/+linkcve HTTP/1.1
  ... Authorization: Basic dGVzdEBjYW5vbmljYWwuY29tOnRlc3Q=
  ... Content-Length: 314
  ... Content-Type: multipart/form-data; boundary=---------------------------10715549571845379851634356273
  ...
  ... -----------------------------10715549571845379851634356273
  ... Content-Disposition: form-data; name="field.sequence"
  ...
  ... 1999-8979
  ... -----------------------------10715549571845379851634356273
  ... Content-Disposition: form-data; name="FORM_SUBMIT"
  ...
  ... Continue
  ... -----------------------------10715549571845379851634356273--
  ... """)
  HTTP/1.1 303 See Other
  Content-Length: 0
  ...
  Location: http://.../firefox/+bug/1


