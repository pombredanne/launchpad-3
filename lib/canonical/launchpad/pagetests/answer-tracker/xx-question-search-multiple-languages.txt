= Searching Questions in Multiple Languages =

By default, only questions written in English or one of the user
preferred languages are listed and searched.


== Anonymous searching ==

For example, a user who isn't logged in will only see questions
written in English, in one of the language configured in his browser,
or inferred from GeoIP information. In this example, only English
questions will be shown when the user has not provided language
information.

    >>> anon_browser.open('http://launchpad.dev/distros/ubuntu/+questions')
    >>> from BeautifulSoup import BeautifulSoup
    >>> soup = BeautifulSoup(anon_browser.contents)
    >>> for question in soup.fetch('td', 'question'):
    ...     print question.first('a').renderContents()
    Continue playing after shutdown
    Play DVDs in Totem
    mailto: problem in webpage
    Installation of Java Runtime Environment for Mozilla
    Slow system

    # Since we have more than 5 results, some of them are in the second batch.
    >>> anon_browser.getLink('Next').click()
    >>> soup = BeautifulSoup(anon_browser.contents)
    >>> for question in soup.fetch('td', 'question'):
    ...     print question.first('a').renderContents()
    Installation failed

The questions match the languages inferred from by GeoIP
(127.0.0.1 is mapped to South Africa in the test suite.) The language
control shows the intersection of the the user's languages and the
languages of the target's questions. In this example:
('af', 'en', 'st', 'xh', 'zu') & ('en', 'es') = (en)

    >>> sorted(anon_browser.getControl(name='field.languages').options)
    ['en']

If the user unselects all the language options, then all questions,
whatever the language they are written in are displayed. Doing so,
the anonymous user will see a Spanish question.

    >>> anon_browser.getControl('English (en)').selected = False
    >>> anon_browser.getControl('Search').click()
    >>> soup = BeautifulSoup(anon_browser.contents)
    >>> for question in soup.fetch('td', 'question'):
    ...     question.first('a').renderContents()
    'Problema al recompilar kernel con soporte smp (doble-n\xc3\xbacleo)'
    'Continue playing after shutdown'
    'Play DVDs in Totem'
    'mailto: problem in webpage'
    'Installation of Java Runtime Environment for Mozilla'

    # Since we have more than 5 results, some of them are in the second batch.
    >>> anon_browser.getLink('Next').click()
    >>> soup = BeautifulSoup(anon_browser.contents)
    >>> for question in soup.fetch('td', 'question'):
    ...     question.first('a').renderContents()
    'Slow system'
    'Installation failed'

When the project has no questions to search, we do not show the
language controls

    >>> anon_browser.open('http://launchpad.dev/kubuntu/+questions')
    >>> anon_browser.getControl(name='field.languages')
    Traceback (most recent call last):
      ...
    LookupError: name 'field.languages...

    >>> content = find_main_content(anon_browser.contents).first('p')
    >>> print content.renderContents()
    There are no questions for Kubuntu with the requested statuses.

When the project has questions in only one language, and that language
is among the users' languages, the language controls are not displayed.
Gnome Applets only has English questions. When the anonymous user
makes a request from a GeoIP that has no languages mapped, we assume
he speaks the default language of English.

    >>> anon_browser.addHeader('X_FORWARDED_FOR', '172.16.1.1')
    >>> anon_browser.open(
    ...     'http://launchpad.dev/ubuntu/+source/mozilla-firefox/+questions')
    >>> anon_browser.getControl(name='field.languages')
    Traceback (most recent call last):
      ...
    LookupError: name 'field.languages...

But if the user configures his browser to accept Spanish, then English
and Spanish language questions will be displayed:

    >>> anon_browser.addHeader('Accept-Language', 'es')
    >>> anon_browser.open('http://launchpad.dev/distros/ubuntu/+questions')
    >>> anon_browser.getControl('English (en)').selected
    True
    >>> anon_browser.getControl('Spanish (es)').selected
    True

    >>> soup = BeautifulSoup(anon_browser.contents)
    >>> for question in soup.fetch('td', 'question'):
    ...     question.first('a').renderContents()
    'Problema al recompilar kernel con soporte smp (doble-n\xc3\xbacleo)'
    'Continue playing after shutdown'
    'Play DVDs in Totem'
    'mailto: problem in webpage'
    'Installation of Java Runtime Environment for Mozilla'

    # Since we have more than 5 results, some of them are in the second batch.
    >>> anon_browser.getLink('Next').click()
    >>> soup = BeautifulSoup(anon_browser.contents)
    >>> for question in soup.fetch('td', 'question'):
    ...     question.first('a').renderContents()
    'Slow system'
    'Installation failed'


== Authenticated searching ==

Authenticated users without preferred languages are assumed to have
the languages determined by their GeoIP, and what their browser sends
in the Accept-Languages request, just as with anonymous users. In
this example, No Privileges Person does not have preferred languages,
nor is his browser configured with a language; we use GeoIP rules.
As with the anonymous user, the intersection of the GeoIP languages
and the target's question languages is 'en'.

    >>> user_browser.open('http://launchpad.dev/distros/ubuntu/+questions')
    >>> sorted(user_browser.getControl(name='field.languages').options)
    ['en']

When the GeoIP and project languages are just English, we do not
show the language controls.

    >>> user_browser.addHeader('X_FORWARDED_FOR', '172.16.1.1')
    >>> user_browser.open('http://launchpad.dev/applets/+questions')
    >>> user_browser.getControl(name='field.languages')
    Traceback (most recent call last):
      ...
    LookupError: name 'field.languages...

When No Privileges Person adds Spanish to his browser we see that
language and English added earlier listed among the language
controls.

    >>> user_browser.addHeader('Accept-Language', 'es')
    >>> user_browser.open('http://launchpad.dev/distros/ubuntu/+questions')
    >>> sorted(user_browser.getControl(name='field.languages').options)
    ['en', 'es']

Users that have configured their preferred languages may choose to
see questions for any, some, all, or none of their languages by
toggling the check box for each of their preferred languages. In
this example, Carlos speaks two languages (Spanish and Catalan),
and Answers adds English to the list of languages. There are no
Catalan questions, so the control does not offer that as a checkbox.

    >>> browser.addHeader('Authorization', 'Basic carlos@canonical.com:test')
    >>> browser.open('http://launchpad.dev/distros/ubuntu/+questions')
    >>> language_control = browser.getControl(name='field.languages')
    >>> for label in language_control.displayOptions:
    ...     # print the label without the leading non-breaking space.
    ...     label[1:]
    'English (en)'
    'Spanish (es)'
    >>> browser.getControl(name='field.languages').options
    ['en', 'es']

By unchecking a checkbox, Carlos can exclude English questions from
the search results.

    >>> browser.getControl('English (en)').selected = False
    >>> browser.getControl('Search').click()
    >>> content = find_main_content(browser.contents)
    >>> for question in content.fetch('td', 'question'):
    ...     question.first('a').renderContents()
    'Problema al recompilar kernel con soporte smp (doble-n\xc3\xbacleo)'


= Multiple Request Languages in Latest Questions =

The portlet that lists the latest questions involving a person displays
all the questions, whatever the user preferred languages. (Since this
portlet is there to give an idea of activity, it also advertise
multi-language activity. Besides this avoids misleading the user by
showing no questions when there could be in other languages.)

    >>> browser.open('http://launchpad.dev/~carlos')
    >>> portlet = find_portlet(
    ...    browser.contents, 'Latest questions')
    >>> for link in portlet.fetch('a'):
    ...    link.renderContents()
    'Problema al recompilar kernel con soporte smp (doble-n\xc3\xbacleo)'
