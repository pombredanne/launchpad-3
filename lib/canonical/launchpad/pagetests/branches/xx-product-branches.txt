= Product Branches Overview =

Branch listing pages now hide dormant branches by default.  Dormant
branches are branches that have not been updated or committed to for
some time.  Since this is a time based change all the branches
are reset here to be recently updated.

    >>> from canonical.launchpad.ftests.branch_helper import (
    ...     reset_all_branch_last_modified)
    >>> reset_all_branch_last_modified()


= Product branch summaries =

Branch listings for products now have a summary shown at the top of
the page before the listing table itself.

What is shown depends on the how many branches are in the project,
who they are owned by, whether or not the branch officially uses
Launchpad code, whether or not there is a development focus branch,
whether or not there are any download files specified for the product.


= No branches =

If there are no branches a message offering options is shown.

The default page for the code rootsite on a product is the code
overview page.

    >>> browser.open('http://code.launchpad.dev/applets')
    >>> print browser.title
    Bazaar branches of Gnome Applets

If there are not any branches, a helpful message is shown.

    >>> def get_summary(browser):
    ...     return find_tag_by_id(browser.contents, 'application-summary')
    >>> summary = get_summary(browser)
    >>> print extract_text(summary)
    There are no branches for Gnome Applets in Launchpad.
    If there are Bazaar branches of Gnome Applets in a publicly
      accessible location, Launchpad can act as a mirror of the branch
      by registering a Mirrored branch. Read more.
    Launchpad can also act as a primary location for Bazaar branches of
      Gnome Applets. Read more.
    Launchpad can import code from CVS or Subversion into Bazaar branches.
      Read more.

The 'Read more' links go to the help wiki.

    >>> for anchor in summary.fetch('a'):
    ...     print anchor['href']
    https://help.launchpad.net/CreatingAMirroredBranch
    https://help.launchpad.net/CreatingAHostedBranch
    https://help.launchpad.net/VcsImports


= Link to the product downloads =

It is possible that a new person coming to the code tab would be interested
in downloads that may have been added for the product.

    >>> browser.open('http://code.launchpad.dev/netapplet')
    >>> print extract_text(get_summary(browser))
    There are no branches for NetApplet in Launchpad.
    ...
    There are download files available for NetApplet.


= Development focus branches =

If the product has branches, but no branch has been set as the current
development focus, then if the user is able to set the development focus
branch, they are shown an option.

    >>> sample_browser = setupBrowser(auth="Basic test@canonical.com:test")
    >>> sample_browser.open('http://code.launchpad.dev/gnome-terminal')
    >>> print extract_text(get_summary(sample_browser))
    10 branches ... commits in the last month
    A branch has not yet been specified as the primary development focus
    for GNOME Terminal (set).

This text is not shown if the user cannot set the branch.

    >>> browser.open('http://code.launchpad.dev/gnome-terminal')
    >>> print extract_text(get_summary(browser))
    10 branches ... commits in the last month

If a development focus branch is set, the user is shown with a link to
browse the code, and shown a simple command line to get the branch.

    >>> browser.open('http://code.launchpad.dev/evolution')
    >>> summary = get_summary(browser)
    >>> print extract_text(get_summary(browser))
    3 branches ...
    You can browse the source code for development focus branch,
    or get a copy of the branch using the command:
       bzr branch lp:evolution

    >>> print summary.a['href']
    http://bazaar.launchpad.dev/~vcs-imports/evolution/main


== Initial branch listing ==

The initial branch listing has the following branches in order:
 * The current development focus branch
 * Other series branches (as long as not Merged or Abandoned)
 * Other non-series branches ordered by most recently modified

If a branch is associated with more than one series, it is only shown
once, but both series are shown in the listing.

    >>> admin_browser.open('http://launchpad.dev/firefox/trunk/+linkbranch')
    >>> admin_browser.getControl('Branch').value = '~name12/firefox/main'
    >>> admin_browser.getControl('Update').click()
    >>> admin_browser.open('http://launchpad.dev/firefox/1.0/+linkbranch')
    >>> admin_browser.getControl('Branch').value = '~name12/firefox/main'
    >>> admin_browser.getControl('Update').click()

    >>> browser.open('http://code.launchpad.dev/firefox')
    >>> table = find_tag_by_id(browser.contents, 'branchtable')
    >>> for row in table.tbody.fetch('tr')[0:2]:
    ...     print extract_text(row)
    ~name12/firefox/main
      Series: trunk, 1.0            New ...
    ~sabdfl/firefox/release--0.9.1  New ...

Firstly lets associate release--0.9.1 with the 1.0 series.

    >>> admin_browser.open('http://launchpad.dev/firefox/1.0/+linkbranch')
    >>> admin_browser.getControl('Branch').value = '~sabdfl/firefox/release--0.9.1'
    >>> admin_browser.getControl('Update').click()

    >>> browser.open('http://code.launchpad.dev/firefox')
    >>> table = find_tag_by_id(browser.contents, 'branchtable')
    >>> for row in table.tbody.fetch('tr')[0:2]:
    ...     print extract_text(row)
    ~name12/firefox/main
      Series: trunk                 New ...
    ~sabdfl/firefox/release--0.9.1
      Series: 1.0                   New ...

Now if both of these branches are marked as Abandoned, then the first will
stay as it is the development focus branch, but the 1.0 series branch will not
be shown.

    >>> admin_browser.open(
    ...     'http://code.launchpad.dev/~name12/firefox/main/+edit')
    >>> admin_browser.getControl('Abandoned').click()
    >>> admin_browser.getControl('Change Branch').click()
    >>> admin_browser.open(
    ...     'http://code.launchpad.dev/~sabdfl/firefox/release--0.9.1/+edit')
    >>> admin_browser.getControl('Abandoned').click()
    >>> admin_browser.getControl('Change Branch').click()

    >>> browser.open('http://code.launchpad.dev/firefox')
    >>> table = find_tag_by_id(browser.contents, 'branchtable')
    >>> for row in table.tbody.fetch('tr')[0:2]:
    ...     print extract_text(row)
    ~name12/firefox/main
      Series: trunk                 Abandoned ...
    ~sabdfl/firefox/release-0.8     New ...


== Floating buttons ==

There are two buttons that show on the right hand side of the screen
for project branch listings.  'Register a branch' and 'Import your project'.

    >>> def print_buttons(browser):
    ...     buttons = find_tag_by_id(browser.contents, 'floating-buttons')
    ...     for button_image in buttons.fetch('img'):
    ...         print button_image['alt']
    >>> print_buttons(browser)
    Register a branch
    Import your project

If the product specifies that it officially uses Launchpad code, then
the 'Import your project' button is not shown.

    >>> sample_browser.open('http://launchpad.dev/gnome-terminal')
    >>> sample_browser.getLink('Change details').click()
    >>> sample_browser.getControl(
    ...     'Code for this project is published in Bazaar branches '
    ...     'on Launchpad').click()
    >>> sample_browser.getControl('Change').click()

    >>> browser.open('http://code.launchpad.dev/gnome-terminal')
    >>> print_buttons(browser)
    Register a branch


== Nice wording of summary numbers ==

The text that is shown giving a summary of the number of branches
shows correct singular and plural forms.

    >>> def print_summary(product):
    ...     browser.open('http://code.launchpad.dev/%s' % product)
    ...     print extract_text(get_summary(browser))

    >>> print_summary('gnome-terminal')
    10 branches owned by 1 person and 2 teams, 0 commits in the last month
    >>> print_summary('firefox')
    5 branches owned by 2 people, 0 commits in the last month
    ...
    >>> print_summary('evolution')
    3 branches owned by 1 person and 1 team, 0 commits in the last month
    ...
    >>> print_summary('iso-codes')
    1 branch owned by 1 person, 0 commits in the last month

# XXX: thumper 2008-04-24
# There is no easy way to change the database user in the pagetests
# in order to add revisions to the branches to show commits by users.


== Product has Branches, but none initially visible ==

It is a bit of an edge case, but if there are branches for a product but all
of them are either merged or abandoned and there is no development focus
branch, then they will not appear on the initial branch listing.

    >>> admin_browser.open('http://code.launchpad.dev/~carlos/iso-codes/0.35')
    >>> admin_browser.getLink('Change branch details').click()
    >>> admin_browser.getControl('Abandoned').click()
    >>> admin_browser.getControl('Change Branch').click()

    >>> browser.open('http://code.launchpad.dev/iso-codes')
    >>> print extract_text(get_summary(browser))
    1 branch owned by 1 person, 0 commits in the last month

    >>> message = find_tag_by_id(browser.contents, 'no-branch-message')
    >>> print extract_text(message)
    There are branches registered for iso-codes but none of them match the
    current filter criteria for this page. Try filtering on "Any Status".


== Getting to the branch listing for a product ==

If there are branches, but they do not fit with the appropriate filter
we are given a different message.

    >>> browser.open(
    ...     'http://code.launchpad.dev/firefox/+branches'
    ...     '?field.lifecycle=Mature')
    >>> message = find_tag_by_id(browser.contents, 'no-branch-message')
    >>> print extract_text(message)
    There are branches registered for Mozilla Firefox but none of them match
    the current filter criteria for this page. Try filtering on "Any Status".
