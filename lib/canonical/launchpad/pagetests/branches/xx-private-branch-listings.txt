= Private Branch Listings =

All pages that show branch listings to users should only show branches
that the user is allowed to see.

The main places branch listings occur are the code tabs for people and
products, but there are also portlets to show branches on blueprint
pages (for associated branches), the product overview pages (for
recently created branches), the code homepage (for recently updated,
created and imported branches), and on the bug details page for
bug-branch links.


== The code home page ==

The code home page shows lists of recently imported, changed, and
registered branches.

    >>> def print_recently_registered_branches(browser):
    ...     browser.open('http://code.launchpad.dev')
    ...     branches = find_tag_by_id(browser.contents, 'recently-registered')
    ...     for list_item in branches.ul.fetch('li'):
    ...         print "%r" % list_item.renderContents()

When there is no logged in user, only public branches should be visible.

    >>> print_recently_registered_branches(anon_browser)
    '...~sabdfl/+junk/testdoc...'
    '...~name12/gnome-terminal/scanned...'
    '...~name12/gnome-terminal/mirrored...'
    '...~name12/gnome-terminal/pushed...'
    '...Launchpad support for Gnome Terminal...'

Logged in users should only be able to see public branches, and private
branches that they are subscribed to.

    >>> from zope.testbrowser.testing import Browser
    >>> no_priv_browser = Browser()
    >>> no_priv_browser.addHeader(
    ...     'Authorization', 'Basic no-priv@canonical.com:test')

    >>> print_recently_registered_branches(no_priv_browser)
    '...~sabdfl/+junk/testdoc...'
    '...~name12/gnome-terminal/scanned...'
    '...~name12/gnome-terminal/mirrored...'
    '...~name12/gnome-terminal/pushed...'
    '...Launchpad support for Gnome Terminal...'

The private branches in the sample data belong to Landscape, and are
subscribed to by Landscape developers.  Sample Person is a Landscape
developer.

    >>> landscape_dev_browser = Browser()
    >>> landscape_dev_browser.addHeader(
    ...     'Authorization', 'Basic test@canonical.com:test')

    >>> print_recently_registered_branches(landscape_dev_browser)
    '...~name12/landscape/feature-x...<img src="/@@/locked"...'
    '...Landscape trunk...<img src="/@@/locked"...'
    '...~sabdfl/+junk/testdoc...'
    '...~name12/gnome-terminal/scanned...'
    '...~name12/gnome-terminal/mirrored...'

Launchpad administrators are able to see all private branches.

    >>> print_recently_registered_branches(admin_browser)
    '...~name12/landscape/feature-x...<img src="/@@/locked"...'
    '...Landscape trunk...<img src="/@@/locked"...'
    '...~sabdfl/+junk/testdoc...'
    '...~name12/gnome-terminal/scanned...'
    '...~name12/gnome-terminal/mirrored...'


== Product overview pages ==

On the product overview page there is a portlet to show recently registered
branches.

    >>> def print_landscape_overview_branches(browser):
    ...     browser.open('http://launchpad.dev/landscape')
    ...     branches = find_portlet(browser.contents, 'Latest code')
    ...     if branches is None:
    ...         print 'Latest code portlet not shown'
    ...     else:
    ...         for list_item in branches.fetch('li'):
    ...             print "%r" % list_item.renderContents()

    >>> print_landscape_overview_branches(anon_browser)
    Latest code portlet not shown

    >>> print_landscape_overview_branches(no_priv_browser)
    Latest code portlet not shown

    >>> print_landscape_overview_branches(landscape_dev_browser)
    '.../landscape/feature-x...<img src="/@@/locked"...'
    '.../landscape/trunk...<img src="/@@/locked"...'

    >>> print_landscape_overview_branches(admin_browser)
    '.../landscape/feature-x...<img src="/@@/locked"...'
    '.../landscape/trunk...<img src="/@@/locked"...'


== Landscape code listing page ==

One of the most obvious places to hide private branches are the code
listing tab.

    >>> def print_landscape_code_listing(browser):
    ...     browser.open('http://code.launchpad.dev/landscape')
    ...     table = find_tag_by_id(browser.contents, 'branchtable')
    ...     for row in table.tbody.fetch('tr'):
    ...         print extract_text(row)

    >>> print_landscape_code_listing(anon_browser)
    There may be branches registered for The Landscape Project but none
    of them match the current filter criteria for this page. Try
    filtering on "Any Status".

    >>> print_landscape_code_listing(no_priv_browser)
    There may be branches registered for The Landscape Project but none
    of them match the current filter criteria for this page. Try
    filtering on "Any Status".

    >>> print_landscape_code_listing(landscape_dev_browser)
    feature-x  Sample Person   60 New
    trunk      Sample Person   60 New

    >>> print_landscape_code_listing(admin_browser)
    feature-x  Sample Person   60 New
    trunk      Sample Person   60 New


== Person code listing pages ==

The person code listings is the other obvious place to filter out the
viewable branches.

    >>> def print_person_code_listing(browser, url=''):
    ...     # The batch argument is given to override the default batch
    ...     # size of five.
    ...     full_url = 'http://code.launchpad.dev/~name12%s?batch=15' % url
    ...     browser.open(full_url)
    ...     table = find_tag_by_id(browser.contents, 'branchtable')
    ...     branches = []
    ...     for row in table.tbody.fetch('tr'):
    ...         branches.append(extract_text(row))
    ...     landscape_branches = [branch for branch in branches
    ...                           if 'landscape' in branch]
    ...     print "%d branches listed" % len(branches)
    ...     for branch in landscape_branches:
    ...         print branch

    >>> print_person_code_listing(anon_browser)
    10 branches listed
    >>> print_person_code_listing(anon_browser, '/+authoredbranches')
    3 branches listed

    >>> print_person_code_listing(no_priv_browser)
    10 branches listed
    >>> print_person_code_listing(no_priv_browser, '/+authoredbranches')
    3 branches listed

    >>> print_person_code_listing(landscape_dev_browser)
    12 branches listed
    feature-x ... landscape Author
    trunk ... landscape Author
    >>> print_person_code_listing(landscape_dev_browser, '/+authoredbranches')
    5 branches listed
    feature-x ... landscape
    trunk ... landscape

    >>> print_person_code_listing(admin_browser)
    12 branches listed
    feature-x ... landscape Author
    trunk ... landscape Author
    >>> print_person_code_listing(admin_browser, '/+authoredbranches')
    5 branches listed
    feature-x ... landscape
    trunk ... landscape
