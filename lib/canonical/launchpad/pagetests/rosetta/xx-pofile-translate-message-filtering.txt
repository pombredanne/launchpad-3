= Message Filters on +translate Page =

While doing translations, there is a functionality that allows the user
to filter the kind of messages that should be shown.

For this test, we know that the valid msgsets that this form uses are
the ones with the ids between 130 and 151. By default, view shows the
messages in the batches of 10 items.

    # This describes the HTML tag ids we'll be looking for below.
    >>> match_translation_id = 'msgset_([0-9]+)_es_translation_0$'

    # This function will be used to check the content of the browser.
    >>> def print_shown_messages(browser, soup=None):
    ...     """Print the id/value of all shown translations on the page."""
    ...     import re
    ...
    ...     # Map msgset_ids to HTML tags
    ...     translations = {}
    ...
    ...     if soup is None:
    ...         soup = find_main_content(browser.contents)
    ...     for tag in soup.findAll('label'):
    ...         id = tag.get('id')
    ...         if id is not None:
    ...             match = re.match(match_translation_id, id)
    ...             if match:
    ...                 translations[int(match.group(1))] = tag
    ...
    ...     # Print matching HTML tags, in numeric order of msgset id
    ...     for msgset_id in sorted(translations.keys()):
    ...         translation = translations[msgset_id]
    ...         print "%d: '%s'" % (
    ...             msgset_id, translation.renderContents().strip())

== Filters ==

No Privileges Person visits the evolution-2.2 package in Ubuntu Hoary
to review the state of the translation.

    >>> user_browser.open(
    ...     'http://translations.launchpad.dev/ubuntu/hoary/'
    ...     '+source/evolution/+pots/evolution-2.2/es/+translate')
    >>> user_browser.title
    'Translating evolution-2.2 in ... package "evolution" into Spanish'

He can see that there are 22 messages.

    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    1 ... 10  of 22 results


=== Untranslated ===

No Privileges Person chooses to see the untranslated messages in the
evolution-2.2 sourcepackage. He sets the 'Show' list to 'Untranslated'
to filter the messages. He sees 13 messages are not translated.

    >>> user_browser.getControl('Show').value = ['untranslated']
    >>> user_browser.getControl('Filter').click()
    >>> user_browser.url
    'http://.../evolution-2.2/es/+translate?batch=10&show=untranslated'

    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    1 ... 10  of 13 results

    >>> print_shown_messages(user_browser, contents)
    133: '(no translation yet)'
    135: '(no translation yet)'
    136: '(no translation yet)'
    137: '(no translation yet)'
    138: '(no translation yet)'
    139: '(no translation yet)'
    140: '(no translation yet)'
    141: '(no translation yet)'
    142: '(no translation yet)'
    148: '(no translation yet)'

Only the first 10 messages were shown. No Privileges Person views the
next page of messages to confirm the three remaining messages show.

    >>> user_browser.getLink('Next').click()
    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    11 ... 13  of 13 results

    >>> print_shown_messages(user_browser, contents)
    149: '(no translation yet)'
    150: '(no translation yet)'
    151: '(no translation yet)'

In the case of the 'Untranslated' filter, users can change the set of
filtered messages by making updates to messages. No Privileges Person
decides to use the 'Untranslated' filter to locate messages that need
translations into Australian English.

    >>> user_browser.open(
    ...     'http://translations.launchpad.dev/ubuntu/hoary/'
    ...     '+source/evolution/+pots/evolution-2.2/en_AU/+translate')
    >>> user_browser.getControl('Show').value = ['untranslated']
    >>> user_browser.getControl('Filter').click()
    >>> user_browser.title
    'Translating evolution-2.2 in ... "evolution" into English (Australia)'

    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    1 ... 10  of 22 results

    >>> user_browser.getControl(
    ...     name='msgset_130_en_AU_translation_0_radiobutton').value = [
    ...         'msgset_130_en_AU_translation_0_new']
    >>> user_browser.getControl(
    ...     name='msgset_130_en_AU_translation_0_new').value = 'addressbook'
    >>> user_browser.getControl('Save & Continue').click()

The batch of 'Untranslated' messages was decremented by 1. No Privileges
Person can see that the next page of messages starts on 10, not 11, and
that there are 21 untranslated messages.

    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    10 ... 19  of 21 results

When No Privileges Person returns to the previous page, he can see
the first 10 untranslated messages. The message is translated is not
displayed.

    >>> user_browser.getLink("Previous").click()
    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    1 ... 10  of 21 results

    >>> print find_tag_by_id(
    ...     user_browser.contents, 'msgset_130_en_AU_translation_0')
    None

Projects can restrict translation to privileged users. The messages that
No Privileges Person adds to upstream Evolution are taken as
suggestions, not translations. His changes do not change the total
number of untranslated messages; they do not affect the batch
navigation.

    >>> user_browser.open(
    ...     'http://translations.launchpad.dev/'
    ...     'evolution/trunk/+pots/evolution-2.2/en_AU/+translate')
    >>> user_browser.getControl('Show').value = ['untranslated']
    >>> user_browser.getControl('Filter').click()
    >>> user_browser.title
    'Translating evolution-2.2 in Evolution trunk into English (Australia)'

    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    1 ... 10  of 22 results

    >>> user_browser.getControl(
    ...     name='msgset_1_en_AU_translation_0_new_checkbox').value = [
    ...         'msgset_1_en_AU_translation_0_new']
    >>> user_browser.getControl(
    ...     name='msgset_1_en_AU_translation_0_new').value = 'fnord'
    >>> user_browser.getControl('Save & Continue').click()

No Privileges Person can see that the number of untranslated messages
has not changed, and that he is seeing messages 11 though 20.

    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    11 ... 20  of 22 results

He returns to the previous page to check that his suggest of 'fnord' was
accepted.

    >>> user_browser.getLink('Previous').click()
    >>> contents = find_main_content(user_browser.contents)
    >>> contents.find(text='fnord').parent
    <div lang="en-AU" id="msgset_1_en_AU_suggestion_702_0" ...>fnord</div>


=== Messages with new suggestions ===

No Privileges Person chooses to view messages with new suggestions
submitted after they were last reviewed. There is only one message in
the batch.

    >>> user_browser.open(
    ...     'http://translations.launchpad.dev/ubuntu/hoary/'
    ...     '+source/evolution/+pots/evolution-2.2/es/+translate')
    >>> user_browser.getControl('Show:').displayValue = [
    ...     'with new suggestions']
    >>> user_browser.getControl('Filter').click()
    >>> user_browser.url
    'http://.../evolution-2.2/es/+translate?batch=10&show=new_suggestions'

    >>> print_shown_messages(user_browser)
    134: '<samp> </samp>caratas'


=== Messages needing review ===

No Privileges Person can view just the entries that need to be
reviewed by filtering on 'need review'. There are two messages in the
batch.

    >>> user_browser.getControl('Show:').displayValue = ['need review']
    >>> user_browser.getControl('Filter').click()

    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    1 ... 2  of 2 results

    >>> print_shown_messages(user_browser)
    132: 'tiene<samp> </samp>'
    146: '<code>%d</code> foo'

If the user deselects the 'Someone should review this translation'
control, submitting a translation will take that message out of the
'need review' set. When No Privileges Person reviews the Czech
translations for pmount, The filter and paging are updated by his
actions.

    >>> user_browser.open(
    ...     'http://translations.launchpad.dev/ubuntu/hoary/'
    ...     '+source/pmount/+pots/pmount/cs/+translate')
    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    1 ... 10  of 63 results

    >>> user_browser.getControl('Show:').displayValue = ['need review']
    >>> user_browser.getControl('Filter').click()
    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    1 ... 10  of 28 results

    >>> user_browser.getControl(name='msgset_84_cs_needsreview').value = []
    >>> user_browser.getControl(name='msgset_85_cs_needsreview').value = []
    >>> user_browser.getControl('Save & Continue').click()

Two messages were removed from the batch of 'need review' messages. No
Privileges Person can see that the next page of messages starts on 9,
not 11, and that there are 34 messages that need review.

    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    9 ... 18  of 26 results


=== Messages changed in Launchpad ===

No Privileges Person can see entries which have changed in Launchpad.
There is only one message in the batch.

    >>> user_browser.open(
    ...     'http://translations.launchpad.dev/ubuntu/hoary/'
    ...     '+source/evolution/+pots/evolution-2.2/es/+translate')
    >>> user_browser.getControl('Show:').displayValue = [
    ...     'changed in Launchpad']
    >>> user_browser.getControl('Filter').click()
    >>> user_browser.url
    'http://...evolution-2.2/es/+translate?batch=10&show=changed_in_launchpad'

    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    1 ... 1  of 1 result

    >>> print_shown_messages(user_browser, contents)
    134: '<samp> </samp>caratas'

Now that the messages are filtered, there is no Next link, since there
is only one page of messages. If No Privileges Person submits the form,
the browser is redirected to the first batch.

    >>> user_browser.getControl('Save & Continue').click()
    >>> user_browser.url
    'http://...evolution-2.2/es/+translate?batch=10&show=changed_in_launchpad'

    >>> print_shown_messages(user_browser)
    134: '<samp> </samp>caratas'


== Batch parameters when changing filters ==

When the filter changes, the batch is reset to the start of the set of
messages, while preserving the batch size. No Privileges Person can see
the batch header when he switches the filter to show 'untranslated'
message; he is seeing the first batch.

    >>> user_browser.open(
    ...     'http://translations.launchpad.dev/ubuntu/hoary/'
    ...     '+source/evolution/+pots/evolution-2.2/es/+translate')
    >>> user_browser.getLink('Last').click()
    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    21 ... 22  of 22 results

    >>> user_browser.getControl('Show').value = ['untranslated']
    >>> user_browser.getControl('Filter').click()
    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    1 ... 10  of 13 results


== Filters and error display ==

When there are errors in translations that No Privileges Person
submits, he sees a general error message at the top of the page,
plus individual error messages for the individual problematic
translations.

The error page shows the same messages that the user submitted for:
it is the same batch, shown with the same filter (see bug 112308).

No Privileges Person submits a bad translation, one that lacks
conversion specifications the original message has, and is shown an
error.

    >>> print find_tag_by_id(
    ...     user_browser.contents, 'msgset_142_singular').renderContents()
    Migrating ...%s...

    >>> user_browser.getControl(
    ...     name='msgset_142_es_translation_0_radiobutton').value = [
    ...         'msgset_142_es_translation_0_new']
    >>> user_browser.getControl(
    ...     name='msgset_142_es_translation_0_new').value = ('Migrando...')
    >>> user_browser.getControl(name='submit_translations').click()

The exact same batch of messages is shown again, but with the error.

    >>> user_browser.getControl('Show').value
    ['untranslated']

    >>> contents = find_main_content(user_browser.contents)
    >>> print_batch_header(contents)
    1 ... 10  of 13 results

    >>> print_shown_messages(user_browser, contents)
    133: '(no translation yet)'
    135: '(no translation yet)'
    136: '(no translation yet)'
    137: '(no translation yet)'
    138: '(no translation yet)'
    139: '(no translation yet)'
    140: '(no translation yet)'
    141: '(no translation yet)'
    142: '(no translation yet)'
    148: '(no translation yet)'

    >>> for tag in find_tags_by_class(user_browser.contents, 'error'):
    ...     print tag.renderContents()
    There is an error in a translation you provided.
    Please correct it before continuing.
    ...Error in Translation:...
    number of format specifications in 'msgid' and 'msgstr' does not match
    ...


== Filters and alternative languages ==

Handling of http parameters gets a bit more complex when forms are
posted. Nonetheless users can submit translations while combining
message filters with alternative suggestion languages. No Privileges
Person submits Chinese translations using Spanish suggestions.

    >>> user_browser.open(
    ...     'http://translations.launchpad.dev/ubuntu/hoary/'
    ...     '+source/evolution/+pots/evolution-2.2/zh_CN/+translate')
    >>> user_browser.getControl('Show').value = ['untranslated']
    >>> user_browser.getControl('Filter').click()
    >>> user_browser.getControl('Spanish (es)').selected = True
    >>> user_browser.getControl(name='select_alternate_language').click()

    >>> user_browser.getControl(
    ...     name='msgset_130_zh_CN_translation_0_radiobutton').value = [
    ...         'msgset_130_zh_CN_translation_0_new']
    >>> user_browser.getControl(
    ...     name='msgset_130_zh_CN_translation_0_new').value = 'Chinese!'
    >>> user_browser.getControl(name='submit_translations').click()

When he returns to the first page of messages, he is still shown Spanish
suggestions.

    >>> user_browser.getLink("Previous").click()

    >>> text = extract_text(find_main_content(user_browser.contents))
    >>> print text.encode('UTF-8')
    Description...
    Template ...
    English: current addressbook folder
    Current Chinese (China): (no translation yet)
    Suggestions:
    carpeta de libretas de direcciones actual
    Spanish
    ...
