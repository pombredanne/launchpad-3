Here we are going to check the basic behaviour of the translation form when we
render just one message with all available information for it.

First, we need to be sure that anonymous users are able to browse translations
but are unable to actually change them.

  >>> browser.open(
  ...     'http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/5')

We are in read only mode, so there shouldn't be any textareas:

  >>> main_content = find_tag_by_id(browser.contents, 'messages_to_translate')
  >>> for textarea in main_content.findAll('textarea'):
  ...     raise AssertionError, 'Found textarea:\n%s' % textarea

Neither any input widget:

  >>> for input in main_content.findAll('input'):
  ...     raise AssertionError, 'Found input:\n%s' % input

Also, any anonymous POST submission should fail:

  >>> print http(r"""
  ... POST /ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/5/+translate HTTP/1.1
  ... Host: translations.launchpad.dev
  ... """)
  HTTP/1.1 500 Internal Server Error
  ...
  ...UnexpectedFormData: Anonymous users cannot do POST submissions...


Let's log in.

  >>> browser = setupBrowser(auth='Basic carlos@canonical.com:test')

Now, we are going to test common parts of the navigation.

The main page for a pomsgset object should redirect us to the translation form.

  >>> browser.open(
  ...     'http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/1')

When we are on the first message, we should be 100% sure that the 'First' and
'Previous' links are hidden and 'Next' and 'Last' are the right ones.

  >>> browser.open(
  ...     'http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/1/+translate')

  >>> browser.getLink('First')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

  >>> browser.getLink('Prev')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

  >>> next = browser.getLink('Next')
  >>> print next.url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/2/+translate
  >>> print browser.getLink('Last').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate

And the link to the IPOFile view should be there too:

  >>> print browser.getLink('Return to multiple messages view').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=0

when we choose the next entry, all links should appear.

  >>> next.click()
  >>> print browser.getLink('First').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> print browser.getLink('Previous').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> print browser.getLink('Next').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/3/+translate
  >>> last = browser.getLink('Last')
  >>> print last.url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate

And the link to the IPOFile view should be there too:

  >>> print browser.getLink('Return to multiple messages view').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=1

And the last one.

  >>> last.click()
  >>> print browser.getLink('First').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> prev = browser.getLink('Previous')
  >>> print prev.url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/21/+translate

  >>> browser.getLink('Next')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

  >>> browser.getLink('Last')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

And the link to the IPOFile view should be there too:

  >>> print browser.getLink('Return to multiple messages view').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=21

Let's test the ones at the end of the form.

  >>> prev.click()
  >>> print browser.getLink('First').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> print browser.getLink('Previous').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/20/+translate
  >>> print browser.getLink('Next').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate
  >>> print browser.getLink('Last').url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate

Now, we are going to check a message submission.

  >>> browser.open(
  ...     'http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/13/+translate')

Check that the message #13 is without translation.

First what we represent in the form when there is no translation:

  >>> print find_tag_by_id(browser.contents, 'msgset_142').renderContents()
  13.
  <input type="hidden" name="msgset_142" />
  >>> print find_tag_by_id(
  ...     browser.contents, 'msgset_142_singular').renderContents()
  Migrating `<code>%s</code>':
  >>> print find_tag_by_id(
  ...     browser.contents, 'msgset_142_es_translation_0').renderContents()
  (no translation yet)

And also, we don't get anyone as the Last translator because there is no
translation at all ;-)

  >>> find_tag_by_id(browser.contents, 'translated_and_reviewed_by') is None
  True
  >>> find_tag_by_id(browser.contents, 'translated_by') is None
  True
  >>> find_tag_by_id(browser.contents, 'reviewed_by') is None
  True

Let's submit an invalid value for this message #13.

  >>> browser.getControl(
  ...     name='msgset_142_es_translation_0_radiobutton').value = [
  ...         'msgset_142_es_translation_0_new']
  >>> browser.getControl(
  ...     name='msgset_142_es_translation_0_new').value = 'foo %i'
  >>> browser.getControl(name='submit_translations').click()
  >>> print browser.url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/13/+translate
  >>> for tag in find_tags_by_class(browser.contents, 'error'):
  ...     print tag
  <div class="error message">There is an error in the translation you provided.
    Please correct it before continuing.</div>
  <tr class="error translation">
    <th colspan="3">
      <strong>Error in Translation:</strong>
    </th>
    <td>
    </td><td>
      <div>
        format specifications in 'msgid' and 'msgstr' for argument 1 are not
        the same
      </div>
    </td>
  </tr>

The message is still without translation:

  >>> print find_tag_by_id(browser.contents, 'msgset_142').renderContents()
  13.
  <input type="hidden" name="msgset_142" />
  >>> print find_tag_by_id(
  ...     browser.contents, 'msgset_142_singular').renderContents()
  Migrating `<code>%s</code>':
  >>> print find_tag_by_id(
  ...     browser.contents, 'msgset_142_es_translation_0').renderContents()
  (no translation yet)

And now a good submit.

  >>> browser.getControl(
  ...     name='msgset_142_es_translation_0_radiobutton').value = [
  ...         'msgset_142_es_translation_0_new']
  >>> browser.getControl(
  ...     name='msgset_142_es_translation_0_new').value = 'foo %s'
  >>> browser.getControl(name='submit_translations').click()

We moved to the next message, that means this submission worked.

  >>> print browser.url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate

Now, it has the submitted value.

  >>> browser.open(
  ...     'http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/13/+translate')

Check that the message #13 has the new value we submitted.

  >>> print find_tag_by_id(browser.contents, 'msgset_142').renderContents()
  13.
  <input type="hidden" name="msgset_142" />
  >>> print find_tag_by_id(
  ...     browser.contents, 'msgset_142_singular').renderContents()
  Migrating `<code>%s</code>':
  >>> print find_tag_by_id(
  ...     browser.contents, 'msgset_142_es_translation_0').renderContents()
  foo <code>%s</code>

And now, we get the translator and reviewer, who happen to be the same in
this instance.

  >>> find_tag_by_id(browser.contents, 'translated_and_reviewed_by') is None
  False
  >>> find_tag_by_id(browser.contents, 'translated_by') is None
  True
  >>> find_tag_by_id(browser.contents, 'reviewed_by') is None
  True

In some other cases where translator and reviewer are different, they are
both shown separately:

  >>> browser.open(
  ...     'http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/man/es/1/+translate')
  >>> find_tag_by_id(browser.contents, 'translated_and_reviewed_by') is None
  True
  >>> find_tag_by_id(browser.contents, 'translated_by') is None
  False
  >>> find_tag_by_id(browser.contents, 'reviewed_by') is None
  False



Now, we will check suggestions in this form.

  >>> browser.open(
  ...     'http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/14/+translate')

Check that suggestions come in from other contexts:

  >>> "Suggested in" in browser.contents
  True
  >>> find_tag_by_id(browser.contents, 'msgset_143_es_suggestion_693_0')
  <...suggestion added by a non-editor for a multiline entry...>

Check that no other suggestions are presented (since no others are
relevant for this message):

  >>> "Suggested by" in browser.contents
  False
  >>> "Used in" in browser.contents
  False

Check for the translator note:

  >>> "This is an example of commenttext for a multiline" in browser.contents
  True

Also check that the alternative language selection is working:

  >>> browser.getControl(name='field.alternative_language').value = ['ca']
  >>> browser.getControl(name='select_alternate_language').click()
  >>> browser.url
  'http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate?field.alternative_language=ca&field.alternative_language-empty-marker=1&select_alternate_language=Change'

If we specify more than one alternative language in the URL, we get an
UnexpectedFormData exception:

  >>> browser.open(
  ...  'http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...  '+pots/evolution-2.2/es/14/+translate?field.alternative_language=ca&'
  ...  'field.alternative_language=es')
  Traceback (most recent call last):
  ...
  UnexpectedFormData: You specified...

Let's see what happens when we do a submission with a lock_timestamp older
than the review date for current translation.

First, we get a browser instance that will be the last one submitting the
changes.

  >>> slow_submission = setupBrowser(auth='Basic carlos@canonical.com:test')
  >>> slow_submission.open(
  ...     'http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/14/+translate')
  >>> import transaction
  >>> transaction.commit()

Now, we get another instance that will be submitted before 'slow_submission'.

  >>> fast_submission = setupBrowser(auth='Basic carlos@canonical.com:test')
  >>> fast_submission.open(
  ...     'http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/14/+translate')

Let's change the translation.

  >>> fast_submission.getControl(
  ...     name='msgset_143_es_translation_0_radiobutton').value = [
  ...         'msgset_143_es_translation_0_new']
  >>> fast_submission.getControl(
  ...     name='msgset_143_es_translation_0_new').value = u'blah'

And submit it.

  >>> fast_submission.getControl(name='submit_translations').click()
  >>> print fast_submission.url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/15/+translate

Now, we check that the translation we are going to add is not yet in the
form, so we can check later that it's added as a suggestion:

  >>> 'foo!!' in fast_submission.contents
  False

Now, we update the translation in slow_submission.

  >>> slow_submission.getControl(
  ...     name='msgset_143_es_translation_0_radiobutton').value = [
  ...         'msgset_143_es_translation_0_new']
  >>> slow_submission.getControl(
  ...     name='msgset_143_es_translation_0_new').value = u'foo!!'

We submit it

  >>> slow_submission.getControl(name='submit_translations').click()
  >>> print slow_submission.url
  http://translations.launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate
  >>> for tag in find_tags_by_class(slow_submission.contents, 'error'):
  ...     print tag
  <div class="error message">There is an error in the translation you provided. Please correct it before continuing.</div>
  <tr class="error translation">
    <th colspan="3">
      <strong>Error in Translation:</strong>
    </th>
    <td>
    </td><td>
      <div>
        Somebody else changed this translation since you started. To avoid
        accidentally reverting work done by others, we added your translations
        as suggestions, so please review current values.
      </div>
    </td>
  </tr>

Also, we should still have previous translation:

  >>> print find_tag_by_id(
  ...     slow_submission.contents, 'msgset_143').renderContents()
  14.
  <input type="hidden" name="msgset_143" />
  >>> print find_tag_by_id(
  ...     slow_submission.contents, 'msgset_143_singular').renderContents()
  The location and hierarchy of the Evolution contact...
  >>> print find_tag_by_id(
  ...     slow_submission.contents,
  ...     'msgset_143_es_translation_0').renderContents()
  blah

But also, the new one should appear in the form.

  >>> find_tag_by_id(
  ...     slow_submission.contents,
  ...     'msgset_143_es_suggestion_715_0').renderContents()
  'foo!!'

== Unreviewed translations ==

If there is a message which has a translation, but no reviewer (eg. uploaded
from a package), it only shows the translator, and not reviewer.

  >>> browser.open('http://translations.launchpad.dev/ubuntu/hoary/+source/'
  ...              'mozilla/+pots/pkgconf-mozilla/de/1/+translate')
  >>> print extract_text(
  ...     find_tag_by_id(browser.contents, "translated_by").parent)
  Translated by Helge Kreutzmann on 2005-05-06
  >>> print find_tag_by_id(browser.contents, "reviewed_by")
  None
  >>> print find_tag_by_id(browser.contents, "translated_and_reviewed_by")
  None

== Translating context ==

Going to a translation page for a message with the context displays the
context.

    >>> browser.open(
    ...     'http://translations.launchpad.dev/alsa-utils/trunk/+pots/'
    ...     'alsa-utils/sr/+translate')
    >>> print extract_text(find_tag_by_id(
    ...     browser.contents, "msgset_198_context").parent)
    Something

We can change a translation for messages with context.

  >>> browser.getControl(
  ...     name='msgset_198_sr_translation_0_radiobutton').value = [
  ...         'msgset_198_sr_translation_0_new']
  >>> browser.getControl(
  ...     name='msgset_198_sr_translation_0_new').value = u'blah'

And submit it.

  >>> browser.getControl(name='submit_translations').click()
  >>> print browser.url
  http://translations.launchpad.dev/alsa-utils/trunk/+pots/alsa-utils/sr/+translate

And the translation is now updated.

    >>> print extract_text(
    ...     find_tag_by_id(browser.contents, "msgset_198_sr_translation_0"))
    blah
