= Forwarding bugs upstream =

The +choose-affected-product page is, in fact, a wizard-like page which
allows the user to select the affected product, specify a remote bug URL
and create the actual bugtask/watch (also creating the bugtracker if
necessary).

Trying to add an upstream task to a bug on the evolution package in Ubuntu
will cause the product-selection step to be skipped because the package is
linked to the evolution upstream product.

    >>> user_browser.open(
    ...  'http://launchpad.dev/ubuntu/+source/evolution/+bug/6')
    >>> user_browser.getLink(url='+choose-affected-product').click()
    >>> user_browser.getControl('Project').value
    Traceback (most recent call last):
    ...
    LookupError: label 'Project'
    >>> user_browser.getControl(name='field.product').value
    'evolution'

If this wasn't what we intended, we can go back to choose another
product, though.

    >>> user_browser.getLink('Choose another project').click()
    >>> user_browser.url
    'http://bugs.launchpad.dev/ubuntu/+source/evolution/+bug/6/+choose-affected-product?field.product=evolution'

    >>> user_browser.getControl('Project').value
    'evolution'

    >>> user_browser.getControl('Project').value = 'thunderbird'
    >>> user_browser.getControl('Continue').click()

Since Thunderbird doesn't use Launchpad, there's a widget for entering 
a bug URL.

    >>> user_browser.getControl('URL').value
    ''

If we leave it empty, a notification will be shown when trying to add
the task, asking us to confirm that we want to add the task without a
bug watch.

    >>> user_browser.getControl('Add to Bug Report').click()
    >>> user_browser.url
    'http://.../ubuntu/+source/evolution/+bug/6/+choose-affected-product'

    >>> print get_feedback_messages(user_browser.contents)
    [u"Mozilla Thunderbird doesn't use Launchpad as its bug tracker...]

Let's confirm adding the task.

    >>> user_browser.getControl('Yes').click()
    >>> user_browser.url
    'http://bugs.launchpad.dev/thunderbird/+bug/6'

Let's add the evolution task as well.

    >>> user_browser.open(
    ...  'http://launchpad.dev/ubuntu/+source/evolution/+bug/6')
    >>> user_browser.getLink(url='+choose-affected-product').click()
    >>> user_browser.url
    'http://.../ubuntu/+source/evolution/+bug/6/+choose-affected-product'

    >>> user_browser.getControl('Add to Bug Report').click()

    >>> user_browser.url
    'http://bugs.launchpad.dev/evolution/+bug/6'

== Error messages ==

If we try to add an upstream task without specifying a product:

    >>> user_browser.open(
    ...     'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3')
    >>> user_browser.getLink(url='+choose-affected-product').click()
    >>> user_browser.url
    'http://.../debian/+source/mozilla-firefox/+bug/3/+choose-affected-product'

    >>> user_browser.getControl('Project').value
    ''
    >>> user_browser.getControl('Continue').click()
    >>> user_browser.url
    'http://.../debian/+source/mozilla-firefox/+bug/3/+choose-affected-product'

We get a nice error message.

    >>> print get_feedback_messages(user_browser.contents)
    [u'There is 1 error.', u'Required input is missing.']

If we enter a product name that doesn't exist, we inform the user
about this and ask him to search for the product.

    >>> user_browser.getControl('Project').value = 'no-such-product'
    >>> user_browser.getControl('Continue').click()
    >>> user_browser.url
    'http://.../debian/+source/mozilla-firefox/+bug/3/+choose-affected-product'
    >>> print get_feedback_messages(user_browser.contents)
    [u'There is 1 error.',
     u'There is no project in Launchpad named "no-such-product"...]

    >>> search_link = user_browser.getLink('search for it')
    >>> search_link.url
    "javascript:popup_window('@@popup-window?vocabulary=Product&field=field.product&search='+escape(document.getElementById('field.product').value),'field.product','300','420')"

Since the link is a javascript popup, we can't follow the link directly,
so let's extract the real URL and open it manually.

    >>> import re
    >>> search_url = re.search(
    ...     "popup_window\('([^']*)'", search_link.url).group(1)
    >>> user_browser.open(
    ...  'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3/'
    ...   + search_url)
    >>> user_browser.title
    'Select a project'

Since we don't restrict the input, the user can write anything, so we
need to make sure that everything is quoted before displaying the input.

    >>> user_browser.open(
    ...     'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3'
    ...     '/+choose-affected-product')

    >>> user_browser.getControl('Project').value = 'N\xc3\xb6 Such Product&<>'
    >>> user_browser.getControl('Continue').click()
    >>> user_browser.url
    'http://.../debian/+source/mozilla-firefox/+bug/3/+choose-affected-product'
    >>> print get_feedback_messages(user_browser.contents)
    [u'There is 1 error.',
     u'There is no project in Launchpad named "N\xf6 Such Product&amp;&lt...]

== Linking to bug watches ==

Now we add an upstream task, while adding this new bugtask we can also
specify a bug watch. If we inadvertently left some leading or trailing white
space in the bug URL it will be stripped.

    >>> user_browser.open(
    ...     'http://launchpad.dev/debian/+source/mozilla-firefox/'
    ...     '+bug/3/+choose-affected-product')
    >>> user_browser.getControl('Project').value = 'alsa-utils'
    >>> user_browser.getControl('Continue').click()
 
    >>> user_browser.getControl('URL').value = (
    ...     '   https://bugzilla.mozilla.org/show_bug.cgi?id=1234   ')
    >>> user_browser.getControl('Add to Bug Report').click()

Launchpad redirects to the newly created bugtask page, with a row for the
new bug watch.

    >>> user_browser.url
    'http://bugs.launchpad.dev/alsa-utils/+bug/3'
    >>> affects_table = find_tags_by_class(user_browser.contents, 'listing')[0]
    >>> target_cell = affects_table.tbody.tr.td
    >>> extract_text(target_cell)
    u'alsa-utils'

And we can check that the remote bug number was stripped.

    >>> user_browser.getLink('mozilla.org #1234')
    <Link text='Linked to [IMG] mozilla.org #1234'
      url='https://bugzilla.mozilla.org/show_bug.cgi?id=1234'>

And now we try to add the same upstream again.

    >>> user_browser.getLink(url='+choose-affected-product').click()
    >>> user_browser.url
    'http://bugs.launchpad.dev/alsa-utils/+bug/3/+choose-affected-product'

    >>> user_browser.getControl('Project').value = 'alsa-utils'
    >>> user_browser.getControl('Continue').click()
    >>> user_browser.url
    'http://bugs.launchpad.dev/alsa-utils/+bug/3/+choose-affected-product'

We get a nice error message.

    >>> print get_feedback_messages(user_browser.contents)
    [u'There is 1 error.',
     u'A fix for this bug has already been requested for alsa-utils']

We can add another upstream to the bug.

    >>> user_browser.getControl('Project').value = 'evolution'
    >>> user_browser.getControl('Continue').click()
    >>> user_browser.getControl('Add to Bug Report').click()
    >>> user_browser.url
    'http://bugs.launchpad.dev/evolution/+bug/3'

But if we try to change it to the target of an existing upstream bugtask,
our validator springs into action.

    >>> user_browser.getLink(url='evolution/+bug/3/+editstatus').click()
    >>> user_browser.url
    'http://bugs.launchpad.dev/evolution/+bug/3/+editstatus'
    >>> user_browser.getControl('Project').value = 'alsa-utils'
    >>> user_browser.getControl('Save Changes').click()
    >>> user_browser.url
    'http://bugs.launchpad.dev/evolution/+bug/3/+editstatus'
    >>> print get_feedback_messages(user_browser.contents)
     [u'There is 1 error in the data you entered...
      u'A fix for this bug has already been requested for alsa-utils']
