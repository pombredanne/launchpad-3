Let's first setup some objects that we'll need.

  >>> from zope.testbrowser.testing import Browser
  >>> no_priv_browser = Browser()
  >>> no_priv_browser.handleErrors = False
  >>> no_priv_browser.addHeader(
  ...     'Authorization', 'Basic no-priv@canonical.com:test')
  >>> team_admin_browser = browser
  >>> team_admin_browser.addHeader(
  ...     'Authorization', 'Basic jeff.waugh@ubuntulinux.com:jdub')

If you're not logged in and go to the +polls page of the "Ubuntu Team"
you'll see a link to login as a team administrator.

  >>> anon_browser.open('http://launchpad.dev/~ubuntu-team')
  >>> anon_browser.getLink('Show polls').click()
  >>> anon_browser.url
  'http://launchpad.dev/~ubuntu-team/+polls'
  >>> anon_browser.getLink('Log in as an admin to set up a new poll').url
  'http://launchpad.dev/~ubuntu-team/+login'

Try to create a new poll logged in as 'no-priv', which is not a team
administrator. There's no link leading to the +newpoll page, but the user can
easily guess it.

  >>> no_priv_browser.open('http://launchpad.dev/~ubuntu-team/+newpoll')
  Traceback (most recent call last):
  ...
  Unauthorized:...

Now we're logged in as Jeff Waugh which is a team administrator and thus can
create a new poll.

  >>> team_admin_browser.open('http://launchpad.dev/~ubuntu-team')
  >>> team_admin_browser.getLink('Create a poll').click()
  >>> team_admin_browser.url
  'http://launchpad.dev/~ubuntu-team/+newpoll'

  >>> team_admin_browser.title
  'New poll for team Ubuntu Team'

  >>> 'Create a new poll for team' in team_admin_browser.contents
  True

First we try to create a poll with a invalid name to
test the name field validator.

  >>> team_admin_browser.getControl(
  ...     'The unique name of this poll').value = 'election_2100'
  >>> team_admin_browser.getControl(
  ...     'The title of this poll').value = 'Presidential Election 2100'
  >>> proposition = 'Who is going to be the next president?'
  >>> team_admin_browser.getControl(
  ...     'The proposition that is going to be voted').value = proposition
  >>> secrecy = "Secret Votes (It's impossible to track a person's vote)"
  >>> team_admin_browser.getControl(
  ...     'The secrecy of the Poll').displayValue = [secrecy]
  >>> team_admin_browser.getControl(
  ...     'Users can spoil their votes?').selected = True
  >>> team_admin_browser.getControl(
  ...     name='field.dateopens').value = '2100-06-04 02:00:00+00:00'
  >>> team_admin_browser.getControl(
  ...     name='field.datecloses').value = '2100-07-04 02:00:00+00:00'
  >>> team_admin_browser.getControl('Continue').click()

  >>> "Invalid name 'election_2100'" in team_admin_browser.contents
  True

We fix the name, but swap the dates. Again a nice error message.

  >>> team_admin_browser.getControl(
  ...     'The unique name of this poll').value = 'election-2100'
  >>> team_admin_browser.getControl(
  ...     name='field.dateopens').value = '2100-07-04 02:00:00+00:00'
  >>> team_admin_browser.getControl(
  ...     name='field.datecloses').value = '2100-06-04 02:00:00+00:00'
  >>> team_admin_browser.getControl('Continue').click()

  >>> "This event can't start after it ends" in team_admin_browser.contents
  True

Now we get it right.

  >>> team_admin_browser.getControl(
  ...     name='field.dateopens').value = '2100-06-04 02:00:00+00:00'
  >>> team_admin_browser.getControl(
  ...     name='field.datecloses').value = '2100-07-04 02:00:00+00:00'
  >>> team_admin_browser.getControl('Continue').click()

We're redirected to the newly created poll page.

  >>> team_admin_browser.url
  'http://launchpad.dev/~ubuntu-team/+poll/election-2100'

Create a new poll that starts in 2025-06-04 and will last until 2035.

  >>> team_admin_browser.open(
  ...     'http://launchpad.dev/~ubuntu-team/+newpoll')
  >>> team_admin_browser.getControl(
  ...     'The unique name of this poll').value = 'dpl-2080'
  >>> team_admin_browser.getControl(
  ...     'The title of this poll').value = 'Debian Project Leader Election 2080'
  >>> proposition = 'The next debian project leader'
  >>> team_admin_browser.getControl(
  ...     'The proposition that is going to be voted').value = proposition
  >>> secrecy = (
  ...     "Semi-secret Votes (Only team administrators can see a person's "
  ...     "vote)")
  >>> team_admin_browser.getControl(
  ...     'The secrecy of the Poll').displayValue = [secrecy]
  >>> team_admin_browser.getControl(
  ...     'Users can spoil their votes?').selected = True
  >>> team_admin_browser.getControl(
  ...     name='field.dateopens').value = '2025-06-04 02:00:00+00:00'
  >>> team_admin_browser.getControl(
  ...     name='field.datecloses').value = '2035-06-04 02:00:00+00:00'
  >>> team_admin_browser.getControl('Continue').click()

We're redirected to the newly created poll

  >>> team_admin_browser.url
  'http://launchpad.dev/~ubuntu-team/+poll/dpl-2080'
  >>> team_admin_browser.title
  'Poll: \xe2\x80\x9cDebian Project Leader Election 2080\xe2\x80\x9d'
  >>> 'Poll overview' in team_admin_browser.contents
  True
  >>> team_admin_browser.getLink('add an option').url
  'http://launchpad.dev/%7Eubuntu-team/+poll/dpl-2080/+newoption'

Now lets try to insert a poll with the name of a existing one.

# XXX matsubara 2006-07-17 bug=53302:
# There's no link to get back to +polls.

  >>> team_admin_browser.open(
  ...     'http://launchpad.dev/~ubuntu-team/+newpoll')
  >>> team_admin_browser.getControl(
  ...     'The unique name of this poll').value = 'dpl-2080'
  >>> team_admin_browser.getControl(
  ...     'The title of this poll').value = 'Debian Project Leader Election 2080'
  >>> proposition = 'The next debian project leader'
  >>> team_admin_browser.getControl(
  ...     'The proposition that is going to be voted').value = proposition
  >>> secrecy = (
  ...     "Semi-secret Votes (Only team administrators can see a person's "
  ...     "vote)")
  >>> team_admin_browser.getControl(
  ...     'The secrecy of the Poll').displayValue = [secrecy]
  >>> team_admin_browser.getControl(
  ...     'Users can spoil their votes?').selected = True
  >>> team_admin_browser.getControl(
  ...     name='field.dateopens').value = '2025-06-04 02:00:00+00:00'
  >>> team_admin_browser.getControl(
  ...     name='field.datecloses').value = '2035-06-04 02:00:00+00:00'
  >>> team_admin_browser.getControl('Continue').click()

  >>> message = 'dpl-2080 is already in use by another poll in this team'
  >>> message in team_admin_browser.contents
  True

