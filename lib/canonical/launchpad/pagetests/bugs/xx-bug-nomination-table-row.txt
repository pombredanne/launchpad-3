Bug nominations are displayed in the table at the top of the bug page,
using the +bugtasks-and-nominations-table-row view. This view allows
privileged users, i.e., users that have launchpad.Driver permission on
the distroseries or productseries, to approve or decline the
nomination.

no-priv cannot approve or decline his nomination, because he does not
have the launchpad.Driver permission.

    >>> from zope.component import getUtility

    >>> from canonical.launchpad.ftests import login, logout
    >>> from canonical.launchpad.interfaces import IBugSet, IDistributionSet
    >>> from canonical.launchpad.webapp.authorization import check_permission

    >>> login("no-priv@canonical.com")

    >>> bug_one = getUtility(IBugSet).get(1)
    >>> ubuntu = getUtility(IDistributionSet).getByName("ubuntu")
    >>> ubuntu_hoary = ubuntu.getSeries("hoary")
    >>> ubuntu_hoary_nomination = bug_one.getNominationFor(ubuntu_hoary)

    >>> check_permission("launchpad.Driver", ubuntu_hoary_nomination.target)
    False

    >>> logout()

    >>> user_browser.open(
    ...     "http://launchpad.dev/distros/ubuntu/+source/mozilla-firefox/"
    ...     "+bug/1/nominations/2/+bugtasks-and-nominations-table-row")

no-priv will, of course, see his nomination.

    >>> user_browser.contents
    '...Nominated...for...Hoary...by...No Privileges Person...'

But not the approve/decline link, nor any Approve or Decline buttons.

    >>> user_browser.getLink("approve/decline")
    Traceback (most recent call last):
    ...
    LinkNotFoundError

    >>> user_browser.getControl("Approve")
    Traceback (most recent call last):
      ...
    LookupError: ...

    >>> user_browser.getControl("Decline")
    Traceback (most recent call last):
      ...
    LookupError: ...

no-priv can't access the +edit-form (the view that renders the submit
buttons) directly either.

    >>> user_browser.open(
    ...     "http://launchpad.dev/distros/ubuntu/+source/mozilla-firefox/"
    ...     "+bug/1/nominations/2/+edit-form")
    Traceback (most recent call last):
      ...
    Unauthorized: ...

But if we log in as a user that does have launchpad.Driver permission,
we will see the approve/decline links.

First, when the task is in Proposed state, the (privileged) user sees an
approve/decline link.

    >>> login("foo.bar@canonical.com")
    >>> check_permission("launchpad.Driver", ubuntu_hoary_nomination.target)
    True
    >>> ubuntu_hoary_nomination.isProposed()
    True
    >>> logout()

    >>> browser = setupBrowser("Basic foo.bar@canonical.com:test")
    >>> browser.open(
    ...     "http://launchpad.dev/distros/ubuntu/+source/mozilla-firefox/"
    ...     "+bug/1/nominations/2/+bugtasks-and-nominations-table-row")

    >>> browser.getLink("approve/decline")
    <Link ...>

Clicking the "approve/decline" link causes a simple form to be expanded
underneath, with "Approve" and "Decline" buttons.

    >>> approve_button = browser.getControl("Approve")
    >>> decline_button = browser.getControl("Decline")

Clicking "Decline" declines the nomination.

    >>> decline_button.click()

    >>> login("foo.bar@canonical.com")
    >>> ubuntu_hoary_nomination = bug_one.getNominationFor(ubuntu_hoary)
    >>> ubuntu_hoary_nomination.isDeclined()
    True
    >>> logout()

Now only the "Approve" button shows, and the approve/decline link now
reads only "approve".

    >>> browser = setupBrowser("Basic foo.bar@canonical.com:test")
    >>> browser.open(
    ...     "http://launchpad.dev/distros/ubuntu/+source/mozilla-firefox/"
    ...     "+bug/1/nominations/2/+bugtasks-and-nominations-table-row")

    >>> browser.contents
    '...Declined...for...Hoary...by...Foo Bar...'

    >>> browser.getLink("approve/decline")
    Traceback (most recent call last):
      ...
    LinkNotFoundError
    >>> browser.getLink("approve")
    <Link ...>

    >>> approve_button = browser.getControl("Approve")
    >>> browser.getControl("Decline")
    Traceback (most recent call last):
      ...
    LookupError: ...

Clicking "Approve" approves the nomination.

    >>> approve_button.click()

    >>> login("foo.bar@canonical.com")
    >>> ubuntu_hoary_nomination = bug_one.getNominationFor(ubuntu_hoary)
    >>> ubuntu_hoary_nomination.isApproved()
    True
    >>> logout()
