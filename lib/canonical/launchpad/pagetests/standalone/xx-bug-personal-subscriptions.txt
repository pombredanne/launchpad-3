Personal Subscriptions
======================

The user should be able to subscribe and unsubscribe from bugs in
Launchpad.

When they are not subscribed, they should see the "Subscribe" link in
the actions portlet.

  >>> browser.addHeader('Authorization', 'Basic foo.bar@canonical.com:test')
  >>> browser.open('http://localhost/products/firefox/+bug/1')
  >>> browser.url
  'http://localhost/products/firefox/+bug/1'

  >>> subscribe_link = browser.getLink('Subscribe')
  >>> subscribe_link.text
  'Subscribe'

If they follow that link, they should be able to see the page that asks them
if they want to subscribe. The "Subscribe" button should be visible on the
page.

  >>> subscribe_link.click()

  >>> subscription_widget = browser.getControl(name='field.subscription')
  >>> subscription_widget.options
  ['name16']
  >>> subscription_widget.value
  ['name16']

  >>> submit = browser.getControl('Continue')

Now, let's POST that back to the bug home page. It should show the user. It
should also show a message, and the link should change to "Unsubscribe".

  >>> submit.click()

  >>> browser.url
  'http://localhost/products/firefox/+bug/1/'

  >>> from BeautifulSoup import BeautifulSoup
  >>> soup = BeautifulSoup(browser.contents)
  >>> for p_tag in soup('p', 'informational message'):
  ...   print p_tag.string
  You have been subscribed to this bug.

  >>> def print_subscribers(bug_page):
  ...     """Print the subscribers listed in the subscriber portlet."""
  ...     soup = BeautifulSoup(bug_page)
  ...     subscriber_portlet_headers = soup.fetchText(
  ...        'Subscribers to bug 1:')
  ...     assert len(subscriber_portlet_headers) == 1
  ...     subscriber_portlet = subscriber_portlet_headers[0].parent.parent
  ...     for li in subscriber_portlet.fetch('ul', 'people')[0].fetch('li'):
  ...         print li.a.string
  >>> print_subscribers(browser.contents)
  Steve Alexander
  Sample Person
  Foo Bar


Now, we want to view the +subscribe page again. It should say "Unsubscribe"
because we are now a subscriber.

  >>> subscribe_link = browser.getLink('Unsubscribe')
  >>> subscribe_link.text
  'Unsubscribe'
  >>> subscribe_link.click()
  >>> print browser.title
  Bug #1 - Subscription options
  >>> browser.url
  'http://localhost/products/firefox/+bug/1/+subscribe'

And if we POST that back to the bug home page, we will be unsubscribed in a
spectacular fashion.

  >>> subscription_widget.value
  ['name16']
  >>> submit = browser.getControl('Continue')
  >>> submit.click()

  >>> browser.url
  'http://localhost/products/firefox/+bug/1/'

  >>> soup = BeautifulSoup(browser.contents)
  >>> for p_tag in soup('p', 'informational message'):
  ...   print p_tag.string
  You have been unsubscribed from this bug.

  >>> subscribe_link = browser.getLink('Subscribe')
  >>> subscribe_link.text
  'Subscribe'

Let's subscribe one of Foo Bar's team to see what happens.

  >>> browser.getLink('Subscribe Someone Else').click()
  >>> browser.url
  'http://localhost/products/firefox/+bug/1/+addsubscriber'

  >>> browser.getControl('Person').value = 'launchpad'
  >>> browser.getControl('Add').click()
  >>> browser.url
  'http://localhost/products/firefox/+bug/1'

  >>> print_subscribers(browser.contents)
  Steve Alexander
  Sample Person
  Launchpad Developers

Now the subscribe link says 'Subscribe/Unsubscribe'.

  >>> subscribe_link = browser.getLink('Subscribe')
  >>> subscribe_link.text
  'Subscribe/Unsubscribe'

If we go to it, we'll have the option of both subscribing Foo Bar, and
to unsubscribe the Launchpad team.

  >>> subscribe_link.click()
  >>> browser.url
  'http://localhost/products/firefox/+bug/1/+subscribe'

  >>> subscription_widget = browser.getControl(name='field.subscription')
  >>> subscription_widget.options
  ['name16', 'launchpad']

Let's unsubscribe the Launchpad team.

  >>> subscription_widget.value = ['launchpad']
  >>> browser.getControl('Continue').click()

  >>> browser.url
  'http://localhost/products/firefox/+bug/1/'

  >>> soup = BeautifulSoup(browser.contents)
  >>> for p_tag in soup('p', 'informational message'):
  ...   print p_tag.string
  Launchpad Developers has been unsubscribed from this bug.

  >>> print_subscribers(browser.contents)
  Steve Alexander
  Sample Person

On the subscribe page there's a Cancel button as well, so if we go to
that page and press the Cancel button, we will return to the bug page.

  >>> subscribe_link = browser.getLink('Subscribe')
  >>> subscribe_link.text
  'Subscribe'

  >>> subscribe_link.click()
  >>> browser.url
  'http://localhost/products/firefox/+bug/1/+subscribe'

  >>> subscription_widget = browser.getControl(name='field.subscription')
  >>> subscription_widget.value
  ['name16']
  >>> cancel_button = browser.getControl('Cancel')
  >>> cancel_button.click()
  >>> browser.url
  'http://localhost/products/firefox/+bug/1/'
  >>> soup = BeautifulSoup(browser.contents)

Foo Bar wasn't subscribed to the bug.

  >>> len(soup('p', 'informational message'))
  0
  >>> print_subscribers(browser.contents)
  Steve Alexander
  Sample Person
