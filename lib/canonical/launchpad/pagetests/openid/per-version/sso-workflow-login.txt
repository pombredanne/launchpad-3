= Launchpad Single-Signon Workflow: Login =

A user with an existing account may log into a Launchpad-SSO web site
simply by entering their password on the login site.

First we will set up the helper view that lets us test the final
portion of the authentication process:

    >>> from openid.consumer.consumer import Consumer
    >>> from openid.fetchers import setDefaultFetcher
    >>> from openid.store.memstore import MemoryStore
    >>> from canonical.launchpad.ftests.openidhelpers import (
    ...     complete_from_browser, install_consumer,
    ...     make_identifier_select_endpoint, uninstall_consumer,
    ...     PublisherFetcher)
    >>> install_consumer()
    >>> setDefaultFetcher(PublisherFetcher())

The authentication process is started by the relying party issuing a
checkid_setup request, sending the user to Launchpad:

    >>> openid_store = MemoryStore()
    >>> consumer = Consumer(session={}, store=openid_store)

    >>> request = consumer.beginWithoutDiscovery(
    ...     make_identifier_select_endpoint(PROTOCOL_URI))
    >>> browser.open(request.redirectURL(
    ...     'http://launchpad.dev/', 'http://launchpad.dev/+openid-consumer'))

At this point, the user is presented with a login form:

    >>> print browser.title
    Launchpad Login Service

As the user already has an account, they can enter their email address
and password.  The user must enter a valid email address, or they will
receive an error:

    >>> browser.getControl(name='field.email').value = 'not an email address'
    >>> browser.getControl(name='field.password').value = 'test'
    >>> browser.getControl('Continue').click()

    >>> print browser.title
    Launchpad Login Service
    >>> for tag in find_tags_by_class(browser.contents, 'error'):
    ...     print extract_text(tag)
    Please enter a valid email address.

Leaving the email address field blank results in the same error:

    >>> browser.getControl(name='field.email').value = ''
    >>> browser.getControl(name='field.password').value = 'test'
    >>> browser.getControl('Continue').click()

    >>> print browser.title
    Launchpad Login Service
    >>> for tag in find_tags_by_class(browser.contents, 'error'):
    ...     print extract_text(tag)
    Please enter a valid email address.

If the user provides a non-ASCII password, they receive an incorrect
password error.

    >>> browser.getControl(name='field.email').value = 'mark@hbd.com'
    >>> browser.getControl(name='field.password').value = '\xc2\xa0blah'
    >>> browser.getControl('Continue').click()
    >>> print browser.title
    Launchpad Login Service
    >>> for tag in find_tags_by_class(browser.contents, 'error'):
    ...     print extract_text(tag)
    Incorrect password for the provided email address.

If the password does not match the given email address, an error is
shown:

    >>> browser.getControl(name='field.email').value = 'mark@hbd.com'
    >>> browser.getControl(name='field.password').value = 'not the password'
    >>> browser.getControl('Continue').click()
    >>> print browser.title
    Launchpad Login Service
    >>> for tag in find_tags_by_class(browser.contents, 'error'):
    ...     print extract_text(tag)
    Incorrect password for the provided email address.

Finally, if the email address and password match, the user is logged
in and returned to the relying party, with the user's identity URL:

    >>> browser.getControl(name='field.password').value = 'test'
    >>> browser.getControl('Continue').click()
    >>> print browser.url
    http://launchpad.dev/+openid-consumer?...
    >>> info = complete_from_browser(
    ...     consumer, browser, 'http://openid.launchpad.dev/+id/sabdfl_oid')
    >>> print info.status
    success
    >>> print info.endpoint.claimed_id
    http://openid.launchpad.dev/+id/sabdfl_oid


== Cleanup ==

    >>> setDefaultFetcher(None)
    >>> uninstall_consumer()

