= Using a mailing list as a team's contact address =

Mailing lists hosted by Launchpad can be used as the contact address of any
team in Launchpad.  When this feature is used, all notifications sent by
Launchpad to the team will be sent to the mailing list's address, in fact.

We'll now register and approve the mailing list we'll be using as the contact
address of our new team.  When the mailing lists are created, messages get
sent to the members of the team informing them of their new list.  We can
ignore these (there's only one, currently).

    >>> import itest_helper
    >>> list_one = itest_helper.create_list('itest-one')
    >>> from operator import itemgetter
    >>> for message in sorted(smtpd.getMessages(), key=itemgetter('sender')):
    ...     print message['subject']
    New Mailing List for Itest One
    >>> smtpd.reset()

Subscribe someone to the team and mailing list so that these messages can get
delivered.

    >>> from canonical.launchpad.ftests import login, logout
    >>> from canonical.launchpad.ftests.mailinglists_helper import new_person
    >>> from canonical.launchpad.interfaces import IPersonSet
    >>> from zope.component import getUtility
    >>> login('foo.bar@canonical.com')
    >>> person_set = getUtility(IPersonSet)
    >>> team_one = person_set.getByName('itest-one')

    # Subscribe Anne with her preferred address.
    >>> anne = new_person('Anne')
    >>> anne.join(team_one)
    >>> from canonical.launchpad.ftests import sync
    >>> sync(list_one)
    >>> list_one.subscribe(anne)
    >>> from canonical.database.sqlbase import commit
    >>> logout()
    >>> serial_watcher = itest_helper.LogWatcher('serial')
    >>> commit()
    >>> serial_watcher.wait()

It's possible to set the team as a project's answer contact.

    >>> browser = itest_helper.make_browser()
    >>> browser.open('http://launchpad.dev/~itest-one/+contactaddress')
    >>> browser.getControl('The Launchpad mailing list').selected = True
    >>> browser.getControl('Change').click()

    >>> browser.getLink('Change contact address').click()
    >>> browser.getControl(name='field.contact_method').displayValue
    ['\xa0The Launchpad mailing list for this team...]

    >>> browser.open('http://answers.launchpad.dev/firefox/+answer-contact')
    >>> browser.getControl(name='field.answer_contact_teams').displayValue = [
    ...     'Itest One']
    >>> browser.getControl('Continue').click()

When the contact address for the team is its mailing list, creating new
questions will email the mailing list.

    >>> smtp_watcher = itest_helper.LogWatcher('smtp')

    >>> browser.open('http://answers.launchpad.dev/firefox/+addquestion')
    >>> browser.getControl('Summary').value = 'A new question'
    >>> browser.getControl('Continue').click()
    >>> browser.getControl('Description').value = 'More detail.'
    >>> browser.getControl('Add').click()

There are now three messages in the mailbox.  One message goes to
no-priv@canonical.com because he added the question.  The other two are copies
of the same message which was posted to the mailing list.  We get two copies
because we're VERPing delivery (i.e. sending each recipient an individual
message marked with headers to track bounces).  One copy goes to Anne and the
other goes to the archive submission address.  The way to distinguish and sort
these messages is by the Sender header, which will be unique in all cases.

    >>> smtp_watcher.wait()
    >>> messages = smtpd.getMessages()
    >>> len(messages)
    3

Here is the message to the person who added the question.

    >>> print messages[0].as_string()
    Content-Type: text/plain; charset="utf-8"
    ...
    X-Launchpad-Question: product=firefox; status=Open; assignee=None;
      priority=Normal; language=en
    Reply-To: question...@answers.launchpad.net
    X-Launchpad-Message-Rationale: Subscriber
    To: no-priv@canonical.com
    From: No Privileges Person <question...@answers.launchpad.net>
    Subject: [Question #...]: A new question
    ...
    Sender: bounces@canonical.com
    Errors-To: bounces@canonical.com
    Return-Path: bounces@canonical.com
    Precedence: bulk
    X-Generated-By: Launchpad (canonical.com)
    Received: by smtp2mbox
    <BLANKLINE>
    New question #... on Mozilla Firefox:
    http://answers.launchpad.dev/firefox/+question/...
    <BLANKLINE>
    More detail.
    <BLANKLINE>
    -- =
    <BLANKLINE>
    You received this question notification because you are a direct
    subscriber of the question.
    <BLANKLINE>
    <BLANKLINE>

Here is the message to Anne, a member of the mailing list.

    >>> print messages[1].as_string()
    MIME-Version: 1.0
    X-Launchpad-Question: product=firefox; status=Open; assignee=None;
      priority=Normal; language=en
    X-Launchpad-Message-Rationale: Answer Contact (firefox) @itest-one
    To: itest-one@lists.launchpad.dev
    From: No Privileges Person <question...@answers.launchpad.net>
    ...
    Subject: [Itest-one] [Question #...]: A new question
    X-BeenThere: itest-one@lists.launchpad.dev
    X-Mailman-Version: ...
    Reply-To: question...@answers.launchpad.net
    List-Id: <itest-one.lists.launchpad.dev>
    List-Help: <http://help.launchpad.dev/ListHelp>
    List-Subscribe: <http://launchpad.dev/people/+me/+editemails>
    List-Unsubscribe: <http://launchpad.dev/people/+me/+editemails>
    List-Post: <mailto:itest-one@lists.launchpad.dev>
    List-Archive: <http://lists.launchpad.dev/itest-one>
    List-Owner: <http://launchpad.dev/~itest-one>
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    Sender: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Errors-To: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Received: by smtp2mbox
    <BLANKLINE>
    New question #... on Mozilla Firefox:
    http://answers.launchpad.dev/firefox/+question/...
    <BLANKLINE>
    More detail.
    <BLANKLINE>
    --
    You received this question notification because you are a member of
    Itest One, which is an answer contact for Mozilla Firefox.
    _______________________________________________
    Mailing list: http://launchpad.dev/~itest-one
    Post to     : itest-one@lists.launchpad.dev
    Unsubscribe : http://launchpad.dev/people/+me/+editemails
    More help   : http://help.launchpad.dev/ListHelp
    <BLANKLINE>
    <BLANKLINE>

Here is the message to the archive submission address.

    # This is mostly the same as the message to Anne, so we'll be succinct.
    >>> print messages[2].as_string()
    MIME-Version: 1.0
    ...
    Sender: itest-one-bounces+archive=mail-archive.com@lists.launchpad.dev
    Errors-To: itest-one-bounces+archive=mail-archive.com@lists.launchpad.dev
    ...
    <BLANKLINE>
    <BLANKLINE>

Similarly, if we subscribe our new team to a blueprint, a notification will be
sent to Anne and to the archive via the mailing list.

    # Reset the smtp server with a fresh mbox.
    >>> smtpd.reset()

    >>> browser.open(
    ...     'http://launchpad.dev/firefox/+spec/canvas/+addsubscriber')
    >>> browser.getControl('Subscriber').value = 'itest-one'
    >>> browser.getControl('Continue').click()

    >>> smtp_watcher.wait()
    >>> messages = smtpd.getMessages()
    >>> len(messages)
    2
    >>> messages.sort(key=itemgetter('sender'))

This one gets sent to Anne...

    >>> print messages[0].as_string()
    MIME-Version: 1.0
    To: itest-one@lists.launchpad.dev
    From: No Privileges Person <no-priv@canonical.com>
    ...
    Subject: [Itest-one] [Blueprint canvas] Support <canvas> Objects
    X-BeenThere: itest-one@lists.launchpad.dev
    ...
    Sender: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Errors-To: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Received: by smtp2mbox
    <BLANKLINE>
    You are now subscribed to the blueprint canvas - Support <canvas>
    Objects.
    <BLANKLINE>
    --
      http://blueprints.launchpad.dev/firefox/+spec/canvas
    _______________________________________________
    Mailing list: http://launchpad.dev/~itest-one
    Post to     : itest-one@lists.launchpad.dev
    Unsubscribe : http://launchpad.dev/people/+me/+editemails
    More help   : http://help.launchpad.dev/ListHelp
    <BLANKLINE>
    <BLANKLINE>

...and this one gets sent to the archives.

    >>> print messages[1].as_string()
    MIME-Version: 1.0
    To: itest-one@lists.launchpad.dev
    From: No Privileges Person <no-priv@canonical.com>
    ...
    Subject: [Itest-one] [Blueprint canvas] Support <canvas> Objects
    X-BeenThere: itest-one@lists.launchpad.dev
    ...
    Sender: itest-one-bounces+archive=mail-archive.com@lists.launchpad.dev
    Errors-To: itest-one-bounces+archive=mail-archive.com@lists.launchpad.dev
    Received: by smtp2mbox
    <BLANKLINE>
    You are now subscribed to the blueprint canvas - Support <canvas>
    Objects.
    <BLANKLINE>
    --
      http://blueprints.launchpad.dev/firefox/+spec/canvas
    _______________________________________________
    Mailing list: http://launchpad.dev/~itest-one
    Post to     : itest-one@lists.launchpad.dev
    Unsubscribe : http://launchpad.dev/people/+me/+editemails
    More help   : http://help.launchpad.dev/ListHelp
    <BLANKLINE>
    <BLANKLINE>

If we change the team's contact address to something other than the
launchpad-hosted mailing list, though, the notifications won't be sent to the
mailing list, they'll be sent to the team members individually.

    >>> browser.open('http://launchpad.dev/~itest-one/+contactaddress')
    >>> browser.getControl('Each member individually').selected = True
    >>> browser.getControl('Change').click()

    >>> browser.getLink('Change contact address').click()
    >>> browser.getControl(name='field.contact_method').displayValue
    ['\xa0Each member individually']

    # Reset the smtp server with a fresh mbox.
    >>> smtpd.reset()

    >>> browser.open('http://answers.launchpad.dev/firefox/+addquestion')
    >>> browser.getControl('Summary').value = 'Another question'
    >>> browser.getControl('Continue').click()
    >>> browser.getControl('Description').value = 'More detail.'
    >>> browser.getControl('Add').click()

    >>> smtp_watcher.wait()
    'Timed out'

There are now two messages in the mailbox.  One message goes to
no-priv@canonical.com because he added the question.  The other goes to Anne
as a member of the team, since the team's contact address is not set.  Nothing
is sent to the archive because the mailing list was not used.

    >>> messages = smtpd.getMessages()
    >>> len(messages)
    2

    # Because this doesn't go through the mailing list, the Sender header will
    # be the same for both, so sort on the To field instead.
    >>> messages.sort(key=itemgetter('to'), reverse=True)

This message goes to the submitter of the question.

    >>> print messages[0].as_string()
    Content-Type: text/plain; charset="utf-8"
    ...
    To: no-priv@canonical.com
    From: No Privileges Person <question...@answers.launchpad.net>
    Subject: [Question #...]: Another question
    ...
    <BLANKLINE>
    New question #... on Mozilla Firefox:
    http://answers.launchpad.dev/firefox/+question/...
    <BLANKLINE>
    More detail.
    <BLANKLINE>
    -- =
    <BLANKLINE>
    You received this question notification because you are a direct
    subscriber of the question.
    <BLANKLINE>
    <BLANKLINE>

This message goes to the team members individually, and Anne is the only team
member.

    >>> print messages[1].as_string()
    Content-Type: text/plain; charset="utf-8"
    ...
    Reply-To: question...@answers.launchpad.net
    X-Launchpad-Message-Rationale: Answer Contact (firefox) @itest-one
    To: anne.person@example.com
    From: No Privileges Person <question...@answers.launchpad.net>
    Subject: [Question #...]: Another question
    ...
    <BLANKLINE>
    New question #... on Mozilla Firefox:
    http://answers.launchpad.dev/firefox/+question/...
    <BLANKLINE>
    More detail.
    <BLANKLINE>
    -- =
    <BLANKLINE>
    You received this question notification because you are a member of
    Itest One, which is an answer contact for Mozilla Firefox.
    <BLANKLINE>
    <BLANKLINE>

When emails are sent directly to the mailing list address they're still
delivered since the mailing list is still active.

    # Reset the smtp server with a fresh mbox.
    >>> smtpd.reset()
    >>> from Mailman.Post import inject
    >>> inject('itest-one', """\
    ... From: %s
    ... To: itest-one@lists.launchpad.dev
    ... Subject: A member post
    ... Message-ID: <first-injection>
    ...
    ... Hi, I am a member of Launchpad.
    ... """ % anne.preferredemail.email)
    >>> smtp_watcher.wait()
    >>> messages = smtpd.getMessages()

Anne (as the only member of the mailing list) and the archive submission
address both get copies of the message.

    >>> len(messages)
    2
    >>> messages.sort(key=itemgetter('sender'))

    >>> print messages[0].as_string()
    From: anne.person@example.com
    To: itest-one@lists.launchpad.dev
    Message-ID: <first-injection>
    Subject: [Itest-one] A member post
    X-BeenThere: itest-one@lists.launchpad.dev
    ...
    Sender: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Errors-To: itest-one-bounces+anne.person=example.com@lists.launchpad.dev
    Received: by smtp2mbox
    <BLANKLINE>
    Hi, I am a member of Launchpad.
    _______________________________________________
    Mailing list: http://launchpad.dev/~itest-one
    Post to     : itest-one@lists.launchpad.dev
    Unsubscribe : http://launchpad.dev/people/+me/+editemails
    More help   : http://help.launchpad.dev/ListHelp
    <BLANKLINE>
    <BLANKLINE>

    >>> print messages[1].as_string()
    From: anne.person@example.com
    To: itest-one@lists.launchpad.dev
    Message-ID: <first-injection>
    Subject: [Itest-one] A member post
    X-BeenThere: itest-one@lists.launchpad.dev
    ...
    Sender: itest-one-bounces+archive=mail-archive.com@lists.launchpad.dev
    Errors-To: itest-one-bounces+archive=mail-archive.com@lists.launchpad.dev
    Received: by smtp2mbox
    <BLANKLINE>
    Hi, I am a member of Launchpad.
    _______________________________________________
    Mailing list: http://launchpad.dev/~itest-one
    Post to     : itest-one@lists.launchpad.dev
    Unsubscribe : http://launchpad.dev/people/+me/+editemails
    More help   : http://help.launchpad.dev/ListHelp
    <BLANKLINE>
    <BLANKLINE>
