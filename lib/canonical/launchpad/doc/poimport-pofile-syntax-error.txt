PO Import test with a .po file that has a syntax error
------------------------------------------------------

When we import a .po file with a syntax error, we should notify
the user about that error so they have a chance to fix it.

In this test, we are going to check that we detect and notify the error.

Here are some imports we need to get this test running.

  >>> from canonical.launchpad.interfaces import IPersonSet
  >>> from canonical.launchpad.interfaces import ITranslationImportQueue
  >>> from canonical.launchpad.database import POTemplateSubset
  >>> import datetime
  >>> import pytz
  >>> UTC = pytz.timezone('UTC')
  >>> translation_import_queue = getUtility(ITranslationImportQueue)

We need this for the Librarian to work properly.

  >>> import transaction

And also, the DBSchema to change the imports status

  >>> from canonical.launchpad.interfaces import RosettaImportStatus

Login as an admin to be able to do changes to the import queue.

  >>> login('carlos@canonical.com')

Here's the person who'll be doing the import.

  >>> person_set = getUtility(IPersonSet)
  >>> person = person_set.getByName('sabdfl')

Now, is time to create the new potemplate

  >>> from canonical.launchpad.database import ProductRelease
  >>> release = ProductRelease.get(3)
  >>> release.productseries.product.name
  u'firefox'
  >>> series = release.productseries
  >>> subset = POTemplateSubset(productseries=series)
  >>> potemplate = subset.new(
  ...     name='firefox',
  ...     translation_domain='firefox',
  ...     path='po/firefox.pot',
  ...     owner=person)

We create the POFile object where we are going to attach the .po file.

  >>> pofile = potemplate.newPOFile('cy')

Let's import a .po file that misses the '"' char after msgstr.
That's a syntax error.

  >>> pofile_contents = r'''
  ... msgid ""
  ... msgstr ""
  ... "PO-Revision-Date: 2005-06-03 20:41+0100\n"
  ... "Last-Translator: Foo <no-priv@canonical.com>\n"
  ... "Content-Type: text/plain; charset=UTF-8\n"
  ... "Plural-Forms: nplurals=4; plural=n==1) ? 0 : n==2 ? 1 : (n != 8 || n != 11) ? 2 : 3;\n"
  ... "X-Rosetta-Export-Date: %s\n"
  ...
  ... msgid "foo"
  ... msgstr blah"
  ... ''' % datetime.datetime.now(UTC).isoformat()
  >>> published = False
  >>> entry = translation_import_queue.addOrUpdateEntry(
  ...     pofile.path, pofile_contents, published, person,
  ...     productseries=series, potemplate=potemplate, pofile=pofile)
  >>> transaction.commit()

We must approve the entry to be able to import it.

  >>> entry.status = RosettaImportStatus.APPROVED

We do the import.

  >>> (subject, message) = pofile.importFromQueue(entry)

The status is now FAILED:

  >>> entry.status == RosettaImportStatus.FAILED
  True

And the code composed an email with the notification of the error.

  >>> subject
  u'Import problem - Welsh (cy) - firefox in Mozilla Firefox trunk'
  >>> print message
  Hello Mark Shuttleworth,
  <BLANKLINE>
  On ..., you uploaded a file with Welsh (cy) translations for firefox in
  Mozilla Firefox trunk to Launchpad.
  <BLANKLINE>
  We were unable to import the file because of errors in its format.
  <BLANKLINE>
  You can check your file for correct formatting with the 'msgfmt' command.
  Please fix any errors raised by msgfmt and upload the file again. If you
  check the file and you don't find any error in it, please look for an
  answer or file a question at https://answers.launchpad.net/rosetta/
  <BLANKLINE>
  For your convenience, you can get the file you uploaded at:
  http://localhost:58000/.../firefox-cy.po
  <BLANKLINE>
  Thank you,
  <BLANKLINE>
  The Launchpad team
  <BLANKLINE>
