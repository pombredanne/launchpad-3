= TranslationsOverview =

This class provides a basic overview of the Launchpad Translations component.
It includes data such as projects which have so far received the most
translations and provides an easy way to figure out which projects a certain
person has most translated for.

In order to make live updates to the KarmaCache table, we sometimes log
in here as testadmin.  In real life the updates would be performed by
cronscripts/foaf-update-karma-cache.py, but that would slow down this
test too much.

    >>> import transaction
    >>> from zope.component import getUtility
    >>> from canonical.database.sqlbase import flush_database_updates
    >>> from canonical.launchpad.database import (
    ...     KarmaCategory, SourcePackageName)
    >>> from canonical.launchpad.interfaces import (
    ...     IDistributionSet, IKarmaCacheManager, IPersonSet,
    ...     IProductSet, ITranslationsOverview)
    >>> from canonical.testing import LaunchpadZopelessLayer
    >>> karmacachemanager = getUtility(IKarmaCacheManager)
    >>> person_set = getUtility(IPersonSet)
    >>> product_set = getUtility(IProductSet)

    >>> overview = getUtility(ITranslationsOverview)

    >>> def start_karma_update():
    ...     """Prepare for update to karma cache."""
    ...     transaction.commit()
    ...     LaunchpadZopelessLayer.switchDbUser('testadmin')

    >>> def finish_karma_update():
    ...     """Return to normal after updating karma cache."""
    ...     transaction.commit()
    ...     LaunchpadZopelessLayer.switchDbUser('launchpad')

ITranslationOverview defines two constants regulating minimum and maximum
contribution weights.

    >>> overview.MINIMUM_SIZE
    10
    >>> overview.MAXIMUM_SIZE
    18

== _normalizeSizes ==

This private method accepts a list of tuples (object, size) and
normalizes `size` values into the range [MINIMUM_SIZE, MAXIMUM_SIZE].

    >>> test_list = [('one', 3), ('two', 0), ('three', 1)]
    >>> from zope.security.proxy import removeSecurityProxy
    >>> result = removeSecurityProxy(overview)._normalizeSizes(test_list, 0, 3)
    >>> for pillar in result:
    ...     print "%s: %d" % (pillar['pillar'], pillar['weight'])
    one: 18
    two: 10
    three: 13

== Getting the most translated pillars ==

Method getMostTranslatedPillars() returns a list of dicts listing
pillars with most translations karma so far, along with a relative
weight for each of the pillars in the range of [overview.MINIMUM_SIZE,
overview.MAXIMUM_SIZE].

    >>> def display_pillars(pillars):
    ...     for pillar in pillars:
    ...         print "%s: %d" % (
    ...             pillar['pillar'].displayname, pillar['weight'])
    >>> display_pillars(overview.getMostTranslatedPillars())
    Evolution: 14

Adding some translations karma attributed to Carlos will make
alsa-utils displayed among the top translated pillars as well.

    >>> carlos = person_set.getByName('carlos')
    >>> translations = KarmaCategory.byName('translations')
    >>> alsa_utils = product_set.getByName('alsa-utils')

    >>> start_karma_update()
    >>> cache_entry = karmacachemanager.new(
    ...     120, carlos.id, translations.id, product_id=alsa_utils.id)
    >>> finish_karma_update()

    >>> display_pillars(overview.getMostTranslatedPillars())
    alsa-utils: 10
    Evolution: 18

When karma is increased for alsa-utils, it will get more weight than
Evolution.

    >>> start_karma_update()
    >>> cache_entry = karmacachemanager.updateKarmaValue(
    ...     1020, carlos.id, translations.id, product_id=alsa_utils.id)
    >>> finish_karma_update()

    >>> display_pillars(overview.getMostTranslatedPillars())
    alsa-utils: 18
    Evolution: 10

Adding a little bit of karma to upstart will put it in the list as well.

    >>> start_karma_update()
    >>> upstart = product_set.getByName('upstart')
    >>> removeSecurityProxy(upstart).official_rosetta = True
    >>> cache_entry = karmacachemanager.new(
    ...     50, carlos.id, translations.id, product_id=upstart.id)
    >>> finish_karma_update()

    >>> display_pillars(overview.getMostTranslatedPillars())
    alsa-utils: 18
    Evolution: 13
    Upstart: 10

Distributions with a lot of translation contributions show in the same
list as well.

    >>> start_karma_update()
    >>> ubuntu = getUtility(IDistributionSet).getByName("ubuntu")
    >>> evolution_sourcepackagename = SourcePackageName.byName("evolution")
    >>> cache_entry = karmacachemanager.new(
    ...     5150, carlos.id, translations.id, distribution_id=ubuntu.id,
    ...     sourcepackagename_id=evolution_sourcepackagename.id)
    >>> finish_karma_update()
    >>> display_pillars(overview.getMostTranslatedPillars())
    alsa-utils: 15
    Evolution: 12
    Ubuntu: 18
    Upstart: 10

Changing the range of the contribution weights relative project weights will
automatically adjust as well.

    >>> removeSecurityProxy(overview).MINIMUM_SIZE = 20
    >>> removeSecurityProxy(overview).MAXIMUM_SIZE = 24
    >>> display_pillars(overview.getMostTranslatedPillars())
    alsa-utils: 23
    Evolution: 21
    Ubuntu: 24
    Upstart: 20

If we pass the `limit` parameter to getMostTranslatedPillars method,
we change the default maximum number of returned entries.

    >>> display_pillars(overview.getMostTranslatedPillars(3))
    alsa-utils: 22
    Evolution: 20
    Ubuntu: 24

