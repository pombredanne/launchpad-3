PO Export Request Browser Views
-------------------------------

  >>> from canonical.launchpad.ftests.harness import (
  ...     LaunchpadFunctionalTestSetup)
  >>> LaunchpadFunctionalTestSetup().setUp()

Check there are no requests in the database to start with.

  >>> from canonical.launchpad.database import POExportRequest
  >>> POExportRequest.select().count()
  0

Here's our user who's going to request some PO files.

  >>> login('carlos@canonical.com')

Here's the PO template they're going to request some files from.

  >>> from canonical.launchpad.database import POTemplate
  >>> potemplate = POTemplate.get(1)

Here's the request from the user.

  >>> from canonical.launchpad.webapp.servers import LaunchpadTestRequest
  >>> SERVER_URL = get_url(potemplate, '+export', 'translations')
  >>> form = {
  ...     'what': 'some',
  ...     'potemplate': True,
  ...     'es': True,
  ...     'format': 'PO'}
  >>> request = LaunchpadTestRequest(SERVER_URL=SERVER_URL, form=form)
  >>> request.method = 'POST'

And here's the view processing that request.

  >>> from zope.component import getView
  >>> potemplate_view = getView(potemplate, '+export', request)
  >>> potemplate_view.initialize()

Check that the request has been added to the DB.

  >>> for request in POExportRequest.select(
  ...         orderBy=['person', 'potemplate', 'pofile']):
  ...     things = [
  ...         request.person.displayname,
  ...         request.potemplate.potemplatename.name]
  ...     if request.pofile:
  ...         things.append(request.pofile.language.englishname)
  ...     print things
  [u'Carlos Perell\xf3 Mar\xedn', u'evolution-2.2', u'Spanish']
  [u'Carlos Perell\xf3 Mar\xedn', u'evolution-2.2']

Now forget that request happened.

  >>> LaunchpadFunctionalTestSetup().tearDown()
  >>> LaunchpadFunctionalTestSetup().setUp()

See, no requests!

  >>> POExportRequest.select().count()
  0

Request an empty potemplate (i.e. without any POTMsgSets).
https://launchpad.net/products/rosetta/+bug/68261

  >>> SERVER_URL = get_url(empty_potemplate, '+export', 'translations')
  >>> form = {
  ...     'what': 'some',
  ...     'potemplate': True,
  ...     'format': 'PO'}
  >>> request = LaunchpadTestRequest(SERVER_URL=SERVER_URL, form=form)
  >>> request.method = 'POST'
  >>> empty_potemplate = POTemplate.get(6)
  >>> broken_potemplate_view = getView(empty_potemplate, '+export', request)
  >>> broken_potemplate_view.initialize()

Check that the request has been added to the DB.

  >>> for request in POExportRequest.select(
  ...         orderBy=['person', 'potemplate', 'pofile']):
  ...     things = [
  ...         request.person.displayname,
  ...         request.potemplate.potemplatename.name]
  ...     if request.pofile:
  ...         things.append(request.pofile.language.englishname)
  ...     print things
  [u'Carlos Perell\xf3 Mar\xedn', u'evolution-2.2-test']

Now forget that request happened.

  >>> LaunchpadFunctionalTestSetup().tearDown()
  >>> LaunchpadFunctionalTestSetup().setUp()

The queue is now empty.

  >>> POExportRequest.select().count()
  0

Let's request a PO file instead this time.

  >>> from canonical.launchpad.database import POFile
  >>> pofile = POFile.get(1)

Here's our new request.

  >>> SERVER_URL = get_url(pofile, '+export', 'translations')
  >>> request = LaunchpadTestRequest(
  ...     SERVER_URL=SERVERL_URL, form={'format': 'PO'})
  >>> request.method = 'POST'

Here's that request getting processed.

  >>> from canonical.launchpad.browser.pofile import POExportView

  >>> pofile_view = getView(pofile, '+export', request)
  >>> pofile_view.initialize()

And there it is.

  >>> POExportRequest.select().count()
  1

  >>> LaunchpadFunctionalTestSetup().tearDown()

