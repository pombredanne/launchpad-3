= XMLRPC interface for holding messages =

Messages posted to Launchpad mailing lists can be held for team owner
approval, for any of several reasons.  See `message-hold.txt` for details.

When a message is held for approval, Mailman will send the message text to
Launchpad to be eventually displayed in Launchpad's u/i.

    >>> from canonical.launchpad.ftests.mailinglists_helper import (
    ...     new_person, new_team)
    >>> team_one, list_one = new_team('team-one', True)
    >>> anne = new_person('Anne')

    # We don't care about the email notifications sent when the mailing
    # list was created, and we don't want the notification to confuse
    # things later on in this test, so clear the queue.
    >>> from canonical.launchpad.tests import mail_helpers
    >>> ignore = mail_helpers.pop_notifications()

Anne posts a message to the Team One list, but because she is not a member of
the list, Mailman will hold the message for the team's administrators to
approve or reject.

    >>> from email import message_from_string
    >>> message_anne = message_from_string("""\
    ... From: anne.person@example.com
    ... To: team-one@lists.launchpad.dev
    ... Subject: A question
    ... Message-ID: <first-post>
    ... Date: Fri, 01 Aug 2000 01:08:59 -0000
    ...
    ... I have a question about this team.
    ... """)

    >>> from canonical.launchpad.ftests import login
    >>> login('foo.bar@canonical.com')
    >>> mailinglist_api.holdMessage('team-one', message_anne.as_string())
    True

    >>> import transaction
    >>> transaction.commit()

This message is now in Launchpad's librarian and accessible through the
IMessageApprovalSet interface.

    >>> from canonical.launchpad.interfaces import IMessageApprovalSet
    >>> message_set = getUtility(IMessageApprovalSet)
    >>> held_message_anne = message_set.getMessageByMessageID('<first-post>')
    >>> print held_message_anne.message_id
    <first-post>
    >>> print held_message_anne.posted_by.displayname
    Anne Person
    >>> held_message_anne.posted_message.open()
    >>> try:
    ...     print held_message_anne.posted_message.read()
    ... finally:
    ...     held_message_anne.posted_message.close()
    From: anne.person@example.com
    To: team-one@lists.launchpad.dev
    Subject: A question
    Message-ID: <first-post>
    Date: ...
    <BLANKLINE>
    I have a question about this team.
    <BLANKLINE>
    >>> held_message_anne.status
     <DBItem PostedMessageStatus.NEW, (0) New status>

A notification message is sent to every team administrator informing
them that there is a message waiting for their approval.

    >>> mail_helpers.print_emails()
    From: Team One <noreply@launchpad.net>
    To: no-priv@canonical.com
    Subject: New mailing list message requiring approval for Team One
    <BLANKLINE>
    Hello No Privileges Person,
    <BLANKLINE>
    Team One has a new message requiring your approval.
    <BLANKLINE>
        Subject: A question
        Author name: Anne Person
        Author url: http://launchpad.dev/~anne
        Date: 2000-08-01 01:08:59+00:00
        Message-ID: <first-post>
    <BLANKLINE>
    A message has been posted to the mailing list for your team, but this
    message requires your approval before it will be sent to the list
    members.  After reviewing the message, you may approve, discard or
    reject it.
    <BLANKLINE>
    To review all messages pending approval, visit:
    <BLANKLINE>
        http://launchpad.dev/~team-one/+mailinglist-moderate
    <BLANKLINE>
    Regards,
    The Launchpad team
    ----------------------------------------

There are no messages waiting to be handled by Mailman yet.

    >>> mailinglist_api.getMessageDispositions()
    {}

Anne's message is on-topic so the list administrator approves it.

    >>> held_message_anne.approve(team_one.teamowner)
    >>> from canonical.launchpad.ftests import syncUpdate
    >>> syncUpdate(held_message_anne)
    >>> held_message_anne.status
    <DBItem PostedMessageStatus.APPROVAL_PENDING, (20) Approval pending>

However, Bart also sends a message to the team, but this one is off-topic so
the list administrator rejects it.

    >>> bart = new_person('Bart')
    >>> message_bart = message_from_string("""\
    ... From: bart.person@example.com
    ... To: team-one@lists.launchpad.dev
    ... Subject: What do Python's eat?
    ... Message-ID: <second-post>
    ... Date: Fri, 01 Aug 2000 01:08:59 -0000
    ...
    ... My snake is hungry and doesn't like the crickets!
    ... """)

    >>> mailinglist_api.holdMessage('team-one', message_bart.as_string())
    True
    >>> held_message_bart = message_set.getMessageByMessageID('<second-post>')
    >>> held_message_bart.reject(team_one.teamowner)
    >>> syncUpdate(held_message_bart)
    >>> held_message_bart.status
    <DBItem PostedMessageStatus.REJECTION_PENDING, (30) Decline pending>

Cris sends spam to the mailing list, which is simply discarded.

    >>> cris = new_person('Cris')
    >>> message_cris = message_from_string("""\
    ... From: cris.person@example.com
    ... To: team-one@lists.launchpad.dev
    ... Subject: Snakes and Arrows
    ... Message-ID: <third-post>
    ... Date: Fri, 01 Aug 2000 01:08:59 -0000
    ...
    ... Would you like to buy some snakes or arrows?
    ... """)

    >>> mailinglist_api.holdMessage('team-one', message_cris.as_string())
    True
    >>> held_message_cris = message_set.getMessageByMessageID('<third-post>')
    >>> held_message_cris.discard(team_one.teamowner)
    >>> syncUpdate(held_message_cris)
    >>> held_message_cris.status
    <DBItem PostedMessageStatus.DISCARD_PENDING, (60) Discard pending>

Now there are three messages waiting for Mailman to handle.

    >>> waiting = mailinglist_api.getMessageDispositions()
    >>> for message_id in sorted(waiting):
    ...     list_name, action = waiting[message_id]
    ...     print message_id, list_name, action
    <first-post> team-one accept
    <second-post> team-one decline
    <third-post> team-one discard

Now that Mailman's received the dispositions, the messages have been
transitioned to their permanent states.

    >>> held_message_anne = message_set.getMessageByMessageID('<first-post>')
    >>> held_message_anne.status
    <DBItem PostedMessageStatus.APPROVED, (40) Approved>
    >>> held_message_bart = message_set.getMessageByMessageID('<second-post>')
    >>> held_message_bart.status
    <DBItem PostedMessageStatus.REJECTED, (50) Rejected>
    >>> held_message_cris = message_set.getMessageByMessageID('<third-post>')
    >>> held_message_cris.status
    <DBItem PostedMessageStatus.DISCARDED, (70) Discarded>
