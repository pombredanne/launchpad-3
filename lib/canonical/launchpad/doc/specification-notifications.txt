= Email Notifications for Specifications =

When a specification is edited, an email notification is sent out to
all the related people. We send out notifications only on certain
changed, this will change in the future though.

Changing the status:

    >>> from zope.component import getMultiAdapter
    >>> from canonical.launchpad.interfaces import IProductSet
    >>> from canonical.launchpad.webapp.servers import LaunchpadTestRequest

    >>> login('foo.bar@canonical.com')
    >>> firefox = getUtility(IProductSet).getByName('firefox')
    >>> svg_support = firefox.getSpecification('svg-support')
    >>> form = {
    ...     'UPDATE_SUBMIT': 'Change', 'field.definition_status': 'Drafting',
    ...     'field.implementation_status':
    ...         svg_support.implementation_status.title,
    ...     }
    >>> request = LaunchpadTestRequest(form=form)
    >>> edit_view = getMultiAdapter((svg_support, request), name='+status')
    >>> edit_view.update()
    u'Updated...'

    >>> import transaction
    >>> from canonical.launchpad.mail import stub
    >>> transaction.commit()
    >>> len(stub.test_emails)
    7

The notification was sent to the registrant, Foo Bar, the assignee, Carlos,
the approver, Cprov, and the drafter, Robert.

    >>> related_people = [
    ...     svg_support.owner, svg_support.assignee, svg_support.drafter, svg_support.approver]
    >>> related_people += [
    ...     subscription.person for subscription in svg_support.subscriptions]
    >>> related_people_addresses = [
    ...     [person.preferredemail.email] for person in set(related_people)]
    >>> for addr in sorted(related_people_addresses): print addr
    [u'andrew.bennetts@ubuntulinux.com']
    [u'carlos@canonical.com']
    [u'celso.providelo@canonical.com']
    [u'daf@canonical.com']
    [u'foo.bar@canonical.com']
    [u'robertc@robertcollins.net']
    [u'stuart.bishop@canonical.com']

    >>> sent_addresses = sorted(
    ...     [to_addrs for from_addr, to_addrs, message in stub.test_emails])
    >>> sent_addresses == sorted(related_people_addresses)
    True

The approver and all subscribers also get notified, but since the
approver was cprov, and the only subscriber was Foo Bar, no additional
notifications were sent.

    >>> svg_support.approver is None
    False

    >>> for subscription in svg_support.subscriptions:
    ...     print subscription.person.preferredemail.email
    foo.bar@canonical.com
    robertc@robertcollins.net
    andrew.bennetts@ubuntulinux.com
    stuart.bishop@canonical.com
    daf@canonical.com

Let's set a different approver and add a subscriber.

    >>> from canonical.launchpad.interfaces import IPersonSet
    >>> sabdfl = getUtility(IPersonSet).getByEmail('mark@hbd.com')
    >>> sample_person = getUtility(IPersonSet).getByEmail('test@canonical.com')
    >>> svg_support.approver = sabdfl
    >>> svg_support.subscribe(sample_person, sample_person, False)
    <...>

Now if we edit the status, a notification will be sent to all the
previous people, and to the approver and the added subscriber:

    >>> stub.test_emails = []
    >>> form = {
    ...     'UPDATE_SUBMIT': 'Change',
    ...     'field.definition_status': 'Pending Approval',
    ...     'field.implementation_status':
    ...         svg_support.implementation_status.title,
    ...     'field.needs_discussion': '1'}
    >>> request = LaunchpadTestRequest(form=form)
    >>> edit_view = getMultiAdapter((svg_support, request), name='+status')
    >>> edit_view.update()
    u'Updated...'
    >>> transaction.commit()

The added subscriber will also receive a notification that they
are now subscribed.

    >>> x = sorted([toaddrs for fromaddr, toaddrs, message in stub.test_emails])
    >>> for addr in x: print addr
    ['andrew.bennetts@ubuntulinux.com']
    ['carlos@canonical.com']
    ['daf@canonical.com']
    ['foo.bar@canonical.com']
    ['mark@hbd.com']
    ['robertc@robertcollins.net']
    ['stuart.bishop@canonical.com']
    ['test@canonical.com']
    ['test@canonical.com']

Now let's take a look at what the notification looks like:

    >>> import email
    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)]
    >>> status_notification = notifications[0]
    >>> status_notification['To']
    'andrew.bennetts@ubuntulinux.com'
    >>> status_notification['From']
    'Foo Bar <foo.bar@canonical.com>'
    >>> status_notification['Subject']
    '[Blueprint svg-support] Support Native SVG Objects'
    >>> body = status_notification.get_payload(decode=True)
    >>> print body  #doctest: -NORMALIZE_WHITESPACE
    Blueprint changed by Foo Bar:
    <BLANKLINE>
        Definition Status: Drafting => Pending Approval
    <BLANKLINE>
    -- 
      Support Native SVG Objects
      http://blueprints.launchpad.dev/firefox/+spec/svg-support
    <BLANKLINE>

Whiteboard change:

    >>> stub.test_emails = []
    >>> new_whiteboard = (
    ...     "This is a long line, which will be wrapped in the email,"
    ...     " since it's longer than 72 characters.\n"
    ...     "\n"
    ...     "Another paragraph")
    >>> form = {
    ...     'UPDATE_SUBMIT': 'Change',
    ...     'field.definition_status': 'Pending Approval',
    ...     'field.implementation_status':
    ...         svg_support.implementation_status.title,
    ...     'field.whiteboard': new_whiteboard}
    >>> request = LaunchpadTestRequest(form=form)
    >>> edit_view = getMultiAdapter((svg_support, request), name='+status')
    >>> edit_view.update()
    u'Updated...'
    >>> transaction.commit()

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)]
    >>> status_notification = notifications[0]
    >>> status_notification['To']
    'andrew.bennetts@ubuntulinux.com'
    >>> status_notification['From']
    'Foo Bar <foo.bar@canonical.com>'
    >>> status_notification['Subject']
    '[Blueprint svg-support] Support Native SVG Objects'
    >>> body = status_notification.get_payload(decode=True)
    >>> print body  #doctest: -NORMALIZE_WHITESPACE
    Blueprint changed by Foo Bar:
    <BLANKLINE>
    Whiteboard changed to:
    <BLANKLINE>
    This is a long line, which will be wrapped in the email, since it's
    longer than 72 characters.
    <BLANKLINE>
    Another paragraph
    <BLANKLINE>
    -- 
      Support Native SVG Objects
      http://blueprints.launchpad.dev/firefox/+spec/svg-support
    <BLANKLINE>


Definition status and whiteboard change:

    >>> stub.test_emails = []
    >>> form = {
    ...     'UPDATE_SUBMIT': 'Change',
    ...     'field.definition_status': 'Approved',
    ...     'field.implementation_status':
    ...         svg_support.implementation_status.title,
    ...     'field.whiteboard': 'Excellent work.'}
    >>> request = LaunchpadTestRequest(form=form)
    >>> edit_view = getMultiAdapter((svg_support, request), name='+status')
    >>> edit_view.update()
    u'Updated...'
    >>> transaction.commit()

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)]
    >>> status_notification = notifications[0]
    >>> status_notification['To']
    'andrew.bennetts@ubuntulinux.com'
    >>> status_notification['From']
    'Foo Bar <foo.bar@canonical.com>'
    >>> status_notification['Subject']
    '[Blueprint svg-support] Support Native SVG Objects'
    >>> body = status_notification.get_payload(decode=True)
    >>> print body  #doctest: -NORMALIZE_WHITESPACE
    Blueprint changed by Foo Bar:
    <BLANKLINE>
        Definition Status: Pending Approval => Approved
    <BLANKLINE>
    Whiteboard changed to:
    <BLANKLINE>
    Excellent work.
    <BLANKLINE>
    -- 
      Support Native SVG Objects
      http://blueprints.launchpad.dev/firefox/+spec/svg-support
    <BLANKLINE>

Change priority:

    >>> stub.test_emails = []
    >>> form = {
    ...     'UPDATE_SUBMIT': 'Change', 'field.priority': 'Essential',
    ...     'field.direction_approved': 'on',
    ...     'field.whiteboard': svg_support.whiteboard}
    >>> request = LaunchpadTestRequest(form=form)
    >>> edit_view = getMultiAdapter((svg_support, request), name='+priority')
    >>> edit_view.update()
    u'Updated...'
    >>> transaction.commit()

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)]
    >>> status_notification = notifications[0]
    >>> status_notification['To']
    'andrew.bennetts@ubuntulinux.com'
    >>> status_notification['From']
    'Foo Bar <foo.bar@canonical.com>'
    >>> status_notification['Subject']
    '[Blueprint svg-support] Support Native SVG Objects'
    >>> body = status_notification.get_payload(decode=True)
    >>> print body  #doctest: -NORMALIZE_WHITESPACE
    Blueprint changed by Foo Bar:
    <BLANKLINE>
        Priority: High => Essential
    <BLANKLINE>
    -- 
      Support Native SVG Objects
      http://blueprints.launchpad.dev/firefox/+spec/svg-support
    <BLANKLINE>

Change approver, assignee and drafter:

    >>> svg_support.assignee = None

    >>> stub.test_emails = []
    >>> form = {
    ...     'UPDATE_SUBMIT': 'Change', 'field.assignee': 'sabdfl',
    ...     'field.approver': '', 'field.drafter': 'foo.bar@canonical.com'}
    >>> request = LaunchpadTestRequest(form=form)
    >>> edit_view = getMultiAdapter((svg_support, request), name='+people')
    >>> edit_view.update()
    u'Updated...'
    >>> transaction.commit()

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)]
    >>> status_notification = notifications[0]
    >>> status_notification['To']
    'andrew.bennetts@ubuntulinux.com'
    >>> status_notification['From']
    'Foo Bar <foo.bar@canonical.com>'
    >>> status_notification['Subject']
    '[Blueprint svg-support] Support Native SVG Objects'
    >>> body = status_notification.get_payload(decode=True)
    >>> print body  #doctest: -NORMALIZE_WHITESPACE
    Blueprint changed by Foo Bar:
    <BLANKLINE>
        Approver: Mark Shuttleworth => (none)
        Assignee: (none) => Mark Shuttleworth
        Drafter: Robert Collins => Foo Bar
    <BLANKLINE>
    -- 
      Support Native SVG Objects
      http://blueprints.launchpad.dev/firefox/+spec/svg-support
    <BLANKLINE>

If we do a change, which we don't yet support sending a notification
about, no notification is sent:

    >>> stub.test_emails = []
    >>> form = {
    ...     'FORM_SUBMIT': 'Continue', 'field.productseries': '1',
    ...     'field.whiteboard': 'Proposing for milestones...'}
    >>> request = LaunchpadTestRequest(form=form)
    >>> edit_view = getMultiAdapter(
    ...     (svg_support, request), name='+setproductseries')
    >>> edit_view.update()
    'Done.'
    >>> transaction.commit()
    >>> len(stub.test_emails)
    0
