= Distribution Source Packages =

A distribution source package represents a named source package in a
distribution, independant of any particular release of that source
package.

This is useful for, among other things, tracking bugs in source
packages, ensuring that bug reports automatically carry forward from one
distribution series to the next.

== Fetching a Distribution Source Package ==

A common way to fetch a distribution source package is to start with the
distribution object:

    >>> from zope.component import getUtility
    >>> from canonical.launchpad.webapp.testing import verifyObject
    >>> from canonical.launchpad.interfaces import (
    ...     IDistributionSet, IDistributionSourcePackage)
    >>> debian = getUtility(IDistributionSet).getByName("debian")
    >>> ubuntu = getUtility(IDistributionSet).getByName("ubuntu")

Use IDistribution.getSourcePackage to get a specific package by name:

    >>> debian_firefox = debian.getSourcePackage("mozilla-firefox")
    >>> debian_firefox.name
    u'mozilla-firefox'
    >>> IDistributionSourcePackage.providedBy(debian_firefox)
    True
    >>> verifyObject(IDistributionSourcePackage, debian_firefox)
    True

== Useful features ==

    >>> dsp = ubuntu.getSourcePackage("pmount")
    >>> dsp.displayname
    u'pmount in ubuntu'
    >>> dsp.bugtasks().count()
    0

=== Publishing-related properties ===

Publishing history of 'pmount in Ubuntu':

    >>> for p in dsp.publishing_history:
    ...     print " ".join((p.sourcepackagerelease.name,
    ...                     p.sourcepackagerelease.version,
    ...                     p.distroseries.name))
    pmount 0.1-2 hoary
    pmount 0.1-1 hoary

Current publishing records for 'pmount in Ubuntu':

    >>> for p in dsp.current_publishing_records:
    ...     print " ".join((p.sourcepackagerelease.name,
    ...                     p.sourcepackagerelease.version,
    ...                     p.distroseries.name))
    pmount 0.1-2 hoary

Current overall publications:

    >>> alsa_utils = ubuntu.getSourcePackage("alsa-utils")
    >>> pub = alsa_utils.latest_overall_publication
    >>> (pub.sourcepackagerelease.sourcepackagename.name,
    ...  pub.sourcepackagerelease.version,
    ...  pub.distroseries.name,
    ...  pub.status)
    (u'alsa-utils',
     u'1.0.9a-4ubuntu1',
     u'hoary',
     <DBItem PackagePublishingStatus.PUBLISHED, (2) Published>)
    >>> linux_source = ubuntu.getSourcePackage("linux-source-2.6.15")
    >>> pub = linux_source.latest_overall_publication
    >>> (pub.sourcepackagerelease.sourcepackagename.name,
    ...  pub.sourcepackagerelease.version,
    ...  pub.distroseries.name,
    ...  pub.status)
    (u'linux-source-2.6.15',
     u'2.6.15.3',
     u'hoary',
     <DBItem PackagePublishingStatus.PUBLISHED, (2) Published>)
    >>> commercial = ubuntu.getSourcePackage("commercialpackage")
    >>> pub = linux_source.latest_overall_publication
    >>> (pub.sourcepackagerelease.sourcepackagename.name,
    ...  pub.sourcepackagerelease.version,
    ...  pub.distroseries.name,
    ...  pub.status)
    (u'linux-source-2.6.15',
     u'2.6.15.3',
     u'hoary',
     <DBItem PackagePublishingStatus.PUBLISHED, (2) Published>)

=== Release-related properties ===

Releases of 'pmount in Ubuntu':

    >>> [release.version for release in dsp.releases]
    [u'0.1-2', u'0.1-1']

Binary packages of 'pmount in Ubuntu':

    >>> dsp.binary_package_names
    u'pmount'

Current release of 'pmount in Ubuntu':

    >>> dsp.currentrelease.version
    u'0.1-2'

Check if 'currentrelease' works with version containing letters
(bug # 6040):

    >>> dsp2 = ubuntu.getSourcePackage("alsa-utils")
    >>> dsp2.currentrelease.version
    u'1.0.9a-4ubuntu1'

    >>> dsp3 = ubuntu.getSourcePackage("cnews")
    >>> dsp3.currentrelease.version
    u'cr.g7-37'

=== Grabbing DSPRs ===

To list the current 'pmount in Ubuntu' ISourcePackages, use
get_distroseries_packages():

    >>> [(sp.name, sp.distroseries.name)
    ...     for sp in dsp.get_distroseries_packages()]
    [(u'pmount', u'hoary')]

To retrieve a version of 'pmount in Ubuntu' as an
IDistributionSourcePackageRelease (IDSPR) or None if not found, use
getVersion():

    >>> dsp.getVersion('1.0') is None
    True

    >>> pmount_dspr = dsp.getVersion('0.1-1')
    >>> pmount_dspr.title
    u'pmount 0.1-1 (source) in Ubuntu'

    >>> for pub in pmount_dspr.publishing_history:
    ...     print pub.distroseries.name, pub.status.name
    hoary SUPERSEDED

'getVersion' also returns IDSPRs for REMOVED versions which allows
developers to investigate history of files already removed from the
archive (bug #60440):

    >>> ubuntutest = getUtility(IDistributionSet)["ubuntutest"]
    >>> alsa_dsp = ubuntutest.getSourcePackage("alsa-utils")
    >>> alsa_dspr = alsa_dsp.getVersion('1.0.9a-4')
    >>> alsa_dspr.title
    u'alsa-utils 1.0.9a-4 (source) in ubuntutest'

    >>> for pub in alsa_dspr.publishing_history:
    ...     is_removed = pub.dateremoved is not None
    ...     print pub.distroseries.name, pub.status.name, is_removed
    breezy-autotest DELETED True


== __hash__ ==

DistributionSourcePackage defines a custom __hash__ method, so that
different instances, representing the same packages, have the same hash.

    >>> pmount = ubuntu.getSourcePackage('pmount')
    >>> pmount_again = ubuntu.getSourcePackage('pmount')
    >>> pmount is pmount_again
    False
    >>> hash(pmount) == hash(pmount_again)
    True
    >>> pmount == pmount_again
    True

This means that packages can be used as keys in dictionaries.

    >>> pmount_marker = object()
    >>> firefox_marker = object()
    >>> mapping = {
    ...     pmount: pmount_marker,
    ...     ubuntu.getSourcePackage('mozilla-firefox'): firefox_marker,
    ...     }
    >>> mapping[pmount_again] is pmount_marker
    True
    >>> mapping[ubuntu.getSourcePackage('mozilla-firefox')] is firefox_marker
    True
