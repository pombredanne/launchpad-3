= Upstream Bug reports =

For a distribution's bug tracking process to be successful, it's vital
that it is able to communicate upstream bugs to the relevant upstream
project and monitor them as they change. Launchpad offers functionality
to allow a distribution to focus on and improve this process.


    >>> from canonical.launchpad.ftests import login
    >>> from canonical.launchpad.ftests.bug import (
    ...     create_bug_from_strings)
    >>> from canonical.launchpad.ftests import sync
    >>> from canonical.launchpad.interfaces import (
    ...     ISourcePackageNameSet, IDistributionSet, IProductSet,
    ...     IPackagingUtil, IPersonSet, PackagingType, IBugTaskSet,
    ...     IBugWatchSet, BugTaskStatus)

    >>> distroset = getUtility(IDistributionSet)
    >>> ubuntu = distroset.getByName('ubuntu')
    >>> debian = distroset.getByName('debian')
    >>> kubuntu = distroset.getByName('kubuntu')


== The API ==

IDistribution has a special API that allows you to assemble data for a
bug report that associates packages with upstream information linked to
them.

    >>> def print_report(data):
    ...     for dsp, product, open, triaged, upstream, watch in data:
    ...         print dsp.name, product and product.name or None
    ...         print open, triaged, upstream, watch

A first set of reports, entirely based on sampledata. There are no
triaged bugs, but there are some upstream ones with watches:

    >>> print_report(ubuntu.getPackagesAndPublicUpstreamBugCounts())
    linux-source-2.6.15 None    1 0 0 0
    mozilla-firefox     firefox 1 0 1 1
    thunderbird         None    1 0 1 1

    >>> print_report(debian.getPackagesAndPublicUpstreamBugCounts())
    mozilla-firefox     None    3 0 2 1

    >>> print_report(kubuntu.getPackagesAndPublicUpstreamBugCounts())

If we triage a bugtask on firefox and thunderbird we'll see the count
for triaged bugs updated:

    >>> login('foo.bar@canonical.com')
    >>> sabdfl = getUtility(IPersonSet).getByName('sabdfl')
    >>> ls_bug = getUtility(IBugTaskSet).get(23)
    >>> ls_bug.transitionToStatus(BugTaskStatus.TRIAGED, sabdfl)
    >>> sync(ls_bug)
    >>> mf_bug = getUtility(IBugTaskSet).get(17)
    >>> mf_bug.transitionToStatus(BugTaskStatus.TRIAGED, sabdfl)
    >>> sync(mf_bug)
    >>> print_report(ubuntu.getPackagesAndPublicUpstreamBugCounts())
    linux-source-2.6.15 None    1 0 0 0
    mozilla-firefox     firefox 1 1 1 1
    thunderbird         None    1 1 1 1

We add two new bugs to pmount in Ubuntu. From now on we'll limit the
results to 3 packages (as a demonstration of the API) so thunderbird will be
popped off the list:

    >>> bug = create_bug_from_strings(distribution='ubuntu',
    ...     sourcepackagename='pmount', owner='name12', 
    ...     summary='pmount used to work', description='fix it',
    ...     status=BugTaskStatus.TRIAGED)
    >>> bug = create_bug_from_strings(distribution='ubuntu',
    ...     sourcepackagename='pmount', owner='name12',
    ...     summary='pmount has issues', description='fix it again',
    ...     status=BugTaskStatus.TRIAGED)
    >>> ubuntu_pmount_task = bug.bugtasks[0]
    >>> print_report(ubuntu.getPackagesAndPublicUpstreamBugCounts(limit=3))
    pmount              None    2 2 0 0
    linux-source-2.6.15 None    1 0 0 0
    mozilla-firefox     firefox 1 1 1 1

As you can see, there is no packaging data for pmount in Ubuntu, so no
upstream is reported for it. Let's fix that:

    >>> pmount_spn = getUtility(ISourcePackageNameSet).queryByName('pmount')
    >>> name12 = getUtility(IPersonSet).getByName('name12')
    >>> pmount = getUtility(IProductSet).createProduct(
    ...     name12, 'pmount', 'pmount', 'pmount', 'pmount')
    >>> getUtility(IPackagingUtil).createPackaging(
    ...     pmount.getSeries('trunk'), pmount_spn,
    ...     ubuntu.currentseries, PackagingType.PRIME, name12)
    >>> print_report(ubuntu.getPackagesAndPublicUpstreamBugCounts(limit=3))
    pmount              pmount  2 2 0 0
    linux-source-2.6.15 None    1 0 0 0
    mozilla-firefox     firefox 1 1 1 1

We then add an upstream task to the second pmount bug:

    >>> from storm.store import Store
    >>> task = getUtility(IBugTaskSet).createTask(bug, name12, product=pmount)
    >>> Store.of(task).flush()
    >>> print_report(ubuntu.getPackagesAndPublicUpstreamBugCounts(limit=3))
    pmount              pmount  2 2 1 0
    linux-source-2.6.15 None    1 0 0 0
    mozilla-firefox     firefox 1 1 1 1

Linking that task to a bugwatch makes the watch counts update:

    >>> url = "http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=666"
    >>> [watch] = getUtility(IBugWatchSet).fromText(url, bug, name12)
    >>> task.bugwatch = watch
    >>> sync(task)
    >>> print_report(ubuntu.getPackagesAndPublicUpstreamBugCounts(limit=3))
    pmount              pmount  2 2 1 1
    linux-source-2.6.15 None    1 0 0 0
    mozilla-firefox     firefox 1 1 1 1


== Properties of BugReportData ==

The API listed above is based around BugReportData instances, each of
which offers a set of properties that can be used to accessed data. Each
row in the upstream report table is represented by an instance of
PackageBugReportData, which sublcassess BugReportData. We'll create a
BugReportData instance using some made up figures to demonstrate the
properties offered by BugReportData.

    >>> import canonical.launchpad.browser as browser
    >>> bug_data = browser.distribution_upstream_bug_report.BugReportData(
    ...     open_bugs=90, triaged_bugs=50, upstream_bugs=70,
    ...     watched_bugs=60)


=== Percentages ===

BugReportData offers a set of *_percentage properties.

BugReportData.triaged_bugs_percentage is the percentage of open bugs
that have been triaged.

    >>> bug_data.triaged_bugs_percentage
    55.555555555555557

BugReportData.upstream_bugs_percentage is the percentage of open bugs
that have been forwarded upstream.

    >>> bug_data.upstream_bugs_percentage
    77.777777777777771

BugReportData.watched_bugs_percentage is the percentage of bugs
forwarded upstream that have a bug watch against a remote bug.

    >>> bug_data.watched_bugs_percentage
    85.714285714285708


=== Deltas ===

BugReportData also offers a set of of *_delta properties along with the
*_percentage properties.

BugReportData.triaged_bugs_delta is the difference between the number of
open bugs and the number of triaged bugs.

    >>> bug_data.triaged_bugs_delta
    40

BugReportData.upstream bugs_delta is the difference between the number of
open bugs and the number of bugs forwarded upstream.

    >>> bug_data.upstream_bugs_delta
    20

BugReportData.watched_bugs_delta is the difference between the number of
upstream bugs and the number of bugs that have a bug watch against an
upstream bug.

    >>> bug_data.watched_bugs_delta
    10


=== Classes ===

Finally, BugReportData offers a set of *_class properties. These
provide the correct CSS class to use for rendering the data in a table.
They return 'good' if the property that they represent is above a
certain threshold or an empty string if not.

BugReportData.triaged_bugs_class returns 'good' if the
triaged_bugs_percentage is greater than BugReportData.TRIAGED_THRESHOLD.

    >>> bug_data.TRIAGED_THRESHOLD
    75

    >>> bug_data.triaged_bugs_class
    ''

Increasing the number of triaged bugs will put the percentage over the
threshold and so triaged_bugs_class will be 'good'.

    >>> bug_data.triaged_bugs = 70
    >>> bug_data.triaged_bugs_class
    'good'

BugReportData.upstream_bugs_class returns 'good' if the percentage of
open bugs forwarded upstream is higher than
BugReportData.UPSTREAM_THRESHOLD.

    >>> bug_data.UPSTREAM_THRESHOLD
    90

    >>> bug_data.upstream_bugs_class
    ''

Increasing the number of upstream bugs will put the percentage over the
threshold and make upstream_bugs_class 'good'.

    >>> bug_data.upstream_bugs = 85
    >>> bug_data.upstream_bugs_class
    'good'

BugReportData.watched_bugs_class returns 'good' if the percentage of
upstream bugs that have a bug watch is greater than
BugReportData.WATCH_THRESHOLD.

    >>> bug_data.WATCH_THRESHOLD
    90

    >>> bug_data.watched_bugs_class
    ''

Increasing the number of watched bugs will put the percentage over the
threshold and make watched_bugs_class 'good'.

    >>> bug_data.watched_bugs = 80
    >>> bug_data.watched_bugs_class
    'good'


== The view ==

We test that the view data is constructed sanely and without any hidden
defects. Let's set up some helpers to make it easier for us to output
them:

    >>> from zope.component import getMultiAdapter
    >>> from canonical.launchpad.webapp.servers import LaunchpadTestRequest

    >>> def create_view(distro):
    ...     request = LaunchpadTestRequest()
    ...     view = getMultiAdapter((distro, request), name='+upstreamreport')
    ...     return view

    >>> def print_numbers(data):
    ...     for f in ['open_bugs',
    ...               'triaged_bugs',
    ...               'upstream_bugs',
    ...               'watched_bugs',
    ...               'triaged_bugs_percentage',
    ...               'upstream_bugs_percentage',
    ...               'watched_bugs_percentage',
    ...               'triaged_bugs_class',
    ...               'upstream_bugs_class',
    ...               'watched_bugs_class',
    ...               'triaged_bugs_delta',
    ...               'upstream_bugs_delta',
    ...               'watched_bugs_delta']:
    ...         print getattr(data, f),

    >>> def print_helpers(data):
    ...     print data.dsp.name, data.dsp.distribution.name,
    ...     if data.dssp:
    ...         print data.dssp.distroseries.name
    ...     else:
    ...         print "NO SERIES"
    ...     if data.product:
    ...         print data.product.name
    ...     else:
    ...         print "NO PRODUCT"
    ...     for f in ['bug_supervisor_url', 'product_edit_url',
    ...               'upstream_bugs_url', 'upstream_bugs_delta_url',
    ...               'watched_bugs_delta_url']:
    ...         t = getattr(data, f, "NO URL")
    ...         print t.replace(
    ...             "http://bugs.launchpad.dev/ubuntu/+source/", "**")
    ...     print "--"

Get an Ubuntu view:

    >>> view = create_view(ubuntu)
    >>> view.initialize()

Here are the helper URLs we construct:

    >>> for item in view.data:
    ...     print_helpers(item)
    pmount ubuntu hoary
    pmount
    http://launchpad.dev/pmount/+bugsupervisor
    http://launchpad.dev/pmount/+edit
    **pmount/+bugs?search=Search&field.status_upstream=open_upstream
    **pmount/+bugs?search=Search&field.status_upstream=hide_upstream
    **pmount/+bugs?search=Search&field.status_upstream=pending_bugwatch
    --
    linux-source-2.6.15 ubuntu hoary
    NO PRODUCT
    NO URL
    NO URL
    **linux-source-2.6.15/+bugs?search=Search&field.status_upstream=open_upstream
    **linux-source-2.6.15/+bugs?search=Search&field.status_upstream=hide_upstream
    **linux-source-2.6.15/+bugs?search=Search&field.status_upstream=pending_bugwatch
    --
    mozilla-firefox ubuntu hoary
    firefox
    http://launchpad.dev/firefox/+bugsupervisor
    http://launchpad.dev/firefox/+edit
    **mozilla-firefox/+bugs?search=Search&field.status_upstream=open_upstream
    **mozilla-firefox/+bugs?search=Search&field.status_upstream=hide_upstream
    **mozilla-firefox/+bugs?search=Search&field.status_upstream=pending_bugwatch
    --
    thunderbird ubuntu hoary
    NO PRODUCT
    NO URL
    NO URL
    **thunderbird/+bugs?search=Search&field.status_upstream=open_upstream
    **thunderbird/+bugs?search=Search&field.status_upstream=hide_upstream
    **thunderbird/+bugs?search=Search&field.status_upstream=pending_bugwatch
    --

Let's print out the counts and percentages:

    >>> for item in view.data:
    ...     print_numbers(item)
    ...     print
    2   2   1   1 100.0   50.0   100.0  good good      0  1  0
    1   0   0   0   0.0    0.0     0.0                 1  1  0
    1   1   1   1 100.0  100.0   100.0  good good good 0  0  0
    1   1   1   1 100.0  100.0   100.0  good good good 0  0  0

And the total line:

    >>> print_numbers(view.total)
    5   4   3   3  80.0   60.0   100.0  good       good 1  2  0

A Kubuntu view is not nearly as interesting, though:

    >>> view = create_view(kubuntu)
    >>> view.initialize()
    >>> for item in view.data:
    ...     print_helpers(item)

    >>> for item in view.data:
    ...     print_numbers(item)

Nada!

    >>> print_numbers(view.total)
    0   0   0   0   0.0    0.0   0.0            0  0  0

PS: This page is actually browser-tested in
pagetests.distribution-upstream-bug-report. Look there for more details.

