======================
Logging into Launchpad
======================

Launchpad is an OpenID Relying Party that uses the Login Service as its fixed
OpenID Provider. Because of that, when a user clicks the 'Log in / Register'
link, they'll be sent to the OP to authenticate.

    # Set handleErrors to True so that the Unauthorized exception is handled
    # by the publisher and we get redirected to the +login page.
    >>> browser = Browser()
    >>> browser.handleErrors = True
    >>> browser.open(
    ...     'http://launchpad.dev:8085/people/?name=foo&searchfor=all')
    >>> browser.getLink('Log in / Register').click()

    # On a browser with JS support, this page would've been automatically
    # submitted (thanks to the onload handler), but testbrowser doesn't support
    # JS, so we have to submit the form manually.
    >>> print browser.contents
    <html>...<body onload="document.forms[0].submit();"...
    >>> browser.getControl('Continue').click()

The OpenID Provider will ask us to authenticate.

    >>> print browser.title
    Login
    >>> from canonical.launchpad.webapp.tests.test_login import (
    ...     fill_login_form_and_submit)
    >>> fill_login_form_and_submit(browser, 'test@canonical.com', 'test')

Once authenticated, we're redirected back to the page where we started, with
the query args preserved.

    >>> url = browser.url
    >>> print url
    http://launchpad.dev:8085/people?...
    >>> import re
    >>> print sorted(re.sub('.*\?', '', url).split('&'))
    ['name=foo', 'searchfor=all']

If we load the +login page while already logged in, it will say we're already
logged in and ask us to log out if we're somebody else.

    >>> browser.open('http://launchpad.dev:8085/+login')
    >>> print extract_text(find_main_content(browser.contents))
    You are already logged in...
