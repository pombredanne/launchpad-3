LoginToken Corner Cases
=======================

Once a LoginToken is consumed, it cannot be used again. Since the
LoginToken is used mainly for workflow purposes, we have to guard
against multiple corner cases, for example where the user posts the
form again.


Double Post on the NewAccountView
---------------------------------

Using the +validateemail view on a token that was already consumed should
redirect to the default token view. This would happen if for example the
user tried to re-post the form after validating one of their email addresses.

    >>> from canonical.launchpad.browser.logintoken import ValidateEmailView
    >>> from canonical.launchpad.interfaces.authtoken import LoginTokenType
    >>> from canonical.launchpad.interfaces.logintoken import ILoginTokenSet
    >>> from canonical.launchpad.webapp.servers import LaunchpadTestRequest
    >>> from lp.registry.interfaces.person import IPersonSet

    >>> foo_bar = getUtility(IPersonSet).getByName('name16')
    >>> token = getUtility(ILoginTokenSet).new(
    ...     requester=foo_bar, requesteremail='foo.bar@canonical.com',
    ...     email='foo@barino.com', tokentype=LoginTokenType.VALIDATEEMAIL)
    >>> token.consume()
    >>> form = {'field.actions.continue': 'Continue'}
    >>> view = ValidateEmailView(
    ...     token, LaunchpadTestRequest(form=form, method='POST'))
    >>> view.initialize()

    >>> response = view.request.response
    >>> response.getStatus()
    302
    >>> response.getHeader('Location')
    'http://launchpad.dev/token/...'

