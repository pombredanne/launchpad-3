= MO file format exporter =

MO files are binary files compiled from human readable PO files by an
external program, usually msgfmt(1).  One mnemonic to help you remember
these is that MO files are machine friendly and PO files are people
friendly.

You can read more about MO file format on:

http://www.gnu.org/software/gettext/manual/html_chapter/gettext_10.html#MO-Files

    >>> from zope.interface.verify import verifyObject
    >>> from canonical.launchpad.helpers import string_to_tarfile
    >>> from canonical.launchpad.interfaces import ITranslationFormatExporter
    >>> from canonical.launchpad.translationformat.gettext_mo_exporter import (
    ...     GettextMOExporter)
    >>> from canonical.launchpad.translationformat.gettext_po_parser import (
    ...     POParser)
    >>> from canonical.launchpad.translationformat.tests.helpers import (
    ...     is_valid_mofile)

== Interface implementation ==

    >>> verifyObject(ITranslationFormatExporter, GettextMOExporter())
    True

== exportTranslationFiles() ==

With exportTranslationFiles method, we can get a compiled .po file from a
TranslationFileData.

To get a TranslationFileData, we use the GettextPOImporter class.

    >>> parser = POParser()
    >>> file_content = '''
    ...     msgid ""
    ...     msgstr ""
    ...     "POT-Creation-Date: 2005-08-10 11:00:00+0000\\n"
    ...     "PO-Revision-Date: 2005-08-11 12:00:00+0000\\n"
    ...     "Last-Translator: Carlos <carlos@canonical.com>\\n"
    ...     "MIME-Version: 1.0\\n"
    ...     "Content-Type: text/plain; charset=UTF-8\\n"
    ...     "Content-Transfer-Encoding: 8bit\\n"
    ...
    ...     msgid "foo"
    ...     msgstr "bar"
    ...     '''
    >>> translation_file_es = parser.parse(file_content)
    >>> translation_file_es.path = 'foo/es.po'
    >>> translation_file_es.language_code = 'es'
    >>> translation_file_es.translation_domain = 'foo'

When we export a single file, we get a .mo file as output.

    >>> exporter = GettextMOExporter()
    >>> exported_file = exporter.exportTranslationFiles([translation_file_es])
    >>> print exported_file.content_type
    application/x-gmo
    >>> is_valid_mofile(exported_file.read())
    True

When we export more than one file, we get a tarball.

    >>> translation_file_sr = parser.parse(file_content)
    >>> translation_file_sr.path = 'foo/sr.po'
    >>> translation_file_sr.language_code = 'sr'
    >>> translation_file_sr.translation_domain = 'foo'
    >>> exported_file = exporter.exportTranslationFiles(
    ...     [translation_file_es, translation_file_sr])
    >>> print exported_file.content_type
    application/x-gtar
    >>> file_content = exported_file.read()
    >>> is_valid_mofile(file_content)
    False
    >>> tarfile = string_to_tarfile(file_content)
    >>> for member in tarfile.getmembers():
    ...     if member.isreg():
    ...         lines = len(tarfile.extractfile(member).readlines())
    ...     else:
    ...         lines = 0
    ...     print "| %5d | %s" % (lines, member.name)
    |     0 | es/
    |     0 | es/LC_MESSAGES/
    |    12 | es/LC_MESSAGES/foo.mo
    |     0 | sr/
    |     0 | sr/LC_MESSAGES/
    |    12 | sr/LC_MESSAGES/foo.mo


== PO compiler helper class ==

Launchpad gets .po file content and 'compiles' it to get
the binary form.

    >>> from canonical.launchpad.translationformat.gettext_mo_exporter import (
    ...     POCompiler)
    >>> compiler = POCompiler()


POCompiler.compile gets a string with .po file content and gives you
a .mo file binary stream.

    >>> mofile_content = compiler.compile('''
    ... msgid "foo"
    ... msgstr "bar"
    ... ''')
    >>> is_valid_mofile(mofile_content)
    True

Though, if we provide it with something that is not a .po file content, we
get an export error exception:

    >>> mofile = compiler.compile('''
    ... blah
    ... ''')
    Traceback (most recent call last):
    ...
    UnknownTranslationExporterError: ...
