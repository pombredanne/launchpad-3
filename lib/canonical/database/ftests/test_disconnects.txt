This test demonstrates the normal behaviour of psycopg when a connection to
postgres breaks (i.e. queries fail).  This can happen in real life when postgres
restarts.

Make a TCP proxy to postgres. Note that the twisted version needs to match
the Python version.

    >>> import os
    >>> from canonical.ftests.pgsql import PgTestSetup
    >>> from canonical.database.ftests import PortForwardTestSetup
    >>> portforward = PortForwardTestSetup()
    >>> portforward.setUp()
    
Connect to postgres via the proxy

    >>> import psycopg
    >>> dbname = PgTestSetup().dbname
    >>> dsn = 'dbname=%s host=localhost port=5555' % (dbname)
    >>> conn = psycopg.connect(dsn)

Check that the connection is working normally

    >>> cur = conn.cursor()
    >>> cur.execute("SELECT 1;")
    >>> cur.fetchone()[0]
    1

Break the connection by stopping the proxy 

    >>> portforward.tearDown()

And restart it.

    >>> portforward.setUp()

Now using our connection should fail

    >>> cur.execute("SELECT 1;")
    Traceback (most recent call last):
    ...
    ProgrammingError: server closed the connection unexpectedly
        This probably means the server terminated abnormally
        before or while processing the request.
    <BLANKLINE>
    SELECT 1;

And keep failing.
    
    >>> cur.fetchone()
    Traceback (most recent call last):
    ...
    Error: no results to fetch

Close our connection

    >>> conn.close()

Clean up the proxy.

    >>> portforward.tearDown()


