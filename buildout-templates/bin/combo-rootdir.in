#!/bin/sh

set -e

BUILD_DIR=$1

# Populate YUI.
mkdir $BUILD_DIR/yui
tar zxf download-cache/dist/yui-${versions:yui}.tar.gz -C $BUILD_DIR/yui

# And YUI 2, for now.
cp -a lib/canonical/launchpad/icing/yui_2.7.0b/build $BUILD_DIR/yui2

# Copy in our modules.
mkdir $BUILD_DIR/lp
for jsdir in lib/lp/*/javascript ; do
    app=$(echo $jsdir | sed -e 's,lib/lp/\(.*\)/javascript,\1,')
    cp -a $jsdir $BUILD_DIR/lp/$app
done
# ... and delete tests.
find $BUILD_DIR -name 'tests' -type d | xargs rm -rf

# We have to move some modules around.
cp lib/lp/contrib/javascript/lp.mustache.js $BUILD_DIR/lp
rm $BUILD_DIR/lp/contrib/mustache.js
rm $BUILD_DIR/lp/app/worlddata
cp lib/lp/services/worlddata/javascript/languages.js $BUILD_DIR/lp
cp lib/lp/app/longpoll/javascript/longpoll.js $BUILD_DIR/lp

# Build the LP module definition file.
utilities/js-deps -n LP_MODULES -s $BUILD_DIR/lp -o $BUILD_DIR/lp/meta.js >/dev/null

# Minify our JS.
bin/py -m lp.scripts.utilities.js.jsmin_all $BUILD_DIR/lp

# Check if any JS modules are missing.
error=0
for mod in $(grep '  LP' $BUILD_DIR/lp/meta.js | tr -s ' ' | cut -d\  -f2) ; do
    if ! grep -q "modules\[$mod\]" $BUILD_DIR/lp/meta.js ; then
        echo "ERROR: $mod is not mentioned in the meta file"
        error=1
    fi
done

exit $error
